import{d as ue,H as ce,I as de,b as v,M as me,A as F,Q as he,f as ge,X as fe,B as pe,g as ye,o as N,w as ve,a as c,j as V,t as H,m as we,u as J,c as K,i as be,S as ke,V as U}from"./admin-D2xJDODg.js";import{C as _e}from"./component-8nevARhv.js";import{u as j,w as xe}from"./xlsx-3SA47z_C.js";import{_ as De}from"./AdminLayout.vue_vue_type_script_setup_true_lang-D1rWG96s.js";import{_ as Ce}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-Bw8ye24P.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Se={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Re={class:"mb-6 flex items-center justify-between"},Te={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Fe={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ne={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},Ie={class:"relative"},Ae={class:"relative",style:{width:"100%",height:"450px"}},Pe={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Ke={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},Me={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Be={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Ee={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},ze={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},$e={class:"text-gray-500 dark:text-gray-500 text-sm"},qe=ue({__name:"Keuangan",setup(Ve){const q=ce();de();const X=v(String(q.meta.title||"Keuangan")),I=v(null),C=v(null),O=v(null),M=me(),{fetchUser:Y,hasPermission:B,isAdmin:E}=he();F(()=>E()||B("create keuangan")),F(()=>E()||B("update keuangan")),F(()=>E()||B("delete keuangan"));const z=v(!1),A=v(null),Q={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},S=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:g},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:g},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:g},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:g},{headerName:"Program",field:"program",valueFormatter:g},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:g},{headerName:"Bonus",field:"bonus",valueFormatter:g},{headerName:"Championship",field:"championship",valueFormatter:g}]}],$={resizable:!0,sortable:!0,filter:!1};$.minWidth=120,$.cellClass="text-sm";function g(a){return a&&a.value!==void 0&&a.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a.value):""}function Z(a){switch((a||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(a)}}const b=v([]),p=v((()=>{const a=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],o=[],s=new Date("2024-01-01");for(let r=1;r<=200;r++){const u=(r-1)%a.length,f=(r-1)%t.length,m=new Date(s);m.setDate(m.getDate()+(r-1)*2);const d=Math.floor(Math.random()*75e6)+25e6;o.push({id:r.toString(),pic:a[u],jumlah:d,kantorCabang:t[f],tanggalKeuangan:m.toISOString().split("T")[0]})}return o})()),w=v(""),G=F(()=>p.value),ee=F(()=>G.value.length===0),ae=()=>{A.value&&(p.value=p.value.filter(a=>a.id!==A.value),M.success("Data keuangan berhasil dihapus"),z.value=!1,A.value=null,R())},te=()=>{z.value=!1,A.value=null},re=()=>{const a=[],t=[],o=[],s=[];let r=0;S.forEach(e=>{if(e.field){const n=e.headerName||e.field;t.push(n),o.push(""),s.push({s:{r:0,c:r},e:{r:1,c:r}}),a.push(e.field),r+=1}else if(e.children&&Array.isArray(e.children)){const n=e.headerName||"",i=e.children.length;for(let l=0;l<i;l++)t.push(l===0?n:"");s.push({s:{r:0,c:r},e:{r:0,c:r+i-1}}),e.children.forEach(l=>{o.push(l.headerName||l.field),a.push(l.field),r+=1})}});const u=[];u.push(t),u.push(o),p.value.forEach(e=>{const n=[];a.forEach(i=>{const l=e[i];n.push(typeof l=="number"?l:l??"")}),u.push(n)}),b.value&&b.value.length&&b.value.forEach(e=>{const n=[];a.forEach(i=>{const l=e[i];n.push(typeof l=="number"?l:l??"")}),u.push(n)});const f=j.aoa_to_sheet(u);f["!merges"]=f["!merges"]||[],s.forEach(e=>f["!merges"].push(e));const m=j.book_new();j.book_append_sheet(m,f,"Keuangan");const h=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;xe(m,h)},ne=(a,t)=>{if(!t||t.length===0)return a;const o=[...a];return t.forEach(s=>{const{colId:r,sort:u}=s;o.sort((f,m)=>{let d=f[r],h=m[r];return r==="tanggalKeuangan"?(d=new Date(d).getTime(),h=new Date(h).getTime()):r==="jumlah"?(d=d||0,h=h||0):typeof d=="string"&&(d=d.toLowerCase(),h=h.toLowerCase()),d<h?u==="asc"?-1:1:d>h?u==="asc"?1:-1:0})}),o},P=v({getRows:a=>{setTimeout(()=>{const t=a.startRow||0,o=a.endRow||0;let s=G.value;a.sortModel&&a.sortModel.length>0&&(s=ne(s,a.sortModel));const r=s.slice(t,o);let u;s.length===0?u=0:s.length<=o?u=s.length:u=void 0,a.successCallback(r,u)},50)}}),L=async()=>{var a,t;try{let o="/admin/api/keuangan/program-shares-summary";try{const e=w.value;let n=null,i=null;if(e){if(Array.isArray(e))n=e[0]?e[0]instanceof Date?e[0].toISOString().split("T")[0]:String(e[0]):null,i=e[1]?e[1]instanceof Date?e[1].toISOString().split("T")[0]:String(e[1]):null;else if(typeof e=="string"){const _=e.includes(" to ")?" to ":e.includes(" - ")?" - ":"";if(_){const x=e.split(_);n=((a=x[0])==null?void 0:a.trim())||null,i=((t=x[1])==null?void 0:t.trim())||null}else n=e||null,i=e||null}}const l={};n&&(l.start_date=n),i&&(l.end_date=i);const k=new URLSearchParams(l).toString();k&&(o+=`?${k}`)}catch{}const r=await(await fetch(o,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){M.error("Gagal memuat ringkasan program");return}const u=r.data.rows||[],f=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],m=[];m.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),m.push({headerName:"Nominal Transaksi",field:"nominal",pinned:"left",width:160,valueFormatter:g,resizable:!0}),u.forEach(e=>{const n=[];n.push({headerName:"Nominal Transaksi",field:`p_${e.program_id||e.id}_nominal`,valueFormatter:g,resizable:!0,width:160});const i=f.map(k=>{let _="";try{const x=e.shares_meta||{},y=x[k]||x[k.toString()]||null;if(y)if(y.type==="percentage"&&y.value!==null&&y.value!==void 0){const D=Number(y.value);Number.isFinite(D)?_=Number.isInteger(D)?` (${D}%)`:` (${D%1===0?D:parseFloat(D.toFixed(2))}%)`:_=` (${y.value}%)`}else y.type==="nominal"&&y.value!==null&&y.value!==void 0&&(_=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(y.value)})`)}catch{}return{headerName:`${Z(k)}${_}`,field:`p_${e.program_id||e.id}_${k}`,valueFormatter:g,resizable:!0,minWidth:120}});n.push(...i);const l=`${e.program_name||e.nama_program||e.nama||"Program"}`;m.push({headerName:l,children:n})}),S.splice(0,S.length,...m),U(()=>{var n;const e=C.value||((n=I.value)==null?void 0:n.api);if(e)try{e.setColumnDefs(S);try{e.setDatasource&&P.value?e.setDatasource(P.value):e.setRowData(p.value)}catch{try{e.setRowData(p.value)}catch{}}e.setPinnedBottomRowData(b.value);try{e.sizeColumnsToFit()}catch{}setTimeout(()=>{try{W()}catch{}},80)}catch(i){console.error("Failed to apply dynamic columns to grid",i)}});const d={summary_label:"TOTAL"},h=u.reduce((e,n)=>e+(n.total_transaksi||0),0);u.forEach(e=>{const n=`p_${e.program_id||e.id}_nominal`;d[n]=e.total_transaksi||0,f.forEach(i=>{const l=`p_${e.program_id||e.id}_${i}`;d[l]=e[i]||0})}),d.nominal=h,p.value=[d],b.value=[],R(!0)}catch(o){console.error(o),M.error("Terjadi kesalahan saat memuat ringkasan program")}},R=(a=!1)=>{U(()=>{var o;const t=C.value||((o=I.value)==null?void 0:o.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&P.value?t.setDatasource(P.value):t.setRowData(p.value)}catch{}t.setPinnedBottomRowData(b.value),a&&window.setTimeout(()=>{var r;const s=C.value||((r=I.value)==null?void 0:r.api);if(s)try{s.ensureIndexVisible(0,"top")}catch{}},100)}catch(s){console.error("Error refreshing grid:",s)}})};ge(async()=>{await Y(),await L(),R()});function oe(a){C.value=a.api,O.value=a.columnApi;try{a.api.setRowData&&a.api.setRowData(p.value)}catch{}}function W(){var s;const a=O.value;if(!a)return;const t=a.getAllColumns();if(!t||!t.length)return;const o=t.map(r=>r.getColId());try{a.autoSizeColumns(o,!1)}catch{try{(s=C.value)==null||s.sizeColumnsToFit()}catch{}}}function se(a){try{a.api.sizeColumnsToFit()}catch{}W()}fe(()=>{T&&clearTimeout(T)});const le=()=>{R()};let T=null;pe([w],()=>{T&&clearTimeout(T),T=setTimeout(async()=>{try{await L()}catch{}R(!0)},300)});const ie=()=>{w.value=""};return(a,t)=>(N(),ye(De,null,{default:ve(()=>[c("div",Se,[c("div",Re,[c("h3",Te,H(X.value),1),c("div",{class:"flex items-center gap-3"},[c("button",{onClick:re,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[c("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[c("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),we(" Export Excel ",-1)])])])]),c("div",Fe,[c("div",Ne,[c("div",null,[t[2]||(t[2]=c("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),c("div",Ie,[V(J(_e),{modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=o=>w.value=o),config:Q,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),c("div",{class:"mt-4"},[c("button",{onClick:ie,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),c("div",Ae,[c("div",Pe,[V(J(ke),{ref_key:"agGridRef",ref:I,onGridReady:oe,onFirstDataRendered:se,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:S,defaultColDef:$,pinnedBottomRowData:b.value,rowData:p.value,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:le},null,8,["pinnedBottomRowData","rowData"])]),ee.value?(N(),K("div",Ke,[(N(),K("svg",Me,[a.filterPIC||a.filterKantorCabang||w.value||a.filterJumlahMin||a.filterJumlahMax?(N(),K("path",Be)):(N(),K("path",Ee))])),c("p",ze,H(w.value?"Tidak ada data ditemukan":"Tidak ada data"),1),c("p",$e,H(w.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):be("",!0)])]),V(Ce,{isOpen:z.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ae,onCancel:te},null,8,["isOpen"])]),_:1}))}});export{qe as default};
