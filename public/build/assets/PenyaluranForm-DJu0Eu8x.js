import{d as z,H as W,I as J,A as j,b as p,e as Q,M as Y,f as Z,B as aa,g as U,o as h,w as ea,a as r,t as x,q as ra,m as g,k as l,v as i,j as ta,u as b,c as _,F as V,i as na,l as sa}from"./admin-CkEfjX4T.js";import{_ as oa}from"./AdminLayout.vue_vue_type_script_setup_true_lang-Dg6CsSgv.js";import{S as R}from"./SearchableSelect-qq7Nd590.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const da={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},la={class:"mb-6 flex items-center justify-between"},ia={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ua={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},pa={class:"lg:col-span-1"},ca={class:"relative"},ga={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},ma={class:"lg:col-span-1"},ba={class:"lg:col-span-1"},ya={class:"mt-2 text-sm text-gray-600"},ka={class:"font-medium"},ha={class:"font-medium"},xa={class:"lg:col-span-1"},fa={class:"lg:col-span-1"},va={class:"lg:col-span-1"},wa={class:"lg:col-span-1"},ja={class:"lg:col-span-1"},_a={class:"lg:col-span-1"},Ia={class:"lg:col-span-2"},Ma={class:"lg:col-span-2"},Ta={class:"lg:col-span-1"},Ca=["value"],Pa={class:"lg:col-span-2"},Fa={class:"space-y-4"},Sa={class:"relative"},Ua={key:0,class:"grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4"},Va={class:"aspect-square overflow-hidden rounded-lg border-2 border-gray-200 bg-gray-50 dark:border-gray-700 dark:bg-gray-900/50"},Ra=["src","alt"],Ka={class:"mt-2"},Ba={class:"truncate text-xs font-medium text-gray-700 dark:text-gray-300"},qa={class:"text-xs text-gray-500 dark:text-gray-400"},Na=["onClick"],Xa=z({__name:"PenyaluranForm",setup(Da){const y=W(),I=J(),f=j(()=>y.params.id!==void 0&&y.params.id!=="new"),K=j(()=>f.value?"Edit Penyaluran":"Buat Penyaluran"),T=p([]),B=async()=>{try{const n=await fetch("/admin/api/kantor-cabang?per_page=1000",{credentials:"same-origin"});if(!n.ok)return;const a=await n.json(),o=a.success&&a.data?Array.isArray(a.data)?a.data:a.data.data||[]:[];T.value=o.map(s=>({value:s.id,label:s.nama}))}catch(n){console.error("Failed to fetch kantor cabang options",n)}},q=async()=>{try{const a=await(await fetch("/admin/api/program-share-types/submission-types",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();a.success&&Array.isArray(a.data)?(c.value=a.data.map(o=>({value:o.value,label:o.value})),!e.submissionType&&c.value.length>0&&(e.submissionType=c.value[0].value)):(c.value=[{value:"Program",label:"Program"},{value:"Operasional",label:"Operasional"},{value:"Gaji Karyawan",label:"Gaji Karyawan"}],e.submissionType||(e.submissionType="Program"))}catch(n){console.error("Error fetching submission types",n),c.value=[{value:"Program",label:"Program"},{value:"Operasional",label:"Operasional"},{value:"Gaji Karyawan",label:"Gaji Karyawan"}],e.submissionType||(e.submissionType="Program")}};p("");const C=p(""),P=p(""),c=p([]),k=p(null),N=async()=>{var n,a,o;try{const s=await fetch("/admin/api/user",{credentials:"same-origin"});if(s.ok){const d=await s.json();d.success&&d.user&&(k.value=d.user,(a=(n=k.value)==null?void 0:n.kantor_cabang)!=null&&a.id&&(e.branchId=String(k.value.kantor_cabang.id)),(o=k.value)!=null&&o.is_admin&&await B())}}catch(s){console.error("Failed to fetch current user",s)}},M=p(null),v=p([]),e=Q({amount:null,program:"",submissionType:"",pic:"",village:"",district:"",city:"",province:"",postalCode:"",address:"",report:"",branchId:"",pengajuanId:""}),w=p(0),D=j(()=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(w.value||0)),E=j(()=>{const n=Number(e.amount||0);return new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n)}),F=async n=>{try{if(!n){w.value=0;return}const o=await(await fetch(`/admin/api/penyaluran/my-credit?type=${encodeURIComponent(n)}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();o&&o.success&&o.data&&typeof o.data.remaining<"u"?w.value=Number(o.data.remaining)||0:w.value=0}catch(a){console.error("Failed to load credit total for type",n,a),w.value=0}},A=n=>{const a=n.target;if(a.files){const o=Array.from(a.files),s=20*1024*1024,d=[],t=[];o.forEach(u=>{u.size>s?t.push(u.name):d.push(u)}),t.length>0&&alert(`File berikut melebihi 20MB: ${t.join(", ")}`),v.value.push(...d),M.value&&(M.value.value="")}},L=n=>{v.value.splice(n,1)},G=n=>URL.createObjectURL(n),X=n=>{if(n===0)return"0 Bytes";const a=1024,o=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(n)/Math.log(a));return Math.round(n/Math.pow(a,s)*100)/100+" "+o[s]},O=async()=>{var n,a;if(f.value&&y.params.id){const o=y.params.id;try{const s=await fetch(`/admin/api/penyaluran/${o}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}});if(!s.ok)throw new Error("Failed to fetch penyaluran");const d=await s.json();if(!d.success||!d.data){console.error("Penyaluran tidak ditemukan");return}const t=d.data;e.amount=t.amount!=null?Number(t.amount):e.amount,e.program=t.program_name||t.pengajuan&&(((n=t.pengajuan.program)==null?void 0:n.nama_program)||((a=t.pengajuan.program)==null?void 0:a.nama))||e.program,e.pic=t.pic||(t.pengajuan&&t.pengajuan.fundraiser?t.pengajuan.fundraiser.name:e.pic),e.village=t.village||t.kelurahan||e.village,e.district=t.district||t.kecamatan||e.district,e.city=t.city||t.kota||e.city,e.province=t.province||e.province,e.postalCode=t.postal_code||e.postalCode,e.address=t.address||e.address,e.report=t.report||e.report,e.branchId=t.kantor_cabang_id||t.kantor_cabang&&t.kantor_cabang.id||e.branchId,e.pengajuanId=t.pengajuan_dana_id||e.pengajuanId}catch(s){console.error("Error loading penyaluran",s)}}},S=()=>{I.push("/keuangan/penyaluran")},m=Y(),$=async()=>{var n;if(!e.amount){m.error("Nominal wajib diisi");return}if(!e.program){m.error("Program wajib diisi");return}if(!e.pic){m.error("PIC wajib diisi");return}if(!e.branchId){m.error("Kantor Cabang wajib diisi");return}try{const a=new FormData;a.append("amount",String(e.amount||"0")),e.pengajuanId&&a.append("pengajuan_dana_id",String(e.pengajuanId)),e.submissionType&&a.append("submission_type",String(e.submissionType)),a.append("program_name",e.program||""),a.append("pic",e.pic||""),a.append("village",e.village||""),a.append("district",e.district||""),a.append("city",e.city||""),a.append("province",e.province||""),a.append("postal_code",e.postalCode||""),a.append("address",e.address||""),a.append("report",e.report||""),a.append("kantor_cabang_id",e.branchId||""),v.value.forEach(u=>{a.append("images[]",u)});const o=((n=document.querySelector('meta[name="csrf-token"]'))==null?void 0:n.getAttribute("content"))||"",s=f.value?`/admin/api/penyaluran/${y.params.id}`:"/admin/api/penyaluran";f.value&&a.append("_method","PUT");const t=await(await fetch(s,{method:"POST",body:a,credentials:"same-origin",headers:{"X-CSRF-TOKEN":o}})).json();if(!t.success)m.error(t.message||"Gagal menyimpan penyaluran");else{m.success(f.value?"Penyaluran berhasil diupdate":"Penyaluran berhasil dibuat");try{await I.push("/keuangan/penyaluran"),window.dispatchEvent(new CustomEvent("penyaluran:changed"));return}catch{I.push("/keuangan/penyaluran");try{window.dispatchEvent(new CustomEvent("penyaluran:changed"))}catch{}}}}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}};return Z(async()=>{await q(),await N();const n=y.query.pengajuan_id;if(n)try{const o=await(await fetch(`/admin/api/pengajuan-dana/${n}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(o.success&&o.data){const s=o.data;e.pengajuanId=String(n),e.submissionType=s.submission_type||e.submissionType,s.submission_type&&!c.value.find(d=>d.value===s.submission_type)&&c.value.unshift({value:s.submission_type,label:s.submission_type}),e.program=s.program&&(s.program.nama||s.program.nama_program)||e.program,e.pic=s.fundraiser?s.fundraiser.name:e.pic,e.amount=typeof s.amount<"u"&&s.amount!==null?Number(s.amount):e.amount,e.report=s.purpose||e.report}}catch(a){console.error("Failed to load pengajuan",a)}O(),F(e.submissionType)}),aa(()=>e.submissionType,n=>{F(String(n||""))}),(n,a)=>(h(),U(oa,null,{default:ea(()=>{var o,s,d;return[r("div",da,[r("div",la,[r("h3",ia,x(K.value),1),r("button",{onClick:S,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Kembali ")]),r("form",{onSubmit:ra($,["prevent"]),class:"flex flex-col"},[r("div",ua,[r("div",pa,[a[15]||(a[15]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[g(" Nominal "),r("span",{class:"text-red-500"},"*")],-1)),r("div",ca,[l(r("input",{type:"number","onUpdate:modelValue":a[0]||(a[0]=t=>e.amount=t),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.amount,void 0,{number:!0}]]),r("span",ga,x(E.value),1)])]),r("div",ma,[a[16]||(a[16]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[g(" Nama Penyaluran "),r("span",{class:"text-red-500"},"*")],-1)),l(r("input",{type:"text","onUpdate:modelValue":a[1]||(a[1]=t=>e.program=t),placeholder:"Masukkan nama program atau tahapannya",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.program]])]),r("div",ba,[a[19]||(a[19]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[g("Tipe Penyaluran "),r("span",{class:"text-red-500"},"*")],-1)),ta(R,{modelValue:e.submissionType,"onUpdate:modelValue":a[2]||(a[2]=t=>e.submissionType=t),options:b(c),placeholder:"Pilih tipe penyaluran","search-input":b(P),"onUpdate:searchInput":a[3]||(a[3]=t=>P.value=t)},null,8,["modelValue","options","search-input"]),r("p",ya,[a[17]||(a[17]=g("Sisa kredit untuk ",-1)),r("span",ka,x(e.submissionType),1),a[18]||(a[18]=g(": ",-1)),r("span",ha,x(D.value),1)])]),r("div",xa,[a[20]||(a[20]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[g(" PIC "),r("span",{class:"text-red-500"},"*")],-1)),l(r("input",{type:"text","onUpdate:modelValue":a[4]||(a[4]=t=>e.pic=t),placeholder:"Masukkan penanggung jawab penyaluran",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.pic]])]),r("div",fa,[a[21]||(a[21]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kelurahan ",-1)),l(r("input",{type:"text","onUpdate:modelValue":a[5]||(a[5]=t=>e.village=t),placeholder:"Masukkan kelurahan",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.village]])]),r("div",va,[a[22]||(a[22]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kecamatan ",-1)),l(r("input",{type:"text","onUpdate:modelValue":a[6]||(a[6]=t=>e.district=t),placeholder:"Masukkan kecamatan",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.district]])]),r("div",wa,[a[23]||(a[23]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kota ",-1)),l(r("input",{type:"text","onUpdate:modelValue":a[7]||(a[7]=t=>e.city=t),placeholder:"Masukkan kota",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.city]])]),r("div",ja,[a[24]||(a[24]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Provinsi ",-1)),l(r("input",{type:"text","onUpdate:modelValue":a[8]||(a[8]=t=>e.province=t),placeholder:"Masukkan provinsi",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.province]])]),r("div",_a,[a[25]||(a[25]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kode Pos ",-1)),l(r("input",{type:"text","onUpdate:modelValue":a[9]||(a[9]=t=>e.postalCode=t),placeholder:"Masukkan kode pos",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.postalCode]])]),r("div",Ia,[a[26]||(a[26]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Alamat ",-1)),l(r("textarea",{"onUpdate:modelValue":a[10]||(a[10]=t=>e.address=t),placeholder:"Masukkan detail alamat lengkap",rows:"3",class:"dark:bg-dark-900 h-auto w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.address]])]),r("div",Ma,[a[27]||(a[27]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Laporan ",-1)),l(r("textarea",{"onUpdate:modelValue":a[11]||(a[11]=t=>e.report=t),placeholder:"Masukkan catatan laporan hasil penyaluran",rows:"4",class:"dark:bg-dark-900 h-auto w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[i,e.report]])]),r("div",Ta,[a[28]||(a[28]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[g(" Kantor Cabang "),r("span",{class:"text-red-500"},"*")],-1)),(o=b(k))!=null&&o.is_admin?(h(),U(R,{key:0,modelValue:e.branchId,"onUpdate:modelValue":a[12]||(a[12]=t=>e.branchId=t),options:T.value,placeholder:"Pilih atau cari kantor cabang","search-input":b(C),"onUpdate:searchInput":a[13]||(a[13]=t=>C.value=t)},null,8,["modelValue","options","search-input"])):(h(),_(V,{key:1},[r("input",{type:"text",value:((d=(s=b(k))==null?void 0:s.kantor_cabang)==null?void 0:d.nama)||"",placeholder:"Kantor cabang Anda",readonly:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:outline-none dark:border-gray-700 dark:bg-gray-900/50 dark:text-white/90"},null,8,Ca),l(r("input",{type:"hidden","onUpdate:modelValue":a[14]||(a[14]=t=>e.branchId=t)},null,512),[[i,e.branchId]])],64))]),r("div",Pa,[a[31]||(a[31]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Gambar Dokumentasi ",-1)),r("div",Fa,[r("div",Sa,[r("input",{type:"file",ref_key:"fileInputRef",ref:M,onChange:A,multiple:"",accept:"image/*",class:"hidden",id:"image-upload"},null,544),a[29]||(a[29]=r("label",{for:"image-upload",class:"flex cursor-pointer items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 px-6 py-8 text-center transition-colors hover:border-brand-300 hover:bg-gray-100 dark:border-gray-700 dark:bg-gray-900/50 dark:hover:border-brand-500"},[r("div",{class:"text-center"},[r("svg",{class:"mx-auto h-12 w-12 text-gray-400 dark:text-gray-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"})]),r("p",{class:"mt-2 text-sm text-gray-600 dark:text-gray-400"},[r("span",{class:"font-medium text-brand-500"},"Klik untuk upload"),g(" atau drag and drop ")]),r("p",{class:"text-xs text-gray-500 dark:text-gray-500"}," PNG, JPG, GIF hingga 20MB (Multiple files) ")])],-1))]),b(v).length>0?(h(),_("div",Ua,[(h(!0),_(V,null,sa(b(v),(t,u)=>(h(),_("div",{key:u,class:"relative group"},[r("div",Va,[r("img",{src:G(t),alt:t.name,class:"h-full w-full object-cover"},null,8,Ra)]),r("div",Ka,[r("p",Ba,x(t.name),1),r("p",qa,x(X(t.size)),1)]),r("button",{type:"button",onClick:H=>L(u),class:"absolute -right-2 -top-2 flex h-7 w-7 items-center justify-center rounded-full bg-red-500 text-white shadow-lg transition-transform hover:scale-110 hover:bg-red-600",title:"Hapus gambar"},[...a[30]||(a[30]=[r("svg",{class:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[r("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M6 18L18 6M6 6l12 12"})],-1)])],8,Na)]))),128))])):na("",!0)])])]),r("div",{class:"flex items-center gap-3 mt-6 lg:justify-end"},[r("button",{onClick:S,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"}," Kembali "),a[32]||(a[32]=r("button",{type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"}," Buat ",-1))])],32)])]}),_:1}))}});export{Xa as default};
