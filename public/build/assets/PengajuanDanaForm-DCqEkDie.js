import{d as Q,H as Z,I as aa,L as ea,A as x,b as u,e as ta,B as ra,f as na,g as sa,o as _,w as oa,a as t,t as m,q as la,c as D,i as R,j as c,m as b,k as U,v as A,u as ia,P as da}from"./admin-DjfuJrmy.js";import{C as ua}from"./component-Cr9oD0f_.js";import{_ as ma,g as ga}from"./AdminLayout.vue_vue_type_script_setup_true_lang-Be_U2TSy.js";import{S as v}from"./SearchableSelect-B95bKtPQ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pa={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ca={class:"mb-6 flex items-center justify-between"},ba={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},fa={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ya={class:"lg:col-span-1"},xa={class:"lg:col-span-1"},va={key:0,class:"lg:col-span-1"},ha={key:0,class:"mt-2 text-sm text-gray-500"},ka={key:1,class:"w-full col-span-full mt-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-900/40"},wa={class:"flex items-center justify-between"},ja={class:"text-xs text-gray-500"},Sa={class:"text-lg font-medium"},Ia={class:"text-right text-xs text-gray-500"},_a={class:"lg:col-span-1"},Ta={class:"lg:col-span-1"},Da={class:"relative"},Pa={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},Va={class:"lg:col-span-1"},Fa={class:"relative"},Ca={class:"lg:col-span-2"},Na={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},Ma={class:"lg:col-span-2"},Ra={class:"flex items-center gap-3 mt-6 lg:justify-end"},Ua={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Oa=Q({__name:"PengajuanDanaForm",setup(Aa){const h=Z(),P=aa(),i=ea(),{fetchUser:E}=da(),g=x(()=>h.params.id!==void 0&&h.params.id!=="new"),q=x(()=>g.value?"Edit Pengajuan Dana":"Tambah Pengajuan Dana"),L={dateFormat:"Y-m-d",altInput:!0,altFormat:"d F Y",locale:"id",wrap:!0,clickOpens:!0,allowInput:!1,minDate:"today"},f=u([]),B=[{value:"operasional",label:"Operasional"},{value:"program",label:"Program"},{value:"kegiatan",label:"Kegiatan"},{value:"pengembangan",label:"Pengembangan"},{value:"darurat",label:"Darurat"},{value:"lainnya",label:"Lainnya"}],k=u([]),w=u([]),V=u(""),F=u(""),C=u(""),y=u(""),a=ta({applicant:"",submissionType:"",status:"Draft",programId:"",amount:null,usedAt:"",purpose:"",branchId:""}),X=x(()=>!a.amount||a.amount<=0?"":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(a.amount)),d=u(null),j=u([]),S=u(!1);let T=null;const I=s=>!s||s<=0?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),O=s=>{if(!s)return"";try{const e=String(s).split("-");if(e.length<2)return s;const r=Number(e[0]),n=Number(e[1])-1,o=new Date(Date.UTC(r,n,1));return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(o)}catch{return s}},$=async()=>{if(!a.programId||!a.usedAt){d.value=null,j.value=[];return}S.value=!0;try{const s=new Date(a.usedAt);if(isNaN(s.getTime())){d.value=null,j.value=[],S.value=!1;return}const e=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,n=await(await fetch(`/admin/api/program/${a.programId}/balance?month=${e}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load balance");if(d.value=n.data,j.value=n.data.transaksis||[],!g.value){const o=Number(n.data.remaining||0);o>0&&(!a.amount||a.amount<=0)&&(a.amount=o)}}catch(s){console.error("Error loading program balance",s),i.error("Gagal memuat saldo program"),d.value=null,j.value=[]}finally{S.value=!1}};ra([()=>a.programId,()=>a.usedAt],()=>{T&&window.clearTimeout(T),T=window.setTimeout(()=>{$()},300)});const H=s=>{const e=s.target,r=parseFloat(e.value);isNaN(r)||r<0?a.amount=null:a.amount=Math.floor(r)},K=async()=>{if(!g.value)return;const s=h.params.id;try{const r=await(await fetch(`/admin/api/pengajuan-dana/${s}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load");const n=r.data;if(a.applicant=n.fundraiser?String(n.fundraiser.id):"",a.status=n.status||"Draft",n.fundraiser&&!f.value.find(o=>o.value===String(n.fundraiser.id))&&f.value.unshift({value:String(n.fundraiser.id),label:n.fundraiser.name||n.fundraiser.nama||""}),a.submissionType=n.submission_type,a.amount=n.amount,a.usedAt=n.used_at,a.purpose=n.purpose,a.branchId=n.kantor_cabang?n.kantor_cabang.id:"",a.programId=n.program?String(n.program.id):"",n.kantor_cabang&&!k.value.find(o=>o.value===String(n.kantor_cabang.id))&&k.value.unshift({value:String(n.kantor_cabang.id),label:n.kantor_cabang.nama||""}),n.program&&!w.value.find(o=>o.value===String(n.program.id))){const o=n.program.nama_program||n.program.nama||"";w.value.unshift({value:String(n.program.id),label:o})}}catch(e){console.error("Error loading data:",e),i.error("Gagal memuat data pengajuan dana")}},W=async()=>{try{const s=await E();y.value=s!=null&&s.id?String(s.id):"";const r=await(await fetch("/admin/api/pengajuan-dana/options",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load options");const n=r.data.users||[];f.value=n.map(l=>({value:String(l.id),label:l.name}));const o=r.data.kantor_cabangs||[];k.value=o.map(l=>({value:String(l.id),label:l.nama}));const p=r.data.programs||[];w.value=p.map(l=>({value:String(l.id),label:l.nama})),y.value&&f.value.find(z=>z.value===String(y.value))&&!a.applicant&&(a.applicant=String(y.value)),g.value&&r.data&&r.data.current&&r.data.current.program&&(a.programId=String(r.data.current.program.id))}catch(s){console.error("Error loading options",s),i.error("Gagal memuat opsi form")}},N=[{value:"Draft",label:"Draft"},{value:"pending",label:"Diajukan"}],Y=x(()=>String(a.applicant)===String(y.value)),G=x(()=>(Y.value,N)),M=()=>P.push("/keuangan/pengajuan-dana"),J=async()=>{if(!a.applicant){i.error("Pengaju wajib diisi");return}if(!a.submissionType){i.error("Tipe Pengajuan wajib diisi");return}if(!a.amount||a.amount<=0){i.error("Nominal wajib diisi dan harus lebih dari 0");return}if(!a.usedAt){i.error("Tanggal Digunakan wajib diisi");return}if(!a.branchId){i.error("Kantor Cabang wajib diisi");return}try{const s={fundraiser_id:a.applicant,submission_type:a.submissionType,program_id:a.programId||null,status:a.status,amount:a.amount,used_at:a.usedAt,purpose:a.purpose,kantor_cabang_id:a.branchId},e=await ga(),r=g.value?`/admin/api/pengajuan-dana/${h.params.id}`:"/admin/api/pengajuan-dana",n=g.value?"PUT":"POST",p=await(await fetch(r,{method:n,credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":e,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s)})).json();if(!p.success){if(p.errors){const l=Object.values(p.errors)[0];i.error(l?String(l[0]):"Validation failed");return}throw new Error(p.message||"Failed to save")}i.success(g.value?"Pengajuan dana berhasil diupdate":"Pengajuan dana berhasil ditambahkan"),P.push("/keuangan/pengajuan-dana")}catch(s){console.error("Error saving:",s),i.error("Terjadi kesalahan saat menyimpan data")}};return na(async()=>{await W(),await K()}),(s,e)=>(_(),sa(ma,null,{default:oa(()=>[t("div",pa,[t("div",ca,[t("h3",ba,m(q.value),1),t("button",{onClick:M,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"},"Batal")]),t("form",{onSubmit:la(J,["prevent"]),class:"flex flex-col"},[t("div",fa,[t("div",ya,[e[11]||(e[11]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Pengaju "),t("span",{class:"text-red-500"},"*")],-1)),c(v,{modelValue:a.applicant,"onUpdate:modelValue":e[0]||(e[0]=r=>a.applicant=r),options:f.value,placeholder:"Pilih atau cari pengaju","search-input":V.value,"onUpdate:searchInput":e[1]||(e[1]=r=>V.value=r)},null,8,["modelValue","options","search-input"])]),t("div",xa,[e[12]||(e[12]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tipe Pengajuan "),t("span",{class:"text-red-500"},"*")],-1)),c(v,{modelValue:a.submissionType,"onUpdate:modelValue":e[2]||(e[2]=r=>a.submissionType=r),options:B,placeholder:"Pilih tipe pengajuan","search-input":F.value,"onUpdate:searchInput":e[3]||(e[3]=r=>F.value=r)},null,8,["modelValue","search-input"])]),a.submissionType==="program"?(_(),D("div",va,[e[13]||(e[13]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Program",-1)),c(v,{modelValue:a.programId,"onUpdate:modelValue":e[4]||(e[4]=r=>a.programId=r),options:w.value,placeholder:"Pilih program"},null,8,["modelValue","options"]),S.value?(_(),D("div",ha,"Memuat saldo...")):d.value?(_(),D("div",ka,[t("div",wa,[t("div",null,[t("div",ja,"Sisa alokasi bulan "+m(O(d.value.month)),1),t("div",Sa,m(I(d.value.remaining)),1)]),t("div",Ia,[t("div",null,"Inflow: "+m(I(d.value.inflow)),1),t("div",null,"Dialokasikan: "+m(I(d.value.allocated)),1),t("div",null,"Terpakai: "+m(I(d.value.outflow)),1)])])])):R("",!0)])):R("",!0),t("div",_a,[e[14]||(e[14]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Status "),t("span",{class:"text-red-500"},"*")],-1)),c(v,{modelValue:a.status,"onUpdate:modelValue":e[5]||(e[5]=r=>a.status=r),options:G.value,placeholder:"Pilih status"},null,8,["modelValue","options"])]),t("div",Ta,[e[15]||(e[15]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Nominal "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Da,[U(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=r=>a.amount=r),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",onInput:H},null,544),[[A,a.amount,void 0,{number:!0}]]),t("span",Pa,m(X.value),1)]),e[16]||(e[16]=t("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"Minimal nominal: Rp 1",-1))]),t("div",Va,[e[17]||(e[17]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tanggal Digunakan "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Fa,[c(ia(ua),{modelValue:a.usedAt,"onUpdate:modelValue":e[7]||(e[7]=r=>a.usedAt=r),config:L,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih tanggal digunakan",required:""},null,8,["modelValue"])])]),t("div",Ca,[e[18]||(e[18]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tujuan Pengajuan",-1)),U(t("textarea",{"onUpdate:modelValue":e[8]||(e[8]=r=>a.purpose=r),placeholder:"Masukkan tujuan atau alasan pengajuan dana",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[A,a.purpose]]),t("p",Na,m(a.purpose.length)+"/1000 karakter",1)]),t("div",Ma,[e[19]||(e[19]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Kantor Cabang "),t("span",{class:"text-red-500"},"*")],-1)),c(v,{modelValue:a.branchId,"onUpdate:modelValue":e[9]||(e[9]=r=>a.branchId=r),options:k.value,placeholder:"Pilih atau cari kantor cabang","search-input":C.value,"onUpdate:searchInput":e[10]||(e[10]=r=>C.value=r)},null,8,["modelValue","options","search-input"])])]),t("div",Ra,[t("button",{onClick:M,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"},"Batal"),t("button",Ua,m(g.value?"Simpan Perubahan":"Simpan"),1)])],32)])]),_:1}))}});export{Oa as default};
