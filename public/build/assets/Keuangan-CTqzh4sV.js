import{d as we,H as ke,I as _e,b,M as xe,A as V,Q as De,f as Ce,X as Se,B as Fe,g as Te,o as F,w as Ne,a as o,j as B,t as E,m as Re,u as te,c as A,F as Ae,l as Ie,i as Pe,S as Ke,V as re}from"./admin-NNvHtTjl.js";import{C as Me}from"./component-D3PUq-lH.js";import{u as q,w as Ve}from"./xlsx-3SA47z_C.js";import{_ as Be}from"./AdminLayout.vue_vue_type_script_setup_true_lang-tAcyVQU7.js";import{_ as Ee}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-C_TniGGE.js";import{A as ne}from"./AsyncSearchableSelect-D2Mrx9zO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const $e={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ze={class:"mb-6 flex items-center justify-between"},He={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},je={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Oe={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-3"},Le={class:"relative"},Ge={class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},Ue={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},We={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Je={class:"relative",style:{width:"100%",height:"450px"}},qe={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Xe={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},Ye={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Qe={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Ze={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},ea={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},aa={class:"text-gray-500 dark:text-gray-500 text-sm"},ma=we({__name:"Keuangan",setup(ta){const le=ke();_e();const se=b(String(le.meta.title||"Keuangan")),$=b(null),I=b(null),X=b(null),j=xe(),{fetchUser:oe,hasPermission:O,isAdmin:L}=De();V(()=>L()||O("create keuangan")),V(()=>L()||O("update keuangan")),V(()=>L()||O("delete keuangan"));const G=b(!1),z=b(null),ie={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},P=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:v},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:v},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:v},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:v},{headerName:"Program",field:"program",valueFormatter:v},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:v},{headerName:"Bonus",field:"bonus",valueFormatter:v},{headerName:"Championship",field:"championship",valueFormatter:v}]}],U={resizable:!0,sortable:!0,filter:!1};U.minWidth=120,U.cellClass="text-sm";function v(e){return e&&e.value!==void 0&&e.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e.value):""}const ue=e=>v({value:e});function de(e){switch((e||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(e)}}function Y(e,t){var r;const n=de(e);if(n&&n!==String(e))return n;try{for(const l of t||[]){const i=(r=l==null?void 0:l.shares_meta)==null?void 0:r[e];if(i){if(typeof i=="string")return i;if(i.label||i.name||i.title)return i.label||i.name||i.title}if(l&&l.share_labels&&l.share_labels[e])return l.share_labels[e]}}catch{}let s=String(e).replace(/^custom_/,"").replace(/_/g," ");return s=s.replace(/\b\w/g,l=>l.toUpperCase()),s}const C=b([]),Q=b([]),w=b((()=>{const e=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],n=[],s=new Date("2024-01-01");for(let r=1;r<=200;r++){const l=(r-1)%e.length,i=(r-1)%t.length,p=new Date(s);p.setDate(p.getDate()+(r-1)*2);const g=Math.floor(Math.random()*75e6)+25e6;n.push({id:r.toString(),pic:e[l],jumlah:g,kantorCabang:t[i],tanggalKeuangan:p.toISOString().split("T")[0]})}return n})()),D=b(""),T=b(""),N=b(""),Z=V(()=>w.value),ce=V(()=>Z.value.length===0),me=()=>{z.value&&(w.value=w.value.filter(e=>e.id!==z.value),j.success("Data keuangan berhasil dihapus"),G.value=!1,z.value=null,K())},ge=()=>{G.value=!1,z.value=null},he=()=>{const e=[],t=[],n=[],s=[];let r=0;P.forEach(u=>{if(u.field){const f=u.headerName||u.field;t.push(f),n.push(""),s.push({s:{r:0,c:r},e:{r:1,c:r}}),e.push(u.field),r+=1}else if(u.children&&Array.isArray(u.children)){const f=u.headerName||"",x=u.children.length;for(let c=0;c<x;c++)t.push(c===0?f:"");s.push({s:{r:0,c:r},e:{r:0,c:r+x-1}}),u.children.forEach(c=>{n.push(c.headerName||c.field),e.push(c.field),r+=1})}});const l=[];l.push(t),l.push(n),w.value.forEach(u=>{const f=[];e.forEach(x=>{const c=u[x];f.push(typeof c=="number"?c:c??"")}),l.push(f)}),C.value&&C.value.length&&C.value.forEach(u=>{const f=[];e.forEach(x=>{const c=u[x];f.push(typeof c=="number"?c:c??"")}),l.push(f)});const i=q.aoa_to_sheet(l);i["!merges"]=i["!merges"]||[],s.forEach(u=>i["!merges"].push(u));const p=q.book_new();q.book_append_sheet(p,i,"Keuangan");const h=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ve(p,h)},fe=(e,t)=>{if(!t||t.length===0)return e;const n=[...e];return t.forEach(s=>{const{colId:r,sort:l}=s;n.sort((i,p)=>{let g=i[r],h=p[r];return r==="tanggalKeuangan"?(g=new Date(g).getTime(),h=new Date(h).getTime()):r==="jumlah"?(g=g||0,h=h||0):typeof g=="string"&&(g=g.toLowerCase(),h=h.toLowerCase()),g<h?l==="asc"?-1:1:g>h?l==="asc"?1:-1:0})}),n},H=b({getRows:e=>{setTimeout(()=>{const t=e.startRow||0,n=e.endRow||0;let s=Z.value;e.sortModel&&e.sortModel.length>0&&(s=fe(s,e.sortModel));const r=s.slice(t,n);let l;s.length===0?l=0:s.length<=n?l=s.length:l=void 0,e.successCallback(r,l)},50)}}),ee=async()=>{var e,t;try{let n="/admin/api/keuangan/program-shares-summary";try{const a=D.value;let d=null,m=null;if(a){if(Array.isArray(a))d=a[0]?a[0]instanceof Date?a[0].toISOString().split("T")[0]:String(a[0]):null,m=a[1]?a[1]instanceof Date?a[1].toISOString().split("T")[0]:String(a[1]):null;else if(typeof a=="string"){const S=a.includes(" to ")?" to ":a.includes(" - ")?" - ":"";if(S){const W=a.split(S);d=((e=W[0])==null?void 0:e.trim())||null,m=((t=W[1])==null?void 0:t.trim())||null}else d=a||null,m=a||null}}const y={};d&&(y.start_date=d),m&&(y.end_date=m),T.value&&(y.fundraiser_id=T.value),N.value&&(y.mitra_id=N.value);const k=new URLSearchParams(y).toString();k&&(n+=`?${k}`)}catch{}const r=await(await fetch(n,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){j.error("Gagal memuat ringkasan program");return}const l=r.data.rows||[],i=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],p=[];p.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),p.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:v,resizable:!0});const g=r.data&&r.data.share_type_labels?r.data.share_type_labels:{};l.forEach(a=>{const d=[];d.push({headerName:"Nominal Transaksi",field:`p_${a.program_id||a.id}_nominal`,valueFormatter:v,resizable:!0,width:160});const m=i.map(k=>{let S="";try{const J=a.shares_meta||{},_=J[k]||J[k.toString()]||null;if(_)if(_.type==="percentage"&&_.value!==null&&_.value!==void 0){const R=Number(_.value);Number.isFinite(R)?S=Number.isInteger(R)?` (${R}%)`:` (${R%1===0?R:parseFloat(R.toFixed(2))}%)`:S=` (${_.value}%)`}else _.type==="nominal"&&_.value!==null&&_.value!==void 0&&(S=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(_.value)})`)}catch{}return{headerName:`${g[k]||Y(k,l)}${S}`,field:`p_${a.program_id||a.id}_${k}`,valueFormatter:v,resizable:!0,minWidth:120}});d.push(...m);const y=`${a.program_name||a.nama_program||a.nama||"Program"}`;p.push({headerName:y,children:d})}),P.splice(0,P.length,...p),re(()=>{var d;const a=I.value||((d=$.value)==null?void 0:d.api);if(a)try{a.setColumnDefs(P);try{a.setDatasource&&H.value?a.setDatasource(H.value):a.setRowData(w.value)}catch{try{a.setRowData(w.value)}catch{}}a.setPinnedBottomRowData(C.value);try{a.sizeColumnsToFit()}catch{}setTimeout(()=>{try{ae()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const h={summary_label:"TOTAL"},u=l.reduce((a,d)=>a+(d.total_transaksi||0),0);l.forEach(a=>{const d=`p_${a.program_id||a.id}_nominal`;h[d]=a.total_transaksi||0,i.forEach(m=>{const y=`p_${a.program_id||a.id}_${m}`;h[y]=a[m]||0})}),h.nominal=u;const f=[];f.push({label:"Nominal Keseluruhan Transaksi",value:u});let x=0;i.forEach(a=>{const d=l.reduce((y,k)=>y+(Number(k[a]||0)||0),0),m=g[a]||Y(a,l);f.push({label:`Nominal All ${m}`,value:d}),x+=d});const c=u-x;c>0&&f.push({label:"Sisa Belum Teralokasi",value:c}),Q.value=f,w.value=[h],C.value=[],K(!0)}catch(n){console.error(n),j.error("Terjadi kesalahan saat memuat ringkasan program")}},K=(e=!1)=>{re(()=>{var n;const t=I.value||((n=$.value)==null?void 0:n.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&H.value?t.setDatasource(H.value):t.setRowData(w.value)}catch{}t.setPinnedBottomRowData(C.value),e&&window.setTimeout(()=>{var r;const s=I.value||((r=$.value)==null?void 0:r.api);if(s)try{s.ensureIndexVisible(0,"top")}catch{}},100)}catch(s){console.error("Error refreshing grid:",s)}})};Ce(async()=>{await oe(),await ee(),K()});function pe(e){I.value=e.api,X.value=e.columnApi;try{e.api.setRowData&&e.api.setRowData(w.value)}catch{}}function ae(){var s;const e=X.value;if(!e)return;const t=e.getAllColumns();if(!t||!t.length)return;const n=t.map(r=>r.getColId());try{e.autoSizeColumns(n,!1)}catch{try{(s=I.value)==null||s.sizeColumnsToFit()}catch{}}}function be(e){try{e.api.sizeColumnsToFit()}catch{}ae()}Se(()=>{M&&clearTimeout(M)});const ve=()=>{K()};let M=null;Fe([D,T,N],()=>{M&&clearTimeout(M),M=setTimeout(async()=>{try{await ee()}catch{}K(!0)},300)});const ye=()=>{D.value="",T.value="",N.value=""};return(e,t)=>(F(),Te(Be,null,{default:Ne(()=>[o("div",$e,[o("div",ze,[o("h3",He,E(se.value),1),o("div",{class:"flex items-center gap-3"},[o("button",{onClick:he,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[3]||(t[3]=[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Re(" Export Excel ",-1)])])])]),o("div",je,[o("div",Oe,[o("div",null,[t[4]||(t[4]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),o("div",Le,[B(te(Me),{modelValue:D.value,"onUpdate:modelValue":t[0]||(t[0]=n=>D.value=n),config:ie,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])]),o("div",null,[t[5]||(t[5]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Fundraiser",-1)),B(ne,{modelValue:T.value,"onUpdate:modelValue":t[1]||(t[1]=n=>T.value=n),"fetch-url":"/admin/api/karyawan","label-key":"nama","value-key":"id",placeholder:"Pilih Fundraiser","allow-clear":!0,"include-all":!0,"all-label":"Semua Fundraiser",params:{role:"fundraiser"}},null,8,["modelValue"])]),o("div",null,[t[6]||(t[6]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Mitra",-1)),B(ne,{modelValue:N.value,"onUpdate:modelValue":t[2]||(t[2]=n=>N.value=n),"fetch-url":"/admin/api/mitra","label-key":"nama","value-key":"id",placeholder:"Pilih Mitra","allow-clear":!0,"include-all":!0,"all-label":"Semua Mitra"},null,8,["modelValue"])])]),o("div",{class:"mt-4"},[o("button",{onClick:ye,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),o("div",Ge,[(F(!0),A(Ae,null,Ie(Q.value,(n,s)=>(F(),A("div",{key:`summary-${s}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[o("p",Ue,E(n.label),1),o("p",We,E(ue(n.value)),1)]))),128))]),o("div",Je,[o("div",qe,[B(te(Ke),{ref_key:"agGridRef",ref:$,onGridReady:pe,onFirstDataRendered:be,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:P,defaultColDef:U,pinnedBottomRowData:C.value,rowData:w.value,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:ve},null,8,["pinnedBottomRowData","rowData"])]),ce.value?(F(),A("div",Xe,[(F(),A("svg",Ye,[e.filterPIC||e.filterKantorCabang||D.value||e.filterJumlahMin||e.filterJumlahMax?(F(),A("path",Qe)):(F(),A("path",Ze))])),o("p",ea,E(D.value?"Tidak ada data ditemukan":"Tidak ada data"),1),o("p",aa,E(D.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Pe("",!0)])]),B(Ee,{isOpen:G.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:me,onCancel:ge},null,8,["isOpen"])]),_:1}))}});export{ma as default};
