import{d as xe,H as _e,I as De,b as p,M as Ce,A as V,Q as Se,f as Fe,X as Te,B as Ne,g as Re,o as D,w as Ae,a as o,j as B,c as S,i as X,t as E,m as Me,u as ne,F as Ie,l as Pe,S as Ke,V as le}from"./admin-D1J7V-ZI.js";import{C as Ve}from"./component-BE0ZUxfh.js";import{u as Y,w as Be}from"./xlsx-3SA47z_C.js";import{_ as Ee}from"./AdminLayout.vue_vue_type_script_setup_true_lang-hhmXvr9A.js";import{_ as ze}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-BcKIivn1.js";import{A as se}from"./AsyncSearchableSelect-DXtx81d3.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const $e={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},He={class:"mb-6 flex items-center justify-between"},je={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Oe={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Le={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-3"},Ge={class:"relative"},Ue={key:0,class:"mb-6 flex items-center justify-center gap-3 rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.02]"},We={key:1,class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},Je={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},qe={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Xe={class:"relative",style:{width:"100%",height:"450px"}},Ye={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Qe={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},Ze={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},ea={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},aa={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},ta={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},ra={class:"text-gray-500 dark:text-gray-500 text-sm"},ha=xe({__name:"Keuangan",setup(na){const oe=_e();De();const ie=p(String(oe.meta.title||"Keuangan")),z=p(null),M=p(null),Q=p(null),O=Ce(),{fetchUser:ue,hasPermission:L,isAdmin:G}=Se();V(()=>G()||L("create keuangan")),V(()=>G()||L("update keuangan")),V(()=>G()||L("delete keuangan"));const U=p(!1),$=p(null),H=p(!1),de={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},I=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:v},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:v},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:v},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:v},{headerName:"Program",field:"program",valueFormatter:v},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:v},{headerName:"Bonus",field:"bonus",valueFormatter:v},{headerName:"Championship",field:"championship",valueFormatter:v}]}],W={resizable:!0,sortable:!0,filter:!1};W.minWidth=120,W.cellClass="text-sm";function v(e){return e&&e.value!==void 0&&e.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e.value):""}const ce=e=>v({value:e});function me(e){switch((e||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(e)}}function Z(e,a){var r;const n=me(e);if(n&&n!==String(e))return n;try{for(const l of a||[]){const i=(r=l==null?void 0:l.shares_meta)==null?void 0:r[e];if(i){if(typeof i=="string")return i;if(i.label||i.name||i.title)return i.label||i.name||i.title}if(l&&l.share_labels&&l.share_labels[e])return l.share_labels[e]}}catch{}let s=String(e).replace(/^custom_/,"").replace(/_/g," ");return s=s.replace(/\b\w/g,l=>l.toUpperCase()),s}const F=p([]),ee=p([]),w=p((()=>{const e=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],a=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],n=[],s=new Date("2024-01-01");for(let r=1;r<=200;r++){const l=(r-1)%e.length,i=(r-1)%a.length,b=new Date(s);b.setDate(b.getDate()+(r-1)*2);const g=Math.floor(Math.random()*75e6)+25e6;n.push({id:r.toString(),pic:e[l],jumlah:g,kantorCabang:a[i],tanggalKeuangan:b.toISOString().split("T")[0]})}return n})()),C=p(""),N=p(""),R=p(""),ae=V(()=>w.value),ge=V(()=>ae.value.length===0),he=()=>{$.value&&(w.value=w.value.filter(e=>e.id!==$.value),O.success("Data keuangan berhasil dihapus"),U.value=!1,$.value=null,P())},fe=()=>{U.value=!1,$.value=null},pe=()=>{const e=[],a=[],n=[],s=[];let r=0;I.forEach(u=>{if(u.field){const f=u.headerName||u.field;a.push(f),n.push(""),s.push({s:{r:0,c:r},e:{r:1,c:r}}),e.push(u.field),r+=1}else if(u.children&&Array.isArray(u.children)){const f=u.headerName||"",_=u.children.length;for(let c=0;c<_;c++)a.push(c===0?f:"");s.push({s:{r:0,c:r},e:{r:0,c:r+_-1}}),u.children.forEach(c=>{n.push(c.headerName||c.field),e.push(c.field),r+=1})}});const l=[];l.push(a),l.push(n),w.value.forEach(u=>{const f=[];e.forEach(_=>{const c=u[_];f.push(typeof c=="number"?c:c??"")}),l.push(f)}),F.value&&F.value.length&&F.value.forEach(u=>{const f=[];e.forEach(_=>{const c=u[_];f.push(typeof c=="number"?c:c??"")}),l.push(f)});const i=Y.aoa_to_sheet(l);i["!merges"]=i["!merges"]||[],s.forEach(u=>i["!merges"].push(u));const b=Y.book_new();Y.book_append_sheet(b,i,"Keuangan");const h=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Be(b,h)},be=(e,a)=>{if(!a||a.length===0)return e;const n=[...e];return a.forEach(s=>{const{colId:r,sort:l}=s;n.sort((i,b)=>{let g=i[r],h=b[r];return r==="tanggalKeuangan"?(g=new Date(g).getTime(),h=new Date(h).getTime()):r==="jumlah"?(g=g||0,h=h||0):typeof g=="string"&&(g=g.toLowerCase(),h=h.toLowerCase()),g<h?l==="asc"?-1:1:g>h?l==="asc"?1:-1:0})}),n},j=p({getRows:e=>{setTimeout(()=>{const a=e.startRow||0,n=e.endRow||0;let s=ae.value;e.sortModel&&e.sortModel.length>0&&(s=be(s,e.sortModel));const r=s.slice(a,n);let l;s.length===0?l=0:s.length<=n?l=s.length:l=void 0,e.successCallback(r,l)},50)}}),te=async()=>{var e,a;H.value=!0;try{let n="/admin/api/keuangan/program-shares-summary";try{const t=C.value;let d=null,m=null;if(t){if(Array.isArray(t))d=t[0]?t[0]instanceof Date?t[0].toISOString().split("T")[0]:String(t[0]):null,m=t[1]?t[1]instanceof Date?t[1].toISOString().split("T")[0]:String(t[1]):null;else if(typeof t=="string"){const T=t.includes(" to ")?" to ":t.includes(" - ")?" - ":"";if(T){const J=t.split(T);d=((e=J[0])==null?void 0:e.trim())||null,m=((a=J[1])==null?void 0:a.trim())||null}else d=t||null,m=t||null}}const y={};d&&(y.start_date=d),m&&(y.end_date=m),N.value&&(y.fundraiser_id=N.value),R.value&&(y.mitra_id=R.value);const k=new URLSearchParams(y).toString();k&&(n+=`?${k}`)}catch{}const r=await(await fetch(n,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){O.error("Gagal memuat ringkasan program");return}const l=r.data.rows||[],i=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],b=[];b.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),b.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:v,resizable:!0});const g=r.data&&r.data.share_type_labels?r.data.share_type_labels:{};l.forEach(t=>{const d=[];d.push({headerName:"Nominal Transaksi",field:`p_${t.program_id||t.id}_nominal`,valueFormatter:v,resizable:!0,width:160});const m=i.map(k=>{let T="";try{const q=t.shares_meta||{},x=q[k]||q[k.toString()]||null;if(x)if(x.type==="percentage"&&x.value!==null&&x.value!==void 0){const A=Number(x.value);Number.isFinite(A)?T=Number.isInteger(A)?` (${A}%)`:` (${A%1===0?A:parseFloat(A.toFixed(2))}%)`:T=` (${x.value}%)`}else x.type==="nominal"&&x.value!==null&&x.value!==void 0&&(T=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(x.value)})`)}catch{}return{headerName:`${g[k]||Z(k,l)}${T}`,field:`p_${t.program_id||t.id}_${k}`,valueFormatter:v,resizable:!0,minWidth:120}});d.push(...m);const y=`${t.program_name||t.nama_program||t.nama||"Program"}`;b.push({headerName:y,children:d})}),I.splice(0,I.length,...b),le(()=>{var d;const t=M.value||((d=z.value)==null?void 0:d.api);if(t)try{t.setColumnDefs(I);try{t.setDatasource&&j.value?t.setDatasource(j.value):t.setRowData(w.value)}catch{try{t.setRowData(w.value)}catch{}}t.setPinnedBottomRowData(F.value);try{t.sizeColumnsToFit()}catch{}setTimeout(()=>{try{re()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const h={summary_label:"TOTAL"},u=l.reduce((t,d)=>t+(d.total_transaksi||0),0);l.forEach(t=>{const d=`p_${t.program_id||t.id}_nominal`;h[d]=t.total_transaksi||0,i.forEach(m=>{const y=`p_${t.program_id||t.id}_${m}`;h[y]=t[m]||0})}),h.nominal=u;const f=[];f.push({label:"Nominal Keseluruhan Transaksi",value:u});let _=0;i.forEach(t=>{const d=l.reduce((y,k)=>y+(Number(k[t]||0)||0),0),m=g[t]||Z(t,l);f.push({label:`Nominal All ${m}`,value:d}),_+=d});const c=u-_;c>0&&f.push({label:"Sisa Belum Teralokasi",value:c}),ee.value=f,w.value=[h],F.value=[],P(!0)}catch(n){console.error(n),O.error("Terjadi kesalahan saat memuat ringkasan program")}finally{H.value=!1}},P=(e=!1)=>{le(()=>{var n;const a=M.value||((n=z.value)==null?void 0:n.api);if(a)try{try{a.purgeInfiniteCache?a.purgeInfiniteCache():a.setDatasource&&j.value?a.setDatasource(j.value):a.setRowData(w.value)}catch{}a.setPinnedBottomRowData(F.value),e&&window.setTimeout(()=>{var r;const s=M.value||((r=z.value)==null?void 0:r.api);if(s)try{s.ensureIndexVisible(0,"top")}catch{}},100)}catch(s){console.error("Error refreshing grid:",s)}})};Fe(async()=>{await ue(),await te(),P()});function ve(e){M.value=e.api,Q.value=e.columnApi;try{e.api.setRowData&&e.api.setRowData(w.value)}catch{}}function re(){var s;const e=Q.value;if(!e)return;const a=e.getAllColumns();if(!a||!a.length)return;const n=a.map(r=>r.getColId());try{e.autoSizeColumns(n,!1)}catch{try{(s=M.value)==null||s.sizeColumnsToFit()}catch{}}}function ye(e){try{e.api.sizeColumnsToFit()}catch{}re()}Te(()=>{K&&clearTimeout(K)});const we=()=>{P()};let K=null;Ne([C,N,R],()=>{K&&clearTimeout(K),K=setTimeout(async()=>{try{await te()}catch{}P(!0)},300)});const ke=()=>{C.value="",N.value="",R.value=""};return(e,a)=>(D(),Re(Ee,null,{default:Ae(()=>[o("div",$e,[o("div",He,[o("h3",je,E(ie.value),1),o("div",{class:"flex items-center gap-3"},[o("button",{onClick:pe,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...a[3]||(a[3]=[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Me(" Export Excel ",-1)])])])]),o("div",Oe,[o("div",Le,[o("div",null,[a[4]||(a[4]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),o("div",Ge,[B(ne(Ve),{modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=n=>C.value=n),config:de,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])]),o("div",null,[a[5]||(a[5]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Fundraiser",-1)),B(se,{modelValue:N.value,"onUpdate:modelValue":a[1]||(a[1]=n=>N.value=n),"fetch-url":"/admin/api/karyawan","label-key":"nama","value-key":"id",placeholder:"Pilih Fundraiser","allow-clear":!0,"include-all":!0,"all-label":"Semua Fundraiser",params:{role:"fundraiser"}},null,8,["modelValue"])]),o("div",null,[a[6]||(a[6]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Mitra",-1)),B(se,{modelValue:R.value,"onUpdate:modelValue":a[2]||(a[2]=n=>R.value=n),"fetch-url":"/admin/api/mitra","label-key":"nama","value-key":"id",placeholder:"Pilih Mitra","allow-clear":!0,"include-all":!0,"all-label":"Semua Mitra"},null,8,["modelValue"])])]),o("div",{class:"mt-4"},[o("button",{onClick:ke,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),H.value?(D(),S("div",Ue,[...a[7]||(a[7]=[o("svg",{class:"animate-spin h-5 w-5 text-brand-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[o("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),o("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),o("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-400"},"Memuat data...",-1)])])):X("",!0),H.value?X("",!0):(D(),S("div",We,[(D(!0),S(Ie,null,Pe(ee.value,(n,s)=>(D(),S("div",{key:`summary-${s}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[o("p",Je,E(n.label),1),o("p",qe,E(ce(n.value)),1)]))),128))])),o("div",Xe,[o("div",Ye,[B(ne(Ke),{ref_key:"agGridRef",ref:z,onGridReady:ve,onFirstDataRendered:ye,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:I,defaultColDef:W,pinnedBottomRowData:F.value,rowData:w.value,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:we},null,8,["pinnedBottomRowData","rowData"])]),ge.value?(D(),S("div",Qe,[(D(),S("svg",Ze,[e.filterPIC||e.filterKantorCabang||C.value||e.filterJumlahMin||e.filterJumlahMax?(D(),S("path",ea)):(D(),S("path",aa))])),o("p",ta,E(C.value?"Tidak ada data ditemukan":"Tidak ada data"),1),o("p",ra,E(C.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):X("",!0)])]),B(ze,{isOpen:U.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:he,onCancel:fe},null,8,["isOpen"])]),_:1}))}});export{ha as default};
