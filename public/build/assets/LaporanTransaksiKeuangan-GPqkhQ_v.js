import{d as ve,H as be,I as we,b as k,M as ke,A as P,Q as De,f as xe,X as Ce,B as Se,g as Te,o as E,w as Re,a as g,j as J,t as q,m as Ne,u as te,c as z,i as Fe,S as Ie,V as re}from"./admin-DtEslib8.js";import{C as $e}from"./component-Bfb66AOS.js";import{u as X,w as Ke}from"./xlsx-3SA47z_C.js";import{_ as Pe}from"./AdminLayout.vue_vue_type_script_setup_true_lang-h0tBw0xe.js";import{_ as Ee}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-Dp7hplDO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ae={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Be={class:"mb-6 flex items-center justify-between"},Me={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ze={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ve={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},Oe={class:"relative"},je={class:"relative",style:{width:"100%",height:"450px"}},He={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Le={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},Ge={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},We={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Ue={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},Je={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},qe={class:"text-gray-500 dark:text-gray-500 text-sm"},na=ve({__name:"LaporanTransaksiKeuangan",setup(Xe){const ne=be();we();const oe=k(String(ne.meta.title||"Keuangan")),A=k(null),N=k(null),Y=k(null),V=ke(),{fetchUser:se,hasPermission:O,isAdmin:j}=De();P(()=>j()||O("create keuangan")),P(()=>j()||O("update keuangan")),P(()=>j()||O("delete keuangan"));const H=k(!1),B=k(null),ie={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},F=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:b},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:b},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:b},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:b},{headerName:"Program",field:"program",valueFormatter:b},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:b},{headerName:"Bonus",field:"bonus",valueFormatter:b},{headerName:"Championship",field:"championship",valueFormatter:b}]}],L={resizable:!0,sortable:!0,filter:!1};L.minWidth=120,L.cellClass="text-sm";function b(a){return a&&a.value!==void 0&&a.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a.value):""}const le=a=>{if(a==null)return"";const t=Number(a);return Number.isFinite(t)?Number.isInteger(t)?`${t}%`:`${parseFloat(t.toFixed(2))}%`:`${String(a)}%`};function de(a){switch((a||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(a)}}const T=k([]),C=k((()=>{const a=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],o=[],s=new Date("2024-01-01");for(let r=1;r<=200;r++){const c=(r-1)%a.length,y=(r-1)%t.length,_=new Date(s);_.setDate(_.getDate()+(r-1)*2);const h=Math.floor(Math.random()*75e6)+25e6;o.push({id:r.toString(),pic:a[c],jumlah:h,kantorCabang:t[y],tanggalKeuangan:_.toISOString().split("T")[0]})}return o})()),S=k(""),Q=P(()=>C.value),ce=P(()=>Q.value.length===0),ue=()=>{B.value&&(C.value=C.value.filter(a=>a.id!==B.value),V.success("Data keuangan berhasil dihapus"),H.value=!1,B.value=null,$())},me=()=>{H.value=!1,B.value=null},ge=()=>{const a=[],t=[],o=[],s=[];let r=0;F.forEach(l=>{if(l.field){const w=l.headerName||l.field;t.push(w),o.push(""),s.push({s:{r:0,c:r},e:{r:1,c:r}}),a.push(l.field),r+=1}else if(l.children&&Array.isArray(l.children)){const w=l.headerName||"",D=l.children.length;for(let f=0;f<D;f++)t.push(f===0?w:"");s.push({s:{r:0,c:r},e:{r:0,c:r+D-1}}),l.children.forEach(f=>{o.push(f.headerName||f.field),a.push(f.field),r+=1})}});const c=[];c.push(t),c.push(o),C.value.forEach(l=>{const w=[];a.forEach(D=>{const f=l[D];w.push(typeof f=="number"?f:f??"")}),c.push(w)}),T.value&&T.value.length&&T.value.forEach(l=>{const w=[];a.forEach(D=>{const f=l[D];w.push(typeof f=="number"?f:f??"")}),c.push(w)});const y=X.aoa_to_sheet(c);y["!merges"]=y["!merges"]||[],s.forEach(l=>y["!merges"].push(l));const _=X.book_new();X.book_append_sheet(_,y,"Keuangan");const v=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ke(_,v)},he=(a,t)=>{if(!t||t.length===0)return a;const o=[...a];return t.forEach(s=>{const{colId:r,sort:c}=s;o.sort((y,_)=>{let h=y[r],v=_[r];return r==="tanggalKeuangan"?(h=new Date(h).getTime(),v=new Date(v).getTime()):r==="jumlah"?(h=h||0,v=v||0):typeof h=="string"&&(h=h.toLowerCase(),v=v.toLowerCase()),h<v?c==="asc"?-1:1:h>v?c==="asc"?1:-1:0})}),o},Z=()=>({getRows:a=>{setTimeout(()=>{const t=a.startRow||0,o=a.endRow||0;let s=Q.value;a.sortModel&&a.sortModel.length>0&&(s=he(s,a.sortModel));const r=s.slice(t,o);let c;s.length===0?c=0:s.length<=o?c=s.length:c=void 0,a.successCallback(r,c)},50)}}),I=k(Z()),ee=async()=>{var a,t;try{let o="/admin/api/keuangan/program-shares-summary";try{const e=S.value;let i=null,d=null;if(e){if(Array.isArray(e))i=e[0]?e[0]instanceof Date?e[0].toISOString().split("T")[0]:String(e[0]):null,d=e[1]?e[1]instanceof Date?e[1].toISOString().split("T")[0]:String(e[1]):null;else if(typeof e=="string"){const m=e.includes(" to ")?" to ":e.includes(" - ")?" - ":"";if(m){const p=e.split(m);i=((a=p[0])==null?void 0:a.trim())||null,d=((t=p[1])==null?void 0:t.trim())||null}else i=e||null,d=e||null}}const u={};i&&(u.start_date=i),d&&(u.end_date=d);const n=new URLSearchParams(u).toString();n&&(o+=`?${n}`)}catch{}const r=await(await fetch(o,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){V.error("Gagal memuat ringkasan program");return}const c=r.data&&r.data.share_type_labels?r.data.share_type_labels:{},y=r.data.rows||[],_=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],h=[];h.push({headerName:"Tanggal Transaksi",field:"tanggal",pinned:"left",width:250}),h.push({headerName:"Nominal Transaksi",field:"nominal",pinned:"left",width:160,valueFormatter:b,resizable:!0}),y.forEach(e=>{const i=[];i.push({headerName:"Nominal Transaksi",field:`p_${e.program_id||e.id}_nominal`,valueFormatter:b,resizable:!0,width:160});const d=_.map(n=>{let m="";try{const U=e.shares_meta||{},x=U[n]||U[n.toString()]||null;x&&(x.type==="percentage"&&x.value!==null&&x.value!==void 0?m=` (${le(x.value)})`:x.type==="nominal"&&x.value!==null&&x.value!==void 0&&(m=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(x.value)})`))}catch{}const p=(n||"").toString().replace(/^custom_/,"");return{headerName:`${c[n]||c[p]||(e==null?void 0:e.shares_meta)&&(e.shares_meta[n]||e.shares_meta[p])&&(e.shares_meta[n]&&(e.shares_meta[n].label||e.shares_meta[n].name)||e.shares_meta[p]&&(e.shares_meta[p].label||e.shares_meta[p].name))||de(p||n)}${m}`,field:`p_${e.program_id||e.id}_${n}`,valueFormatter:b,resizable:!0,minWidth:120}});i.push(...d);const u=`${e.program_name||e.nama_program||e.nama||"Program"}`;h.push({headerName:u,children:i})}),F.splice(0,F.length,...h),re(()=>{var i;const e=N.value||((i=A.value)==null?void 0:i.api);if(e)try{e.setColumnDefs(F);try{e.setDatasource&&I.value?e.setDatasource(I.value):e.setRowData(C.value)}catch{try{e.setRowData(C.value)}catch{}}e.setPinnedBottomRowData(T.value);try{e.sizeColumnsToFit()}catch{}setTimeout(()=>{try{ae()}catch{}},80)}catch(d){console.error("Failed to apply dynamic columns to grid",d)}});const v=r.data.transaksis||[],l={},w=e=>{if(!e)return"";const i=new Date(e);return isNaN(i.getTime())?e:i.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})};v.forEach(e=>{const i=(e.tanggal_transaksi||e.tanggal||e.date||"").toString(),d=i;l[d]||(l[d]={tanggal:w(i),kode:null,nominal:0},y.forEach(n=>{l[d][`p_${n.program_id||n.id}_nominal`]=0,_.forEach(m=>{l[d][`p_${n.program_id||n.id}_${m}`]=0})}));const u=l[d];u.kode=u.kode||e.kode||null,u.nominal=(u.nominal||0)+(e.nominal||0),y.forEach(n=>{_.forEach(m=>{const p=`p_${n.program_id||n.id}_${m}`,W=`p_${n.program_id||n.id}`;m==="program"&&e[W]!==void 0?u[p]+=e[W]||0:u[p]+=e[p]||0});try{const m=n.program_id||n.id;e.program_id&&String(e.program_id)===String(m)&&(u[`p_${m}_nominal`]=(u[`p_${m}_nominal`]||0)+(e.nominal||0))}catch{}})});const D=Object.values(l);C.value=D;const f=D.reduce((e,i)=>e+(i.nominal||0),0),M={tanggal:"TOTAL"},G={tanggal:"DISBURSED TOTALS"},R=r.data&&r.data.disbursed_totals_by_program?r.data.disbursed_totals_by_program:{};y.forEach(e=>{const i=`p_${e.program_id||e.id}_nominal`;M[i]=e.total_transaksi||0,G[i]=0,_.forEach(d=>{const u=`p_${e.program_id||e.id}_${d}`;M[u]=e[d]||0;const n=u,m=`p_${e.program_id||e.id}`;let p=0;R&&R[n]!==void 0?p=R[n]:d==="program"&&R&&R[m]!==void 0&&(p=R[m]),G[u]=p||0})}),M.nominal=f,T.value=[M,G],$(!0)}catch(o){console.error(o),V.error("Terjadi kesalahan saat memuat ringkasan program")}},$=(a=!1)=>{re(()=>{var o;const t=N.value||((o=A.value)==null?void 0:o.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&I.value?t.setDatasource(I.value):t.setRowData(C.value)}catch{}t.setPinnedBottomRowData(T.value),a&&window.setTimeout(()=>{var r;const s=N.value||((r=A.value)==null?void 0:r.api);if(s)try{s.ensureIndexVisible(0,"top")}catch{}},100)}catch(s){console.error("Error refreshing grid:",s)}})};xe(async()=>{await se(),await ee(),$()});function fe(a){N.value=a.api,Y.value=a.columnApi;try{const t=I.value||Z();a.api.setDatasource&&a.api.setDatasource(t)}catch(t){console.error("Failed to set datasource for infinite row model",t)}}function ae(){var s;const a=Y.value;if(!a)return;const t=a.getAllColumns();if(!t||!t.length)return;const o=t.map(r=>r.getColId());try{a.autoSizeColumns(o,!1)}catch{try{(s=N.value)==null||s.sizeColumnsToFit()}catch{}}}function pe(a){try{a.api.sizeColumnsToFit()}catch{}ae()}Ce(()=>{K&&clearTimeout(K)});const ye=()=>{$()};let K=null;Se([S],()=>{K&&clearTimeout(K),K=setTimeout(async()=>{try{await ee()}catch{}$(!0)},300)});const _e=()=>{S.value=""};return(a,t)=>(E(),Te(Pe,null,{default:Re(()=>[g("div",Ae,[g("div",Be,[g("h3",Me,q(oe.value),1),g("div",{class:"flex items-center gap-3"},[g("button",{onClick:ge,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[g("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[g("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Ne(" Export Excel ",-1)])])])]),g("div",ze,[g("div",Ve,[g("div",null,[t[2]||(t[2]=g("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),g("div",Oe,[J(te($e),{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=o=>S.value=o),config:ie,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),g("div",{class:"mt-4"},[g("button",{onClick:_e,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),g("div",je,[g("div",He,[J(te(Ie),{ref_key:"agGridRef",ref:A,onGridReady:fe,onFirstDataRendered:pe,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:F,defaultColDef:L,pinnedBottomRowData:T.value,rowModelType:"infinite",cacheBlockSize:50,maxBlocksInCache:10,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:ye},null,8,["pinnedBottomRowData"])]),ce.value?(E(),z("div",Le,[(E(),z("svg",Ge,[a.filterPIC||a.filterKantorCabang||S.value||a.filterJumlahMin||a.filterJumlahMax?(E(),z("path",We)):(E(),z("path",Ue))])),g("p",Je,q(S.value?"Tidak ada data ditemukan":"Tidak ada data"),1),g("p",qe,q(S.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Fe("",!0)])]),J(Ee,{isOpen:H.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ue,onCancel:me},null,8,["isOpen"])]),_:1}))}});export{na as default};
