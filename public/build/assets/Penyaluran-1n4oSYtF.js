import{d as pe,H as he,I as ye,A as d,b as s,M as ve,Q as we,f as be,X as xe,B as ke,g as De,o as b,w as Ce,a as o,j as D,c as C,i as V,F as _e,l as Ie,t as L,m as $,k as je,v as Re,u as z,S as Pe,V as Te}from"./admin-CF_-7hGV.js";import{C as Fe}from"./component-Bfv6VnLb.js";import{u as M,w as Ne}from"./xlsx-3SA47z_C.js";import{_ as Ve}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BqqeiGIx.js";import{S as W}from"./SearchableSelect-CjrBoHsr.js";import{_ as Le}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-BaC8vDE3.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Me={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Se={key:0,class:"mb-6"},Ee={class:"grid grid-cols-1 sm:grid-cols-3 gap-3"},He={class:"text-xs text-gray-500"},Ae={class:"text-lg font-medium text-gray-800 dark:text-white/90 mt-1"},Be={class:"mb-6 flex items-center justify-between"},Ge={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Oe={class:"flex flex-col sm:flex-row items-center gap-3 w-full sm:w-auto"},qe={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Xe={class:"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4"},Ue={class:"flex-1"},Ye={class:"flex-1"},$e={class:"flex-1"},ze={class:"relative"},We={class:"flex-1"},Je={class:"relative",style:{width:"100%",height:"450px"}},Ke={key:0,class:"absolute inset-0 z-10 flex items-center justify-center bg-white/80 dark:bg-gray-900/80"},Ze={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},ia=pe({__name:"Penyaluran",setup(Qe){const J=he(),S=ye(),K=d(()=>J.meta.title||"Penyaluran"),T=s(null),E=s(!0),f=ve(),{fetchUser:Z,hasPermission:_,isAdmin:I}=we(),Q=d(()=>I()||_("create penyaluran")),ee=d(()=>I()||_("update penyaluran")),ae=d(()=>I()||_("delete penyaluran"));d(()=>I()||_("view penyaluran"));const x=s(!1),p=s(null),te={...{dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1},mode:"range"},re=[{headerName:"Nama Penyaluran",field:"namaPenyaluran",sortable:!0,filter:!1,flex:1},{headerName:"Nama Program",field:"namaProgram",sortable:!0,filter:!1,flex:1},{headerName:"Tipe Penyaluran",field:"tipe",sortable:!0,filter:!1,width:180},{headerName:"Jumlah Dana",field:"jumlahDana",sortable:!0,filter:!1,flex:1,valueFormatter:r=>r.value?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(r.value):""},{headerName:"PIC",field:"pic",sortable:!0,filter:!1,flex:1},{headerName:"Tanggal",field:"tanggal",sortable:!0,filter:!1,width:160,valueFormatter:r=>{if(!r.value)return"";try{return new Date(r.value).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}catch{return String(r.value)}}},{headerName:"Actions",field:"actions",sortable:!1,filter:!1,width:120,cellRenderer:r=>{const e=document.createElement("div");e.className="flex items-center gap-2";const t=document.createElement("button");t.className="flex items-center justify-center w-8 h-8 rounded-lg text-brand-500 hover:bg-brand-50 dark:hover:bg-brand-500/10 transition-colors",t.innerHTML=`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
        </svg>
      `,t.onclick=()=>oe(r.data.id);const a=document.createElement("button");return a.className="flex items-center justify-center w-8 h-8 rounded-lg text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors",a.innerHTML=`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      `,a.onclick=()=>se(r.data.id),ee.value&&e.appendChild(t),ae.value&&e.appendChild(a),e}}],ne={resizable:!0,sortable:!0,filter:!1},j=s([]),H=s(0),m=s([]),A=d(()=>m.value.filter(r=>Number(r.value)>0)),B=s(0),G=s(0),O=s(0),q=s([]),X=s([]);d(()=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(H.value)),d(()=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(B.value||0)),d(()=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(G.value||0)),d(()=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(O.value||0));const F=async()=>{try{const e=await(await fetch("/admin/api/penyaluran?per_page=1000",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!e.success){f.error("Gagal memuat data penyaluran");return}const t=(e.data||[]).map(a=>{var l,n,i,c;return{id:a.id,namaPenyaluran:a.program_name||a.pengajuan&&(((l=a.pengajuan.program)==null?void 0:l.nama_program)||((n=a.pengajuan.program)==null?void 0:n.nama))||"",namaProgram:a.pengajuan&&(((i=a.pengajuan.program)==null?void 0:i.nama_program)||((c=a.pengajuan.program)==null?void 0:c.nama))||"",programId:a.pengajuan&&a.pengajuan.program?a.pengajuan.program.id||null:a.program_id||null,tipe:a.submission_type||a.pengajuan&&a.pengajuan.submission_type||"",jumlahDana:a.amount||0,pic:a.pic||(a.pengajuan&&a.pengajuan.fundraiser?a.pengajuan.fundraiser.name:""),tanggal:a.created_at||a.tanggal||null,raw:a}});j.value=t,P(!0)}catch(r){console.error("Error loading penyaluran",r),f.error("Gagal memuat data")}},h=s(""),y=s(""),v=s(""),w=s(""),R=d(()=>{let r=[...j.value];if(w.value&&(r=r.filter(e=>String(e.programId||"")===String(w.value))),h.value){const e=h.value.toLowerCase();r=r.filter(t=>t.pic.toLowerCase().includes(e))}if(y.value){let e=null,t=null;const a=y.value;if(Array.isArray(a))e=a[0]?new Date(a[0]):null,t=a[1]?new Date(a[1]):e;else if(a&&typeof a=="string"){const l=a.split(/\s+to\s+|,| - /);l.length>=1&&(e=l[0]?new Date(l[0]):null,t=l[1]?new Date(l[1]):e)}(e||t)&&(r=r.filter(l=>{if(!l.tanggal)return!1;const n=new Date(l.tanggal);return e&&t?n>=new Date(e.getFullYear(),e.getMonth(),e.getDate())&&n<=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59):e?n>=new Date(e.getFullYear(),e.getMonth(),e.getDate()):t?n<=new Date(t.getFullYear(),t.getMonth(),t.getDate(),23,59,59):!0}))}return v.value&&(r=r.filter(e=>{try{return String(e.tipe||"").toLowerCase()===String(v.value).toLowerCase()}catch{return!1}})),r});d(()=>R.value.length===0);const le=()=>{S.push("/keuangan/penyaluran/new")},oe=r=>{S.push(`/keuangan/penyaluran/${r}/edit`)},se=r=>{p.value=r,x.value=!0},ie=()=>{var e;if(!p.value)return;const r=p.value;try{const t=((e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"))||"";fetch(`/admin/api/penyaluran/${r}`,{method:"DELETE",credentials:"same-origin",headers:{"X-CSRF-TOKEN":t,"X-Requested-With":"XMLHttpRequest"}}).then(a=>a.json()).then(a=>{if(!a.success){f.error(a.message||"Gagal menghapus penyaluran");return}j.value=j.value.filter(l=>l.id!==r),f.success("Penyaluran berhasil dihapus"),x.value=!1,p.value=null;try{window.dispatchEvent(new CustomEvent("penyaluran:changed"))}catch{}P()}).catch(a=>{console.error("Delete failed",a),f.error("Gagal menghapus penyaluran")})}catch(t){console.error("Delete error",t),f.error("Gagal menghapus penyaluran")}},ue=()=>{x.value=!1,p.value=null},de=()=>{const r=R.value.map(n=>{const i=new Date(n.tanggal);return{"Nama Program":n.namaProgram,"Jumlah Dana":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n.jumlahDana),PIC:n.pic,Tanggal:i.toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"})}}),e=M.json_to_sheet(r),t=M.book_new();M.book_append_sheet(t,e,"Penyaluran");const l=`Penyaluran_${new Date().toISOString().split("T")[0]}.xlsx`;Ne(t,l)},ce=(r,e)=>{if(!e||e.length===0)return r;const t=[...r];return e.forEach(a=>{const{colId:l,sort:n}=a;t.sort((i,c)=>{let u=i[l],g=c[l];return l==="tanggal"?(u=new Date(u).getTime(),g=new Date(g).getTime()):l==="jumlahDana"?(u=u||0,g=g||0):typeof u=="string"&&(u=u.toLowerCase(),g=g.toLowerCase()),u<g?n==="asc"?-1:1:u>g?n==="asc"?1:-1:0})}),t},U=()=>({getRows:r=>{setTimeout(()=>{const e=r.startRow||0,t=r.endRow||0;let a=R.value;r.sortModel&&r.sortModel.length>0&&(a=ce(a,r.sortModel));const l=a.slice(e,t);let n;a.length===0?n=0:a.length<=t?n=a.length:n=void 0,r.successCallback(l,n),E.value=!1},50)}}),Y=s(U()),P=(r=!1)=>{const e=U();Y.value.getRows=e.getRows,Te(()=>{var a;const t=(a=T.value)==null?void 0:a.api;if(t)try{if(t.purgeInfiniteCache(),t.refreshInfiniteCache(),R.value.length===0)try{t.showNoRowsOverlay()}catch{}else try{t.hideOverlay()}catch{}r&&window.setTimeout(()=>{var n;const l=(n=T.value)==null?void 0:n.api;l&&l.ensureIndexVisible(0,"top")},100)}catch(l){console.error("Error refreshing cache:",l)}})};be(()=>{Z(),F(),ge(),N(),window.addEventListener("penyaluran:changed",()=>{F(),N()}),window.addEventListener("penyaluran:delete",r=>{const e=(r==null?void 0:r.detail)||null;e&&(p.value=e,x.value=!0)})});const N=async()=>{try{const e=await(await fetch("/admin/api/program-share-types/submission-types",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();let t=[];e.success&&Array.isArray(e.data)?t=e.data.map(n=>({value:n.value,label:n.value})):t=[{value:"Program",label:"Program"},{value:"Operasional",label:"Operasional"},{value:"Gaji Karyawan",label:"Gaji Karyawan"}],X.value=t;const a=t.map(n=>fetch(`/admin/api/penyaluran/my-credit?type=${encodeURIComponent(n.value)}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}}).then(i=>i.json()).catch(()=>null)),l=await Promise.all(a);m.value=t.map((n,i)=>{const c=l[i],u=c&&c.success&&c.data&&typeof c.data.remaining<"u"&&Number(c.data.remaining)||0,g=new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(u);return{type:n.value,label:n.label,value:u,formatted:g}}),m.value.length>0&&(B.value=m.value[0].value),m.value.length>1&&(G.value=m.value[1].value),m.value.length>2&&(O.value=m.value[2].value),H.value=m.value.reduce((n,i)=>n+i.value,0)}catch(r){console.error("Error loading my credit",r)}},ge=async()=>{try{const e=await(await fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})).json();if(!e.success)return;const t=Array.isArray(e.data)?e.data:e.data&&e.data.data||[];q.value=[{value:"",label:"Semua"},...t.map(a=>({value:a.id,label:a.nama_program||a.nama||a.title||""}))]}catch(r){console.error("Failed to load program options",r)}};xe(()=>{k&&clearTimeout(k),window.removeEventListener("penyaluran:changed",()=>{F(),N()}),window.removeEventListener("penyaluran:delete",()=>{})});const me=()=>{P()};let k=null;ke([w,h,y,v],()=>{k&&clearTimeout(k),k=setTimeout(()=>{P(!0)},300)});const fe=()=>{w.value="",h.value="",y.value="",v.value=""};return(r,e)=>(b(),De(Ve,null,{default:Ce(()=>[o("div",Me,[A.value.length>0?(b(),C("div",Se,[o("div",Ee,[(b(!0),C(_e,null,Ie(A.value,t=>(b(),C("div",{key:t.type,class:"rounded-lg border border-gray-200 bg-white p-4 flex flex-col sm:items-center"},[o("div",He,L(t.label),1),o("div",Ae,L(t.formatted),1)]))),128))])])):V("",!0),o("div",Be,[o("h3",Ge,L(K.value),1),o("div",Oe,[o("button",{onClick:de,class:"w-full sm:w-auto flex items-center justify-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...e[4]||(e[4]=[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M10.8333 3.33333V9.16667H16.6667L10.8333 3.33333ZM4.16667 2.5H11.6667L17.5 8.33333V15.8333C17.5 16.2754 17.3244 16.6993 17.0118 17.0118C16.6993 17.3244 16.2754 17.5 15.8333 17.5H4.16667C3.72464 17.5 3.30072 17.3244 2.98816 17.0118C2.67559 16.6993 2.5 16.2754 2.5 15.8333V4.16667C2.5 3.72464 2.67559 3.30072 2.98816 2.98816C3.30072 2.67559 3.72464 2.5 4.16667 2.5Z",fill:"currentColor"})],-1),$(" Export Excel ",-1)])]),Q.value?(b(),C("button",{key:0,onClick:le,class:"w-full sm:w-auto flex items-center justify-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600"},[...e[5]||(e[5]=[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M10 3.33333C10.4602 3.33333 10.8333 3.70643 10.8333 4.16667V9.16667H15.8333C16.2936 9.16667 16.6667 9.53976 16.6667 10C16.6667 10.4602 16.2936 10.8333 15.8333 10.8333H10.8333V15.8333C10.8333 16.2936 10.4602 16.6667 10 16.6667C9.53976 16.6667 9.16667 16.2936 9.16667 15.8333V10.8333H4.16667C3.70643 10.8333 3.33333 10.4602 3.33333 10C3.33333 9.53976 3.70643 9.16667 4.16667 9.16667H9.16667V4.16667C9.16667 3.70643 9.53976 3.33333 10 3.33333Z",fill:"currentColor"})],-1),$(" Tambah Penyaluran ",-1)])])):V("",!0)])]),o("div",qe,[o("div",Xe,[o("div",Ue,[e[6]||(e[6]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Nama Program ",-1)),D(W,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=t=>w.value=t),options:q.value,placeholder:"Cari program..."},null,8,["modelValue","options"])]),o("div",Ye,[e[7]||(e[7]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," PIC ",-1)),je(o("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=t=>h.value=t),placeholder:"Cari PIC...",class:"h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[Re,h.value]])]),o("div",$e,[e[8]||(e[8]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tanggal",-1)),o("div",ze,[D(z(Fe),{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=t=>y.value=t),config:te,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal"},null,8,["modelValue"])])]),o("div",We,[e[9]||(e[9]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tipe Penyaluran",-1)),D(W,{modelValue:v.value,"onUpdate:modelValue":e[3]||(e[3]=t=>v.value=t),options:X.value,placeholder:"Cari tipe..."},null,8,["modelValue","options"])])]),o("div",{class:"mt-4 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4"},[o("div",{class:"flex items-end col-span-1 md:col-span-2 lg:col-span-1"},[o("button",{onClick:fe,class:"h-11 w-full rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Reset Filter ")])])]),o("div",Je,[E.value?(b(),C("div",Ke,[...e[10]||(e[10]=[o("div",{class:"flex flex-col items-center gap-3"},[o("div",{class:"h-12 w-12 animate-spin rounded-full border-4 border-gray-200 border-t-brand-500"}),o("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Memuat data...")],-1)])])):V("",!0),o("div",Ze,[D(z(Pe),{ref_key:"agGridRef",ref:T,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:re,defaultColDef:ne,rowModelType:"infinite",datasource:Y.value,rowBuffer:10,cacheBlockSize:10,maxBlocksInCache:5,maxConcurrentDatasourceRequests:2,infiniteInitialRowCount:10,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!0,onSortChanged:me},null,8,["datasource"])])])]),D(Le,{isOpen:x.value,title:"Hapus Penyaluran",message:"Apakah Anda yakin ingin menghapus penyaluran ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ie,onCancel:ue},null,8,["isOpen"])]),_:1}))}});export{ia as default};
