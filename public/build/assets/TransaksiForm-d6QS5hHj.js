import{d as ea,H as ta,I as ra,M as na,b as u,A as C,e as sa,f as oa,Q as ia,B as S,g as la,o as N,w as da,a as n,t as B,q as $,i as _,j as w,m as h,k as K,v as O,c as G,u as ua}from"./admin-BP_1yT07.js";import{C as ca}from"./component-BwIB4S4C.js";import{_ as ma}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BLD4rzyM.js";import{S as M}from"./SearchableSelect-DUv_d-H1.js";import{A as ga}from"./AsyncSearchableSelect-36wsJRQJ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pa={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ba={class:"mb-6 flex items-center justify-between"},fa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ya={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ka={class:"relative"},ha={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},va=["value"];const xa={class:"flex items-center gap-3"},wa={class:"flex-1"},_a={class:"relative"},Ia={class:"lg:col-span-2"},Va={class:"flex items-center gap-3 mt-6 lg:justify-end"},ja=["disabled"],Ca=["disabled"],Sa={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ra=ea({__name:"TransaksiForm",setup(Na){const v=ta(),T=ra(),m=na(),c=u(null),I=C(()=>{var a,s,o;const r=(o=(s=(a=c.value)==null?void 0:a.role)==null?void 0:s.name)==null?void 0:o.toLowerCase();return r==="fundrising"||r==="fundraising"}),f=C(()=>v.params.id!==void 0&&v.params.id!=="new"),J=C(()=>f.value?"Edit Transaksi":"Tambah Transaksi"),A=u(!1),y=u(!1),z={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},D=u([]),H=u(new Map),F=u([]),U=u([]),p=u(null),x=u(null),V=u([]),E=u(""),R=u(""),j=u(""),e=sa({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),{fetchUser:q}=ia(),X=async()=>{try{const r=await fetch("/admin/api/user",{credentials:"same-origin"});if(r.ok){const a=await r.json();a.success&&a.user&&(c.value=a.user)}}catch(r){console.error("Error fetching current user:",r)}},Y=async()=>{try{const r=(()=>{if(!c.value)return!1;const t=c.value.roles||(c.value.role?[c.value.role]:[]);return Array.isArray(t)&&t.some(i=>{const d=typeof i=="string"?i:i==null?void 0:i.name;return typeof d=="string"&&d.trim().toLowerCase()==="admin cabang"})})(),s=!!(c.value&&c.value.is_admin)&&!r?"/admin/api/kantor-cabang?per_page=1000":"/admin/api/kantor-cabang?per_page=1000&only_assigned=1",[o,l]=await Promise.all([fetch(s,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(o.ok){const t=await o.json(),i=t.success&&t.data?Array.isArray(t.data)?t.data:t.data.data||[]:[];D.value=i.map(d=>({value:d.id,label:d.nama})),H.value=new Map(i.map(d=>[d.id,d]))}if(l.ok){const t=await l.json(),i=t.success&&t.data?Array.isArray(t.data)?t.data:t.data.data||[]:[];F.value=i.map(d=>({value:d.id,label:d.nama_program}))}try{const t=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(t.ok){const i=await t.json(),d=i.success&&i.data?Array.isArray(i.data)?i.data:i.data.data||[]:[];U.value=d.map(b=>({value:b.id,label:b.nama||b.name||""}))}}catch{}}catch(r){console.error("Error fetching options:",r),m.error("Gagal memuat data opsi")}},Q=async()=>{if(f.value&&v.params.id){A.value=!0;try{const r=v.params.id,a=await fetch(`/admin/api/transaksi/${r}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const s=await a.json();if(s.success&&s.data){const o=s.data;e.branchId=o.kantor_cabang_id||"",e.nominal=o.nominal,e.donorId=o.donatur_id||"",e.programId=o.program_id||"",e.mitraId=o.mitra_id||"",e.transactionDate=o.tanggal_transaksi||"",e.notes=o.keterangan||""}}catch(r){console.error("Error loading transaksi:",r),m.error("Gagal memuat data transaksi")}finally{A.value=!1}}},L=()=>{T.push("/keuangan/transaksi")},Z=()=>{e.mitraId=null,j.value=""},W=async()=>{var r;if(!e.branchId){m.warning("Kantor Cabang wajib diisi");return}if(!e.nominal||e.nominal<=0){m.warning("Nominal wajib diisi");return}if(!e.donorId){m.warning("Donatur wajib diisi");return}if(!e.programId){m.warning("Program wajib diisi");return}if(!e.transactionDate){m.warning("Tanggal transaksi wajib diisi");return}y.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const s=await a.json(),o={kantor_cabang_id:e.branchId,nominal:e.nominal,donatur_id:e.donorId,program_id:e.programId,mitra_id:e.mitraId||null,tanggal_transaksi:e.transactionDate,keterangan:e.notes||null};I.value&&((r=c.value)!=null&&r.id)&&(o.fundraiser_id=c.value.id);let l;f.value?l=await fetch(`/admin/api/transaksi/${v.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s.csrf_token},credentials:"same-origin",body:JSON.stringify(o)}):l=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s.csrf_token},credentials:"same-origin",body:JSON.stringify(o)});const t=await l.json();if(t.success)m.success(t.message||(f.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),T.push("/keuangan/transaksi");else if(t.errors){const i=Object.values(t.errors).flat().join(", ");m.error(i)}else m.error(t.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}finally{y.value=!1}};oa(async()=>{var r,a;await q(),await X(),await Y(),await Q(),I.value&&!f.value&&(a=(r=c.value)==null?void 0:r.kantor_cabang)!=null&&a.id&&(e.branchId=String(c.value.kantor_cabang.id))});const g=u(null),k=u(null);S(()=>e.donorId,async r=>{if(!r){p.value=null,e.fundraiserId="",g.value=null;return}if(g.value&&String(g.value)===String(r))return;p.value=null,e.fundraiserId="";const a=150;if(await new Promise(o=>setTimeout(o,a)),g.value&&String(g.value)===String(r))return;g.value=String(r);const s=new AbortController;k.value=s;try{const o=await fetch(`/admin/api/donatur/${r}`,{credentials:"same-origin",signal:s.signal});if(!o.ok){g.value=null,k.value=null;return}const l=await o.json();if(l.success&&l.data){const t=l.data;t.pic_user?(p.value={id:t.pic_user.id,name:t.pic_user.nama},e.fundraiserId=t.pic_user.id):t.pic&&(p.value={id:t.pic,name:""},e.fundraiserId=t.pic),t.mitra&&t.mitra.id?e.mitraId=String(t.mitra.id):t.mitra_id&&(e.mitraId=String(t.mitra_id))}}catch(o){o&&o.name==="AbortError"||(console.error("Failed to load donor details:",o),g.value=null)}finally{k.value=null}});const aa=r=>{if(!(!r||!r.id)){g.value=String(r.id);try{k.value&&k.value.abort()}catch{}k.value=null,r.pic_user?(p.value={id:r.pic_user.id,name:r.pic_user.nama},e.fundraiserId=r.pic_user.id):r.pic&&(p.value={id:r.pic,name:""},e.fundraiserId=r.pic),r.mitra&&r.mitra.id?e.mitraId=String(r.mitra.id):r.mitra_id&&(e.mitraId=String(r.mitra_id))}},P=()=>{V.value=[];const r=Number(e.nominal)||0;if(!x.value||!Array.isArray(x.value.shares))return;const a=o=>o?String(o).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"",s=o=>{if(o==null)return null;const l=Number(o);return Number.isNaN(l)?null:l};V.value=x.value.shares.map(o=>{const l=(o.type||"percentage")==="percentage",t=s(o.value),i=l&&t!==null?Math.round(Number(r*(t/100))):t!==null?Math.round(t):0,d=o.name||(o.program_share_type_key?a(o.program_share_type_key):"-");let b="-";return t!==null&&(l?b=Number.isInteger(t)?`${t}%`:`${parseFloat(String(t)).toFixed(2).replace(/\.00$/,"")}%`:b=Number(t).toLocaleString()),{name:d,type:o.type||"percentage",value:t,amount:i,displayValue:b}})};return S(()=>e.programId,async r=>{if(x.value=null,V.value=[],!!r)try{const a=await fetch(`/admin/api/program/${r}`,{credentials:"same-origin"});if(!a.ok)return;const s=await a.json();s.success&&s.data&&(x.value=s.data,P())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),S(()=>e.nominal,()=>{P()}),(r,a)=>(N(),la(ma,null,{default:da(()=>[n("div",pa,[n("div",ba,[n("h3",fa,B(J.value),1),n("button",{onClick:L,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),n("form",{onSubmit:$(W,["prevent"]),class:"flex flex-col"},[n("div",ya,[n("div",null,[a[11]||(a[11]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h(" Kantor Cabang "),n("span",{class:"text-red-500"},"*")],-1)),w(M,{modelValue:e.branchId,"onUpdate:modelValue":a[0]||(a[0]=s=>e.branchId=s),options:D.value,placeholder:"Kantor Cabang","search-input":E.value,"onUpdate:searchInput":a[1]||(a[1]=s=>E.value=s),disabled:I.value},null,8,["modelValue","options","search-input","disabled"])]),n("div",null,[a[12]||(a[12]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h(" Nominal "),n("span",{class:"text-red-500"},"*")],-1)),n("div",ka,[K(n("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=s=>e.nominal=s),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[O,e.nominal,void 0,{number:!0}]]),n("span",ha," RpÂ "+B(e.nominal?Number(e.nominal).toLocaleString():"0"),1)])]),n("div",null,[a[13]||(a[13]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h(" Donatur "),n("span",{class:"text-red-500"},"*")],-1)),w(ga,{modelValue:e.donorId,"onUpdate:modelValue":a[3]||(a[3]=s=>e.donorId=s),"fetch-url":"/admin/api/donatur",placeholder:"Donatur",onFetched:aa},null,8,["modelValue"])]),n("div",null,[a[14]||(a[14]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),n("input",{type:"text",value:p.value?p.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,va),_("",!0)]),n("div",null,[a[15]||(a[15]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h(" Program "),n("span",{class:"text-red-500"},"*")],-1)),w(M,{modelValue:e.programId,"onUpdate:modelValue":a[5]||(a[5]=s=>e.programId=s),options:F.value,placeholder:"Program","search-input":R.value,"onUpdate:searchInput":a[6]||(a[6]=s=>R.value=s)},null,8,["modelValue","options","search-input"])]),_("",!0),n("div",null,[a[19]||(a[19]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),n("div",xa,[n("div",wa,[w(M,{modelValue:e.mitraId,"onUpdate:modelValue":a[7]||(a[7]=s=>e.mitraId=s),options:U.value,placeholder:"Mitra (opsional)","search-input":j.value,"onUpdate:searchInput":a[8]||(a[8]=s=>j.value=s)},null,8,["modelValue","options","search-input"])]),e.mitraId?(N(),G("button",{key:0,type:"button",title:"Hapus Mitra",onClick:$(Z,["stop"]),class:"h-10 w-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"},[...a[18]||(a[18]=[n("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[n("path",{d:"M18 6L6 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),n("path",{d:"M6 6L18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):_("",!0)])]),n("div",null,[a[21]||(a[21]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h(" Tanggal Transaksi "),n("span",{class:"text-red-500"},"*")],-1)),n("div",_a,[w(ua(ca),{modelValue:e.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=s=>e.transactionDate=s),config:z,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[20]||(a[20]=n("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[n("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[n("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),n("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),n("div",Ia,[a[22]||(a[22]=n("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),K(n("textarea",{"onUpdate:modelValue":a[10]||(a[10]=s=>e.notes=s),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[O,e.notes]]),a[23]||(a[23]=n("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),n("div",Va,[n("button",{onClick:L,type:"button",disabled:y.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,ja),n("button",{type:"submit",disabled:y.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[y.value?(N(),G("svg",Sa,[...a[24]||(a[24]=[n("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),n("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):_("",!0),h(" "+B(y.value?"Menyimpan...":f.value?"Simpan Perubahan":"Simpan"),1)],8,Ca)])],32)])]),_:1}))}});export{Ra as default};
