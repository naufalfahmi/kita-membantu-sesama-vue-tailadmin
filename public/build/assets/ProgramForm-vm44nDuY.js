import{d as I,b as R,H as J,I as X,M as G,A as x,e as S,B as H,f as L,g as z,o as u,w as K,a,t as _,q as C,k,m as W,v as f,c as m,F as V,l as N,j as F,n as Q}from"./admin-DqRzH-Aq.js";import{_ as Y}from"./AdminLayout.vue_vue_type_script_setup_true_lang-DNLwJi85.js";import{S as U}from"./SearchableSelect-CkkP21wc.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ee={class:"mb-6 flex items-center justify-between"},ae={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},te={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},re={class:"lg:col-span-2"},se={class:"lg:col-span-2"},oe={class:"overflow-x-auto mt-2"},ne={class:"w-full table-auto border border-gray-200 dark:border-gray-800 rounded-md"},le={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},de={class:"px-4 py-3"},ie=["onUpdate:modelValue","placeholder"],ue={class:"px-4 py-3"},pe={class:"px-4 py-3"},ce={class:"flex items-center gap-2"},me=["onUpdate:modelValue"],ge={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},ye={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},he={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},be=["onUpdate:modelValue"],xe={class:"px-4 py-3"},_e={class:"px-4 py-3"},ke={class:"flex items-center gap-2"},fe=["onUpdate:modelValue"],ve={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},we={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},je=["onClick"],Te={class:"mt-2 text-xs text-gray-500 dark:text-gray-400"},Pe={class:"flex items-center gap-3 mt-6 lg:justify-end"},Re={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Se={class:"fixed right-6 bottom-6 z-50"},Ce=["title"],Ve={class:"text-lg font-semibold"},Be=I({__name:"ProgramForm",setup(Ne){R("");const h=J(),v=X(),p=G(),g=x(()=>h.params.id!==void 0&&h.params.id!=="new"),M=x(()=>g.value?"Edit Program":"Tambah Program"),r=S({nama_program:"",tipe_pembagian_marketing:"",jumlah_persentase:null,shares:{},customRows:[]}),b=R([]),c=S({}),j=[{value:"percentage",label:"Persentase"},{value:"nominal",label:"Nominal"}],y=x(()=>{let t=0;for(const s of Object.keys(r.shares)){const e=r.shares[s];e&&e.type==="percentage"&&e.value!==null&&!Number.isNaN(e.value)&&(t+=Number(e.value))}return t>0?parseFloat(t.toFixed(2)):0});H(()=>y.value,t=>{r.jumlah_persentase=t},{immediate:!0});const A=x(()=>{const t=Number(y.value||0);return Number.isInteger(t)?`${t}%`:t.toFixed(2)+"%"}),B=x(()=>Number(y.value||0)>100?"bg-red-500 hover:bg-red-600":"bg-brand-500 hover:bg-brand-600"),E=async()=>{try{const t=await fetch("/admin/api/program-share-types",{credentials:"same-origin"});if(!t.ok)return;const s=await t.json();if(s.success&&Array.isArray(s.data)){b.value=s.data.slice().sort((e,l)=>{const d=e.orders??0,i=l.orders??0;return d-i});for(const e of b.value)r.shares[e.key]||(r.shares[e.key]={type:e.default_type||"percentage",value:null,alias:e.alias||null}),c[e.key]===void 0&&(c[e.key]="");Array.isArray(r.customRows)||(r.customRows=[])}}catch(t){console.error("Failed to load program share types:",t)}},T=async()=>{var t;try{const s=(t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content");if(s)return s;const e=await fetch("/admin/api/csrf-token",{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Failed to get CSRF token: ${e.status}`);return(await e.json()).csrf_token||""}catch(s){return console.error("Failed to get CSRF token:",s),""}},O=()=>{const t=`custom_${Date.now()}`;r.customRows.push({key:t,name:"",type:"percentage",value:null}),c[t]=""},$=t=>{r.customRows.splice(t,1)},q=async()=>{var t;if(g.value&&h.params.id){const s=h.params.id;try{const e=await T(),d=await(await fetch(`/admin/api/program/${s}`,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":e},credentials:"same-origin"})).json();if(d.success&&d.data){const i=d.data;if(r.nama_program=i.nama_program||"",r.tipe_pembagian_marketing=i.tipe_pembagian_marketing||"",r.jumlah_persentase=i.jumlah_persentase?parseFloat(i.jumlah_persentase):null,Array.isArray(i.shares)){r.customRows=[];for(const o of i.shares){const n=o.program_share_type_key||(o.program_share_type_id?(t=b.value.find(w=>w.id===o.program_share_type_id))==null?void 0:t.key:null);if(n&&r.shares[n]!==void 0)r.shares[n]={type:o.type||"percentage",value:o.value!==null?parseFloat(o.value):null,alias:o.alias||null};else{const w=o.program_share_type_key||`custom_${Date.now()}_${Math.floor(Math.random()*1e3)}`;r.customRows.push({key:w,name:o.name||"",type:o.type||"percentage",value:o.value!==null?parseFloat(o.value):null}),c[w]=""}}}}else p.error("Gagal memuat data program"),v.push("/administrasi/program")}catch(e){console.error("Error loading data:",e),p.error("Terjadi kesalahan saat memuat data"),v.push("/administrasi/program")}}},P=()=>{v.push("/administrasi/program")},D=async()=>{if(!r.nama_program){p.error("Nama Program wajib diisi");return}try{const t=await T();if(!t){p.error("Gagal mendapatkan CSRF token. Silakan refresh halaman.");return}const s={nama_program:r.nama_program,tipe_pembagian_marketing:r.tipe_pembagian_marketing||null,jumlah_persentase:y.value||null,shares:[]};for(const o of b.value){const n=r.shares[o.key];s.shares.push({program_share_type_key:o.key,program_share_type_id:o.id,name:o.name,type:(n==null?void 0:n.type)||o.default_type||"percentage",value:(n==null?void 0:n.value)!==void 0?(n==null?void 0:n.value)??null:null,alias:(n==null?void 0:n.alias)||null,orders:o.orders??null})}for(const o of r.customRows)s.shares.push({program_share_type_key:o.key,program_share_type_id:null,name:o.name||null,type:o.type||"percentage",value:o.value!==void 0?o.value??null:null,is_custom:!0});const e=g.value?`/admin/api/program/${h.params.id}`:"/admin/api/program",l=g.value?"PUT":"POST",i=await(await fetch(e,{method:l,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":t},credentials:"same-origin",body:JSON.stringify(s)})).json();if(i.success)p.success(g.value?"Program berhasil diupdate":"Program berhasil ditambahkan"),v.push("/administrasi/program");else if(i.errors){const o=Object.values(i.errors).flat().join(", ");p.error(`Validasi gagal: ${o}`)}else p.error(i.message||"Gagal menyimpan data")}catch(t){console.error("Error saving:",t),p.error("Terjadi kesalahan saat menyimpan data")}};return L(async()=>{await E(),await q()}),(t,s)=>(u(),z(Y,null,{default:K(()=>[a("div",Z,[a("div",ee,[a("h3",ae,_(M.value),1),a("button",{onClick:P,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),a("form",{onSubmit:C(D,["prevent"]),class:"flex flex-col"},[a("div",te,[a("div",re,[s[1]||(s[1]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[W(" Nama Program "),a("span",{class:"text-red-500"},"*")],-1)),k(a("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=e=>r.nama_program=e),placeholder:"Masukkan nama program",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[f,r.nama_program]])]),a("div",se,[s[3]||(s[3]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Pembagian (DP, OPS 1, OPS 2, Program, Fee Mitra, Bonus, Championship) ",-1)),a("div",oe,[a("table",ne,[s[2]||(s[2]=a("thead",{class:"bg-gray-50 dark:bg-gray-900"},[a("tr",null,[a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nama"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Alias (Tipe Pengajuan)"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Tipe"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nilai")])],-1)),a("tbody",null,[(u(!0),m(V,null,N(b.value,e=>(u(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",le,_(e.name),1),a("td",de,[k(a("input",{type:"text","onUpdate:modelValue":l=>r.shares[e.key].alias=l,placeholder:e.alias||"Masukkan alias",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900 dark:border-gray-700 dark:text-gray-300"},null,8,ie),[[f,r.shares[e.key].alias]])]),a("td",ue,[F(U,{modelValue:r.shares[e.key].type,"onUpdate:modelValue":l=>r.shares[e.key].type=l,options:j,placeholder:"Pilih Tipe","search-input":c[e.key],"onUpdate:searchInput":l=>c[e.key]=l},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",pe,[a("div",ce,[k(a("input",{type:"number","onUpdate:modelValue":l=>r.shares[e.key].value=l,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,me),[[f,r.shares[e.key].value,void 0,{number:!0}]]),r.shares[e.key].type==="percentage"?(u(),m("span",ge,"%")):(u(),m("span",ye,"Rp"))])])]))),128)),(u(!0),m(V,null,N(r.customRows,(e,l)=>(u(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",he,[k(a("input",{"onUpdate:modelValue":d=>e.name=d,placeholder:"Nama",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm"},null,8,be),[[f,e.name]])]),a("td",xe,[F(U,{modelValue:e.type,"onUpdate:modelValue":d=>e.type=d,options:j,placeholder:"Pilih Tipe","search-input":c[e.key],"onUpdate:searchInput":d=>c[e.key]=d},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",_e,[a("div",ke,[k(a("input",{type:"number","onUpdate:modelValue":d=>e.value=d,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,fe),[[f,e.value,void 0,{number:!0}]]),e.type==="percentage"?(u(),m("span",ve,"%")):(u(),m("span",we,"Rp")),a("button",{type:"button",onClick:C(()=>$(l),["prevent"]),class:"text-red-500 ml-2"},"Hapus",8,je)])])]))),128))])])]),a("p",Te,'Jumlah Persentase (hanya menghitung yang tipe "Persentase"): '+_(y.value),1)])]),a("div",Pe,[a("div",{class:"flex-1 lg:flex lg:items-center lg:justify-start"},[a("button",{type:"button",onClick:O,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Tambah Baris ")]),a("button",{onClick:P,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"}," Batal "),a("button",Re,_(g.value?"Simpan Perubahan":"Simpan"),1)])],32)]),a("div",Se,[a("button",{title:y.value>100?"Jumlah persentase melebihi 100%":"Jumlah persentase",class:Q(["flex items-center gap-3 px-4 py-3 rounded-lg text-white shadow-lg",B.value])},[s[4]||(s[4]=a("span",{class:"text-sm"},"Jumlah Persentase",-1)),a("span",Ve,_(A.value),1)],10,Ce)])]),_:1}))}});export{Be as default};
