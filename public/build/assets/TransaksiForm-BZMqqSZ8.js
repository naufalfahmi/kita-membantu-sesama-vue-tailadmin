import{d as Y,H as q,I as Z,L as Q,b as u,A as C,e as W,f as aa,B as V,g as ea,o as v,w as ra,a as e,t as w,q as ta,c as _,i as N,j as I,m as f,k as L,v as $,F as na,l as sa,u as oa}from"./admin-DEqocgtn.js";import{C as la}from"./component-C5w81Nj9.js";import{_ as ia}from"./AdminLayout.vue_vue_type_script_setup_true_lang-D-1LN3ko.js";import{S}from"./SearchableSelect-DmLCsAQO.js";import{A as da}from"./AsyncSearchableSelect-B8hG926n.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ua={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ca={class:"mb-6 flex items-center justify-between"},ma={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ga={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},pa=["value"],ba={key:0,class:"lg:col-span-2"},fa={class:"overflow-x-auto rounded-lg border border-gray-300 bg-white dark:border-gray-700"},ya={class:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300"},ka={class:"px-4 py-2 align-top"},xa={class:"font-medium"},ha={class:"px-4 py-2 align-top text-gray-500 text-sm"},va={class:"px-4 py-2 align-top text-right font-medium"},wa={class:"relative"},Ia={class:"lg:col-span-2"},_a={class:"flex items-center gap-3 mt-6 lg:justify-end"},ja=["disabled"],Ca=["disabled"],Va={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ua=Y({__name:"TransaksiForm",setup(Na){const y=q(),T=Z(),m=Q(),c=u(null),j=C(()=>{var a,r,n;const o=(n=(r=(a=c.value)==null?void 0:a.role)==null?void 0:r.name)==null?void 0:n.toLowerCase();return o==="fundrising"||o==="fundraising"}),p=C(()=>y.params.id!==void 0&&y.params.id!=="new"),K=C(()=>p.value?"Edit Transaksi":"Tambah Transaksi"),A=u(!1),b=u(!1),O={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},D=u([]),G=u(new Map),M=u([]),F=u([]),k=u(null),x=u(null),h=u([]),U=u(""),B=u(""),R=u(""),t=W({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),J=async()=>{try{const o=await fetch("/admin/api/user",{credentials:"same-origin"});if(o.ok){const a=await o.json();a.success&&a.user&&(c.value=a.user)}}catch(o){console.error("Error fetching current user:",o)}},z=async()=>{try{const o=(()=>{if(!c.value)return!1;const s=c.value.roles||(c.value.role?[c.value.role]:[]);return Array.isArray(s)&&s.some(l=>{const i=typeof l=="string"?l:l==null?void 0:l.name;return typeof i=="string"&&i.trim().toLowerCase()==="admin cabang"})})(),r=!!(c.value&&c.value.is_admin)&&!o?"/admin/api/kantor-cabang?per_page=1000":"/admin/api/kantor-cabang?per_page=1000&only_assigned=1",[n,d]=await Promise.all([fetch(r,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(n.ok){const s=await n.json(),l=s.success&&s.data?Array.isArray(s.data)?s.data:s.data.data||[]:[];D.value=l.map(i=>({value:i.id,label:i.nama})),G.value=new Map(l.map(i=>[i.id,i]))}if(d.ok){const s=await d.json(),l=s.success&&s.data?Array.isArray(s.data)?s.data:s.data.data||[]:[];M.value=l.map(i=>({value:i.id,label:i.nama_program}))}try{const s=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(s.ok){const l=await s.json(),i=l.success&&l.data?Array.isArray(l.data)?l.data:l.data.data||[]:[];F.value=i.map(g=>({value:g.id,label:g.nama||g.name||""}))}}catch{}}catch(o){console.error("Error fetching options:",o),m.error("Gagal memuat data opsi")}},H=async()=>{if(p.value&&y.params.id){A.value=!0;try{const o=y.params.id,a=await fetch(`/admin/api/transaksi/${o}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const r=await a.json();if(r.success&&r.data){const n=r.data;t.branchId=n.kantor_cabang_id||"",t.nominal=n.nominal,t.donorId=n.donatur_id||"",t.programId=n.program_id||"",t.mitraId=n.mitra_id||"",t.transactionDate=n.tanggal_transaksi||"",t.notes=n.keterangan||""}}catch(o){console.error("Error loading transaksi:",o),m.error("Gagal memuat data transaksi")}finally{A.value=!1}}},E=()=>{T.push("/keuangan/transaksi")},X=async()=>{var o;if(!t.branchId){m.warning("Kantor Cabang wajib diisi");return}if(!t.nominal||t.nominal<=0){m.warning("Nominal wajib diisi");return}if(!t.donorId){m.warning("Donatur wajib diisi");return}if(!t.programId){m.warning("Program wajib diisi");return}if(!t.transactionDate){m.warning("Tanggal transaksi wajib diisi");return}b.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const r=await a.json(),n={kantor_cabang_id:t.branchId,nominal:t.nominal,donatur_id:t.donorId,program_id:t.programId,mitra_id:t.mitraId||null,tanggal_transaksi:t.transactionDate,keterangan:t.notes||null};j.value&&((o=c.value)!=null&&o.id)&&(n.fundraiser_id=c.value.id);let d;p.value?d=await fetch(`/admin/api/transaksi/${y.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r.csrf_token},credentials:"same-origin",body:JSON.stringify(n)}):d=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r.csrf_token},credentials:"same-origin",body:JSON.stringify(n)});const s=await d.json();if(s.success)m.success(s.message||(p.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),T.push("/keuangan/transaksi");else if(s.errors){const l=Object.values(s.errors).flat().join(", ");m.error(l)}else m.error(s.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}finally{b.value=!1}};aa(async()=>{var o,a;await J(),await z(),await H(),j.value&&!p.value&&(a=(o=c.value)==null?void 0:o.kantor_cabang)!=null&&a.id&&(t.branchId=String(c.value.kantor_cabang.id))}),V(()=>t.donorId,async o=>{if(k.value=null,t.fundraiserId="",!!o)try{const a=await fetch(`/admin/api/donatur/${o}`,{credentials:"same-origin"});if(!a.ok)return;const r=await a.json();if(r.success&&r.data){const n=r.data;n.pic_user?(k.value={id:n.pic_user.id,name:n.pic_user.nama},t.fundraiserId=n.pic_user.id):n.pic&&(k.value={id:n.pic,name:""},t.fundraiserId=n.pic)}}catch(a){console.error("Failed to load donor details:",a)}});const P=()=>{h.value=[];const o=Number(t.nominal)||0;if(!x.value||!Array.isArray(x.value.shares))return;const a=n=>n?String(n).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",r=n=>{if(n==null)return null;const d=Number(n);return Number.isNaN(d)?null:d};h.value=x.value.shares.map(n=>{const d=(n.type||"percentage")==="percentage",s=r(n.value),l=d&&s!==null?Math.round(Number(o*(s/100))):s!==null?Math.round(s):0,i=n.name||(n.program_share_type_key?a(n.program_share_type_key):"-");let g="-";return s!==null&&(d?g=Number.isInteger(s)?`${s}%`:`${parseFloat(String(s)).toFixed(2).replace(/\.00$/,"")}%`:g=Number(s).toLocaleString()),{name:i,type:n.type||"percentage",value:s,amount:l,displayValue:g}})};return V(()=>t.programId,async o=>{if(x.value=null,h.value=[],!!o)try{const a=await fetch(`/admin/api/program/${o}`,{credentials:"same-origin"});if(!a.ok)return;const r=await a.json();r.success&&r.data&&(x.value=r.data,P())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),V(()=>t.nominal,()=>{P()}),(o,a)=>(v(),ea(ia,null,{default:ra(()=>[e("div",ua,[e("div",ca,[e("h3",ma,w(K.value),1),e("button",{onClick:E,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),e("form",{onSubmit:ta(X,["prevent"]),class:"flex flex-col"},[e("div",ga,[e("div",null,[a[11]||(a[11]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Kantor Cabang "),e("span",{class:"text-red-500"},"*")],-1)),I(S,{modelValue:t.branchId,"onUpdate:modelValue":a[0]||(a[0]=r=>t.branchId=r),options:D.value,placeholder:"Kantor Cabang","search-input":U.value,"onUpdate:searchInput":a[1]||(a[1]=r=>U.value=r),disabled:j.value},null,8,["modelValue","options","search-input","disabled"])]),e("div",null,[a[12]||(a[12]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Nominal "),e("span",{class:"text-red-500"},"*")],-1)),L(e("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=r=>t.nominal=r),placeholder:"Nominal",min:"0",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,t.nominal,void 0,{number:!0}]])]),e("div",null,[a[13]||(a[13]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Donatur "),e("span",{class:"text-red-500"},"*")],-1)),I(da,{modelValue:t.donorId,"onUpdate:modelValue":a[3]||(a[3]=r=>t.donorId=r),"fetch-url":"/admin/api/donatur",placeholder:"Donatur"},null,8,["modelValue"])]),e("div",null,[a[14]||(a[14]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),e("input",{type:"text",value:k.value?k.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,pa),N("",!0)]),e("div",null,[a[15]||(a[15]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Program "),e("span",{class:"text-red-500"},"*")],-1)),I(S,{modelValue:t.programId,"onUpdate:modelValue":a[5]||(a[5]=r=>t.programId=r),options:M.value,placeholder:"Program","search-input":B.value,"onUpdate:searchInput":a[6]||(a[6]=r=>B.value=r)},null,8,["modelValue","options","search-input"])]),h.value.length>0?(v(),_("div",ba,[a[17]||(a[17]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rincian Pembagian Program",-1)),e("div",fa,[e("table",ya,[a[16]||(a[16]=e("thead",{class:"bg-gray-50 dark:bg-gray-800"},[e("tr",null,[e("th",{class:"px-4 py-2 font-medium"},"Nama"),e("th",{class:"px-4 py-2 font-medium"},"Nilai"),e("th",{class:"px-4 py-2 font-medium text-right"},"Jumlah (Rp)")])],-1)),e("tbody",null,[(v(!0),_(na,null,sa(h.value,(r,n)=>(v(),_("tr",{key:n,class:"border-t border-gray-100 dark:border-gray-800"},[e("td",ka,[e("div",xa,w(r.name),1)]),e("td",ha,w(r.displayValue),1),e("td",va,"Rp "+w(r.amount.toLocaleString()),1)]))),128))])])])])):N("",!0),e("div",null,[a[18]||(a[18]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),I(S,{modelValue:t.mitraId,"onUpdate:modelValue":a[7]||(a[7]=r=>t.mitraId=r),options:F.value,placeholder:"Mitra (opsional)","search-input":R.value,"onUpdate:searchInput":a[8]||(a[8]=r=>R.value=r)},null,8,["modelValue","options","search-input"])]),e("div",null,[a[20]||(a[20]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Tanggal Transaksi "),e("span",{class:"text-red-500"},"*")],-1)),e("div",wa,[I(oa(la),{modelValue:t.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=r=>t.transactionDate=r),config:O,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[19]||(a[19]=e("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[e("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),e("div",Ia,[a[21]||(a[21]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),L(e("textarea",{"onUpdate:modelValue":a[10]||(a[10]=r=>t.notes=r),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,t.notes]]),a[22]||(a[22]=e("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),e("div",_a,[e("button",{onClick:E,type:"button",disabled:b.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,ja),e("button",{type:"submit",disabled:b.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[b.value?(v(),_("svg",Va,[...a[23]||(a[23]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):N("",!0),f(" "+w(b.value?"Menyimpan...":p.value?"Simpan Perubahan":"Simpan"),1)],8,Ca)])],32)])]),_:1}))}});export{Ua as default};
