import{d as ea,H as ta,I as ra,M as na,b as u,A as T,e as sa,f as oa,Q as ia,B as A,g as la,o as h,w as da,a as e,t as v,q as K,c as j,i as S,j as C,m as x,k as O,v as G,F as ua,l as ca,u as ma}from"./admin-B6Wc5uUN.js";import{C as ga}from"./component-Co4M0wHD.js";import{_ as pa}from"./AdminLayout.vue_vue_type_script_setup_true_lang-CTK14auA.js";import{S as N}from"./SearchableSelect-CStqsW-P.js";import{A as ba}from"./AsyncSearchableSelect-CeZUdeHR.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const fa={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ya={class:"mb-6 flex items-center justify-between"},ka={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ha={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},va={class:"relative"},xa={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},wa=["value"],_a={key:0,class:"lg:col-span-2"},Ia={class:"overflow-x-auto rounded-lg border border-gray-300 bg-white dark:border-gray-700"},ja={class:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300"},Ca={class:"px-4 py-2 align-top"},Sa={class:"font-medium"},Va={class:"px-4 py-2 align-top text-gray-500 text-sm"},Ma={class:"px-4 py-2 align-top text-right font-medium"},Ta={class:"flex items-center gap-3"},Aa={class:"flex-1"},Na={class:"relative"},Fa={class:"lg:col-span-2"},Da={class:"flex items-center gap-3 mt-6 lg:justify-end"},Ua=["disabled"],Ba=["disabled"],Ra={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ja=ea({__name:"TransaksiForm",setup(Ea){const w=ta(),F=ra(),m=na(),c=u(null),V=T(()=>{var a,s,o;const n=(o=(s=(a=c.value)==null?void 0:a.role)==null?void 0:s.name)==null?void 0:o.toLowerCase();return n==="fundrising"||n==="fundraising"}),f=T(()=>w.params.id!==void 0&&w.params.id!=="new"),J=T(()=>f.value?"Edit Transaksi":"Tambah Transaksi"),D=u(!1),y=u(!1),z={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},U=u([]),H=u(new Map),B=u([]),R=u([]),p=u(null),_=u(null),I=u([]),E=u(""),L=u(""),M=u(""),t=sa({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),{fetchUser:q}=ia(),X=async()=>{try{const n=await fetch("/admin/api/user",{credentials:"same-origin"});if(n.ok){const a=await n.json();a.success&&a.user&&(c.value=a.user)}}catch(n){console.error("Error fetching current user:",n)}},Y=async()=>{try{const n=(()=>{if(!c.value)return!1;const r=c.value.roles||(c.value.role?[c.value.role]:[]);return Array.isArray(r)&&r.some(i=>{const d=typeof i=="string"?i:i==null?void 0:i.name;return typeof d=="string"&&d.trim().toLowerCase()==="admin cabang"})})(),s=!!(c.value&&c.value.is_admin)&&!n?"/admin/api/kantor-cabang?per_page=1000":"/admin/api/kantor-cabang?per_page=1000&only_assigned=1",[o,l]=await Promise.all([fetch(s,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(o.ok){const r=await o.json(),i=r.success&&r.data?Array.isArray(r.data)?r.data:r.data.data||[]:[];U.value=i.map(d=>({value:d.id,label:d.nama})),H.value=new Map(i.map(d=>[d.id,d]))}if(l.ok){const r=await l.json(),i=r.success&&r.data?Array.isArray(r.data)?r.data:r.data.data||[]:[];B.value=i.map(d=>({value:d.id,label:d.nama_program}))}try{const r=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(r.ok){const i=await r.json(),d=i.success&&i.data?Array.isArray(i.data)?i.data:i.data.data||[]:[];R.value=d.map(b=>({value:b.id,label:b.nama||b.name||""}))}}catch{}}catch(n){console.error("Error fetching options:",n),m.error("Gagal memuat data opsi")}},Q=async()=>{if(f.value&&w.params.id){D.value=!0;try{const n=w.params.id,a=await fetch(`/admin/api/transaksi/${n}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const s=await a.json();if(s.success&&s.data){const o=s.data;t.branchId=o.kantor_cabang_id||"",t.nominal=o.nominal,t.donorId=o.donatur_id||"",t.programId=o.program_id||"",t.mitraId=o.mitra_id||"",t.transactionDate=o.tanggal_transaksi||"",t.notes=o.keterangan||""}}catch(n){console.error("Error loading transaksi:",n),m.error("Gagal memuat data transaksi")}finally{D.value=!1}}},P=()=>{F.push("/keuangan/transaksi")},Z=()=>{t.mitraId=null,M.value=""},W=async()=>{var n;if(!t.branchId){m.warning("Kantor Cabang wajib diisi");return}if(!t.nominal||t.nominal<=0){m.warning("Nominal wajib diisi");return}if(!t.donorId){m.warning("Donatur wajib diisi");return}if(!t.programId){m.warning("Program wajib diisi");return}if(!t.transactionDate){m.warning("Tanggal transaksi wajib diisi");return}y.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const s=await a.json(),o={kantor_cabang_id:t.branchId,nominal:t.nominal,donatur_id:t.donorId,program_id:t.programId,mitra_id:t.mitraId||null,tanggal_transaksi:t.transactionDate,keterangan:t.notes||null};V.value&&((n=c.value)!=null&&n.id)&&(o.fundraiser_id=c.value.id);let l;f.value?l=await fetch(`/admin/api/transaksi/${w.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s.csrf_token},credentials:"same-origin",body:JSON.stringify(o)}):l=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":s.csrf_token},credentials:"same-origin",body:JSON.stringify(o)});const r=await l.json();if(r.success)m.success(r.message||(f.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),F.push("/keuangan/transaksi");else if(r.errors){const i=Object.values(r.errors).flat().join(", ");m.error(i)}else m.error(r.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}finally{y.value=!1}};oa(async()=>{var n,a;await q(),await X(),await Y(),await Q(),V.value&&!f.value&&(a=(n=c.value)==null?void 0:n.kantor_cabang)!=null&&a.id&&(t.branchId=String(c.value.kantor_cabang.id))});const g=u(null),k=u(null);A(()=>t.donorId,async n=>{if(!n){p.value=null,t.fundraiserId="",g.value=null;return}if(g.value&&String(g.value)===String(n))return;p.value=null,t.fundraiserId="";const a=150;if(await new Promise(o=>setTimeout(o,a)),g.value&&String(g.value)===String(n))return;g.value=String(n);const s=new AbortController;k.value=s;try{const o=await fetch(`/admin/api/donatur/${n}`,{credentials:"same-origin",signal:s.signal});if(!o.ok){g.value=null,k.value=null;return}const l=await o.json();if(l.success&&l.data){const r=l.data;r.pic_user?(p.value={id:r.pic_user.id,name:r.pic_user.nama},t.fundraiserId=r.pic_user.id):r.pic&&(p.value={id:r.pic,name:""},t.fundraiserId=r.pic),r.mitra&&r.mitra.id?t.mitraId=String(r.mitra.id):r.mitra_id&&(t.mitraId=String(r.mitra_id))}}catch(o){o&&o.name==="AbortError"||(console.error("Failed to load donor details:",o),g.value=null)}finally{k.value=null}});const aa=n=>{if(!(!n||!n.id)){g.value=String(n.id);try{k.value&&k.value.abort()}catch{}k.value=null,n.pic_user?(p.value={id:n.pic_user.id,name:n.pic_user.nama},t.fundraiserId=n.pic_user.id):n.pic&&(p.value={id:n.pic,name:""},t.fundraiserId=n.pic),n.mitra&&n.mitra.id?t.mitraId=String(n.mitra.id):n.mitra_id&&(t.mitraId=String(n.mitra_id))}},$=()=>{I.value=[];const n=Number(t.nominal)||0;if(!_.value||!Array.isArray(_.value.shares))return;const a=o=>o?String(o).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(r=>r.charAt(0).toUpperCase()+r.slice(1)).join(" "):"",s=o=>{if(o==null)return null;const l=Number(o);return Number.isNaN(l)?null:l};I.value=_.value.shares.map(o=>{const l=(o.type||"percentage")==="percentage",r=s(o.value),i=l&&r!==null?Math.round(Number(n*(r/100))):r!==null?Math.round(r):0,d=o.name||(o.program_share_type_key?a(o.program_share_type_key):"-");let b="-";return r!==null&&(l?b=Number.isInteger(r)?`${r}%`:`${parseFloat(String(r)).toFixed(2).replace(/\.00$/,"")}%`:b=Number(r).toLocaleString()),{name:d,type:o.type||"percentage",value:r,amount:i,displayValue:b}})};return A(()=>t.programId,async n=>{if(_.value=null,I.value=[],!!n)try{const a=await fetch(`/admin/api/program/${n}`,{credentials:"same-origin"});if(!a.ok)return;const s=await a.json();s.success&&s.data&&(_.value=s.data,$())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),A(()=>t.nominal,()=>{$()}),(n,a)=>(h(),la(pa,null,{default:da(()=>[e("div",fa,[e("div",ya,[e("h3",ka,v(J.value),1),e("button",{onClick:P,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),e("form",{onSubmit:K(W,["prevent"]),class:"flex flex-col"},[e("div",ha,[e("div",null,[a[11]||(a[11]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[x(" Kantor Cabang "),e("span",{class:"text-red-500"},"*")],-1)),C(N,{modelValue:t.branchId,"onUpdate:modelValue":a[0]||(a[0]=s=>t.branchId=s),options:U.value,placeholder:"Kantor Cabang","search-input":E.value,"onUpdate:searchInput":a[1]||(a[1]=s=>E.value=s),disabled:V.value},null,8,["modelValue","options","search-input","disabled"])]),e("div",null,[a[12]||(a[12]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[x(" Nominal "),e("span",{class:"text-red-500"},"*")],-1)),e("div",va,[O(e("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=s=>t.nominal=s),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[G,t.nominal,void 0,{number:!0}]]),e("span",xa," RpÂ "+v(t.nominal?Number(t.nominal).toLocaleString():"0"),1)])]),e("div",null,[a[13]||(a[13]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[x(" Donatur "),e("span",{class:"text-red-500"},"*")],-1)),C(ba,{modelValue:t.donorId,"onUpdate:modelValue":a[3]||(a[3]=s=>t.donorId=s),"fetch-url":"/admin/api/donatur",placeholder:"Donatur",onFetched:aa},null,8,["modelValue"])]),e("div",null,[a[14]||(a[14]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),e("input",{type:"text",value:p.value?p.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,wa),S("",!0)]),e("div",null,[a[15]||(a[15]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[x(" Program "),e("span",{class:"text-red-500"},"*")],-1)),C(N,{modelValue:t.programId,"onUpdate:modelValue":a[5]||(a[5]=s=>t.programId=s),options:B.value,placeholder:"Program","search-input":L.value,"onUpdate:searchInput":a[6]||(a[6]=s=>L.value=s)},null,8,["modelValue","options","search-input"])]),I.value.length>0?(h(),j("div",_a,[a[17]||(a[17]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rincian Pembagian Program",-1)),e("div",Ia,[e("table",ja,[a[16]||(a[16]=e("thead",{class:"bg-gray-50 dark:bg-gray-800"},[e("tr",null,[e("th",{class:"px-4 py-2 font-medium"},"Nama"),e("th",{class:"px-4 py-2 font-medium"},"Nilai"),e("th",{class:"px-4 py-2 font-medium text-right"},"Jumlah (Rp)")])],-1)),e("tbody",null,[(h(!0),j(ua,null,ca(I.value,(s,o)=>(h(),j("tr",{key:o,class:"border-t border-gray-100 dark:border-gray-800"},[e("td",Ca,[e("div",Sa,v(s.name),1)]),e("td",Va,v(s.displayValue),1),e("td",Ma,"Rp "+v(s.amount.toLocaleString()),1)]))),128))])])])])):S("",!0),e("div",null,[a[19]||(a[19]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),e("div",Ta,[e("div",Aa,[C(N,{modelValue:t.mitraId,"onUpdate:modelValue":a[7]||(a[7]=s=>t.mitraId=s),options:R.value,placeholder:"Mitra (opsional)","search-input":M.value,"onUpdate:searchInput":a[8]||(a[8]=s=>M.value=s)},null,8,["modelValue","options","search-input"])]),t.mitraId?(h(),j("button",{key:0,type:"button",title:"Hapus Mitra",onClick:K(Z,["stop"]),class:"h-10 w-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"},[...a[18]||(a[18]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M18 6L6 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M6 6L18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):S("",!0)])]),e("div",null,[a[21]||(a[21]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[x(" Tanggal Transaksi "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Na,[C(ma(ga),{modelValue:t.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=s=>t.transactionDate=s),config:z,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[20]||(a[20]=e("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[e("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),e("div",Fa,[a[22]||(a[22]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),O(e("textarea",{"onUpdate:modelValue":a[10]||(a[10]=s=>t.notes=s),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[G,t.notes]]),a[23]||(a[23]=e("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),e("div",Da,[e("button",{onClick:P,type:"button",disabled:y.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,Ua),e("button",{type:"submit",disabled:y.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[y.value?(h(),j("svg",Ra,[...a[24]||(a[24]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):S("",!0),x(" "+v(y.value?"Menyimpan...":f.value?"Simpan Perubahan":"Simpan"),1)],8,Ba)])],32)])]),_:1}))}});export{Ja as default};
