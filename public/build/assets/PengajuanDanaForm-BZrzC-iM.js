import{d as J,H as z,I as Q,L as Z,A as h,b as m,e as aa,B as ta,f as ea,g as ra,o as p,w as na,a as e,t as u,q as sa,c,i as T,j as y,m as b,k as P,v as V,u as oa,P as la}from"./admin-DPb09sp5.js";import{C as ia}from"./component-CLnskTqi.js";import{_ as da,g as ua}from"./AdminLayout.vue_vue_type_script_setup_true_lang-DXgEc8ab.js";import{S as w}from"./SearchableSelect-BaFbXQPj.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ma={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ga={class:"mb-6 flex items-center justify-between"},pa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ca={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ba={class:"lg:col-span-1"},fa={class:"lg:col-span-1"},xa={key:0,class:"lg:col-span-1"},ya={key:0,class:"mt-2 text-sm text-gray-500"},va={key:1,class:"mt-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-900/40"},ka={class:"flex items-center justify-between"},ha={class:"text-xs text-gray-500"},wa={class:"text-lg font-medium"},ja={class:"text-right text-xs text-gray-500"},Sa={class:"mt-3 flex items-center justify-between"},_a={class:"flex items-center gap-3"},Ia={class:"mt-3 text-sm text-gray-700"},Da={class:"font-medium"},Ta={key:0,class:"mt-1 text-xs text-red-500"},Pa={class:"lg:col-span-1"},Va={key:0,class:"h-11 flex items-center rounded-lg border border-gray-300 bg-transparent px-4 text-sm text-gray-700 dark:border-gray-700 dark:text-gray-400"},Ca={key:1,class:"space-y-2"},Fa={class:"flex items-center gap-3"},Aa={key:2},Na={class:"lg:col-span-1"},Ra={class:"relative"},Ua={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},Ma={class:"lg:col-span-1"},Ea={class:"relative"},qa={class:"lg:col-span-2"},La={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},Ba={class:"lg:col-span-2"},Oa={class:"flex items-center gap-3 mt-6 lg:justify-end"},Xa={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Ja=J({__name:"PengajuanDanaForm",setup($a){const j=z(),C=Q(),d=Z(),{fetchUser:U}=la(),g=h(()=>j.params.id!==void 0&&j.params.id!=="new"),M=h(()=>g.value?"Edit Pengajuan Dana":"Tambah Pengajuan Dana"),E={dateFormat:"Y-m-d",altInput:!0,altFormat:"d F Y",locale:"id",wrap:!0,clickOpens:!0,allowInput:!1,minDate:"today"},v=m([]),q=[{value:"operasional",label:"Operasional"},{value:"program",label:"Program"},{value:"kegiatan",label:"Kegiatan"},{value:"pengembangan",label:"Pengembangan"},{value:"darurat",label:"Darurat"},{value:"lainnya",label:"Lainnya"}],S=m([]),_=m([]),F=m(""),A=m(""),N=m(""),k=m(""),t=aa({applicant:"",submissionType:"",status:"Draft",programId:"",amount:null,usedAt:"",purpose:"",branchId:""}),L=h(()=>!t.amount||t.amount<=0?"":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(t.amount)),l=m(null),I=m(!1);let D=null;const f=s=>!s||s<=0?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),B=s=>{if(!s)return"";try{const a=String(s).split("-");if(a.length<2)return s;const r=Number(a[0]),n=Number(a[1])-1,o=new Date(Date.UTC(r,n,1));return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(o)}catch{return s}},O=async()=>{if(!t.programId||!t.usedAt){l.value=null;return}I.value=!0;try{const s=new Date(t.usedAt);if(isNaN(s.getTime())){l.value=null,transaksiList.value=[],I.value=!1;return}const a=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,n=await(await fetch(`/admin/api/program/${t.programId}/balance?month=${a}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load balance");if(l.value=n.data,!g.value){const o=Number(n.data.remaining||0);o>0&&(!t.amount||t.amount<=0)&&(t.amount=o)}}catch(s){console.error("Error loading program balance",s),d.error("Gagal memuat saldo program"),l.value=null}finally{I.value=!1}};ta([()=>t.programId,()=>t.usedAt],()=>{D&&window.clearTimeout(D),D=window.setTimeout(()=>{O()},300)});const X=s=>{const a=s.target,r=parseFloat(a.value);isNaN(r)||r<0?t.amount=null:t.amount=Math.floor(r)},$=async()=>{if(!g.value)return;const s=j.params.id;try{const r=await(await fetch(`/admin/api/pengajuan-dana/${s}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load");const n=r.data;if(t.applicant=n.fundraiser?String(n.fundraiser.id):"",t.status=n.status||"Draft",n.fundraiser&&!v.value.find(o=>o.value===String(n.fundraiser.id))&&v.value.unshift({value:String(n.fundraiser.id),label:n.fundraiser.name||n.fundraiser.nama||""}),t.submissionType=n.submission_type,t.amount=n.amount,t.usedAt=n.used_at,t.purpose=n.purpose,t.branchId=n.kantor_cabang?n.kantor_cabang.id:"",t.programId=n.program?String(n.program.id):"",n.kantor_cabang&&!S.value.find(o=>o.value===String(n.kantor_cabang.id))&&S.value.unshift({value:String(n.kantor_cabang.id),label:n.kantor_cabang.nama||""}),n.program&&!_.value.find(o=>o.value===String(n.program.id))){const o=n.program.nama_program||n.program.nama||"";_.value.unshift({value:String(n.program.id),label:o})}}catch(a){console.error("Error loading data:",a),d.error("Gagal memuat data pengajuan dana")}},H=async()=>{try{const s=await U();k.value=s!=null&&s.id?String(s.id):"";const r=await(await fetch("/admin/api/pengajuan-dana/options",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load options");const n=r.data.users||[];v.value=n.map(i=>({value:String(i.id),label:i.name}));const o=r.data.kantor_cabangs||[];S.value=o.map(i=>({value:String(i.id),label:i.nama}));const x=r.data.programs||[];_.value=x.map(i=>({value:String(i.id),label:i.nama})),k.value&&v.value.find(Y=>Y.value===String(k.value))&&!t.applicant&&(t.applicant=String(k.value)),g.value&&r.data&&r.data.current&&r.data.current.program&&(t.programId=String(r.data.current.program.id))}catch(s){console.error("Error loading options",s),d.error("Gagal memuat opsi form")}},K=[{value:"Draft",label:"Draft"},{value:"Pending",label:"Diajukan"}];h(()=>String(t.applicant)===String(k.value));const G=h(()=>K),R=()=>C.push("/keuangan/pengajuan-dana"),W=async()=>{if(!t.applicant){d.error("Pengaju wajib diisi");return}if(!t.submissionType){d.error("Tipe Pengajuan wajib diisi");return}if(!t.amount||t.amount<=0){d.error("Nominal wajib diisi dan harus lebih dari 0");return}if(!t.usedAt){d.error("Tanggal Digunakan wajib diisi");return}if(!t.branchId){d.error("Kantor Cabang wajib diisi");return}try{const s={fundraiser_id:t.applicant,submission_type:t.submissionType,program_id:t.programId||null,status:t.status,amount:t.amount,used_at:t.usedAt,purpose:t.purpose,kantor_cabang_id:t.branchId},a=await ua(),r=g.value?`/admin/api/pengajuan-dana/${j.params.id}`:"/admin/api/pengajuan-dana",n=g.value?"PUT":"POST",x=await(await fetch(r,{method:n,credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s)})).json();if(!x.success){if(x.errors){const i=Object.values(x.errors)[0];d.error(i?String(i[0]):"Validation failed");return}throw new Error(x.message||"Failed to save")}d.success(g.value?"Pengajuan dana berhasil diupdate":"Pengajuan dana berhasil ditambahkan"),C.push("/keuangan/pengajuan-dana")}catch(s){console.error("Error saving:",s),d.error("Terjadi kesalahan saat menyimpan data")}};return ea(async()=>{await H(),await $()}),(s,a)=>(p(),ra(da,null,{default:na(()=>[e("div",ma,[e("div",ga,[e("h3",pa,u(M.value),1),e("button",{onClick:R,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"},"Batal")]),e("form",{onSubmit:sa(W,["prevent"]),class:"flex flex-col"},[e("div",ca,[e("div",ba,[a[15]||(a[15]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Pengaju "),e("span",{class:"text-red-500"},"*")],-1)),y(w,{modelValue:t.applicant,"onUpdate:modelValue":a[0]||(a[0]=r=>t.applicant=r),options:v.value,placeholder:"Pilih atau cari pengaju","search-input":F.value,"onUpdate:searchInput":a[1]||(a[1]=r=>F.value=r)},null,8,["modelValue","options","search-input"])]),e("div",fa,[a[16]||(a[16]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tipe Pengajuan "),e("span",{class:"text-red-500"},"*")],-1)),y(w,{modelValue:t.submissionType,"onUpdate:modelValue":a[2]||(a[2]=r=>t.submissionType=r),options:q,placeholder:"Pilih tipe pengajuan","search-input":A.value,"onUpdate:searchInput":a[3]||(a[3]=r=>A.value=r)},null,8,["modelValue","search-input"])]),t.submissionType==="program"?(p(),c("div",xa,[a[19]||(a[19]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Program",-1)),y(w,{modelValue:t.programId,"onUpdate:modelValue":a[4]||(a[4]=r=>t.programId=r),options:_.value,placeholder:"Pilih program"},null,8,["modelValue","options"]),I.value?(p(),c("div",ya,"Memuat saldo...")):l.value?(p(),c("div",va,[e("div",ka,[e("div",null,[e("div",ha,"Sisa alokasi bulan "+u(B(l.value.month)),1),e("div",wa,u(f(l.value.remaining)),1)]),e("div",ja,[e("div",null,"Inflow: "+u(f(l.value.inflow)),1),e("div",null,"Dialokasikan: "+u(f(l.value.allocated)),1),e("div",null,"Terpakai: "+u(f(l.value.outflow)),1)])]),e("div",Sa,[a[17]||(a[17]=e("div",{class:"text-sm text-gray-600"},"Opsi:",-1)),e("div",_a,[e("button",{type:"button",onClick:a[5]||(a[5]=()=>{t.amount=l.value.remaining}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Gunakan Seluruh Alokasi")])]),e("div",Ia,[e("div",null,[a[18]||(a[18]=b("Estimasi sisa setelah pengajuan: ",-1)),e("span",Da,u(f((l.value.remaining||0)-(t.amount||0))),1)]),(t.amount||0)>(l.value.remaining||0)?(p(),c("div",Ta,"Kekurangan: "+u(f((t.amount||0)-(l.value.remaining||0))),1)):T("",!0)])])):T("",!0)])):T("",!0),e("div",Pa,[a[22]||(a[22]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Status "),e("span",{class:"text-red-500"},"*")],-1)),t.status==="Approved"?(p(),c("div",Va,[a[20]||(a[20]=e("span",{class:"flex-1"},"Disetujui",-1)),P(e("input",{type:"hidden","onUpdate:modelValue":a[6]||(a[6]=r=>t.status=r)},null,512),[[V,t.status]])])):t.status==="Rejected"?(p(),c("div",Ca,[a[21]||(a[21]=e("div",{class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/10 dark:text-red-300"},[e("div",{class:"font-medium"},"Pengajuan ditolak"),e("div",{class:"text-xs"},"Anda dapat mengajukan ulang jika diperlukan.")],-1)),e("div",Fa,[e("button",{type:"button",onClick:a[7]||(a[7]=()=>{t.status="Pending"}),class:"rounded bg-brand-500 px-3 py-1 text-sm text-white"},"Ajukan lagi"),e("button",{type:"button",onClick:a[8]||(a[8]=()=>{t.status="Draft"}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Simpan sebagai Draft")])])):(p(),c("div",Aa,[y(w,{modelValue:t.status,"onUpdate:modelValue":a[9]||(a[9]=r=>t.status=r),options:G.value,placeholder:"Pilih status"},null,8,["modelValue","options"])]))]),e("div",Na,[a[23]||(a[23]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Nominal "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Ra,[P(e("input",{type:"number","onUpdate:modelValue":a[10]||(a[10]=r=>t.amount=r),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",onInput:X},null,544),[[V,t.amount,void 0,{number:!0}]]),e("span",Ua,u(L.value),1)]),a[24]||(a[24]=e("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"Minimal nominal: Rp 1",-1))]),e("div",Ma,[a[25]||(a[25]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tanggal Digunakan "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Ea,[y(oa(ia),{modelValue:t.usedAt,"onUpdate:modelValue":a[11]||(a[11]=r=>t.usedAt=r),config:E,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih tanggal digunakan",required:""},null,8,["modelValue"])])]),e("div",qa,[a[26]||(a[26]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tujuan Pengajuan",-1)),P(e("textarea",{"onUpdate:modelValue":a[12]||(a[12]=r=>t.purpose=r),placeholder:"Masukkan tujuan atau alasan pengajuan dana",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[V,t.purpose]]),e("p",La,u(t.purpose.length)+"/1000 karakter",1)]),e("div",Ba,[a[27]||(a[27]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Kantor Cabang "),e("span",{class:"text-red-500"},"*")],-1)),y(w,{modelValue:t.branchId,"onUpdate:modelValue":a[13]||(a[13]=r=>t.branchId=r),options:S.value,placeholder:"Pilih atau cari kantor cabang","search-input":N.value,"onUpdate:searchInput":a[14]||(a[14]=r=>N.value=r)},null,8,["modelValue","options","search-input"])])]),e("div",Oa,[e("button",{onClick:R,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"},"Batal"),e("button",Xa,u(g.value?"Simpan Perubahan":"Simpan"),1)])],32)])]),_:1}))}});export{Ja as default};
