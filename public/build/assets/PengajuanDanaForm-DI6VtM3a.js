import{d as na,H as oa,I as ia,L as la,A as x,b,e as B,B as O,f as H,g as da,o as d,w as ua,a as r,t as u,q as ma,c as m,i as S,j as w,m as h,k as N,v as F,u as ga,F as pa,l as ca,n as ba,P as ya}from"./admin-BUagPRHd.js";import{C as fa}from"./component-D8m1C--X.js";import{_ as va,g as xa}from"./AdminLayout.vue_vue_type_script_setup_true_lang-qyT8IsTA.js";import{S as I}from"./SearchableSelect-WB4z4tOw.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ha={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ka={class:"mb-6 flex items-center justify-between"},wa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},_a={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ja={class:"lg:col-span-1"},Sa={class:"lg:col-span-1"},Ia={key:0,class:"lg:col-span-1"},Ta={class:"lg:col-span-1"},Da={key:0,class:"h-11 flex items-center rounded-lg border border-gray-300 bg-transparent px-4 text-sm text-gray-700 dark:border-gray-700 dark:text-gray-400"},Pa={key:1,class:"space-y-2"},Va={class:"flex items-center gap-3"},Aa={key:2},Ca={class:"lg:col-span-1"},Na={class:"relative"},Fa={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},Ra={key:0,class:"mt-1 text-xs text-red-500"},Ea={key:1,class:"mt-1 text-xs text-red-500"},Ua={class:"lg:col-span-1"},Ma={class:"relative"},qa={class:"lg:col-span-2"},La={key:1,class:"lg:col-span-2"},Xa={class:"mt-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-900/40"},$a={class:"flex items-center justify-between"},Ba={class:"text-lg font-medium"},Oa={class:"text-right text-xs text-gray-500"},Ha={key:0},Ka={class:"flex flex-wrap justify-end gap-2"},Ga={key:0},Wa={key:1},Ya={key:1,class:"text-xs"},za={key:0,class:"mt-3 border-t pt-3"},Ja={class:"flex items-center justify-between"},Qa={class:"text-xs text-gray-500"},Za={class:"text-lg font-medium"},ae={class:"text-right text-xs text-gray-500"},ee={class:"mt-3 flex items-center justify-between"},te={class:"flex items-center gap-3"},re={class:"mt-3 text-sm text-gray-700"},se={class:"font-medium"},ne={key:0,class:"mt-1 text-xs text-red-500"},oe={class:"lg:col-span-2"},ie={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},le={class:"flex items-center gap-3 mt-6 lg:justify-end"},de=["disabled"],ye=na({__name:"PengajuanDanaForm",setup(ue){const T=oa(),R=ia(),g=la(),{fetchUser:K}=ya(),f=x(()=>T.params.id!==void 0&&T.params.id!=="new"),G=x(()=>f.value?"Edit Pengajuan Dana":"Tambah Pengajuan Dana"),W={dateFormat:"Y-m-d",altInput:!0,altFormat:"d F Y",locale:"id",wrap:!0,clickOpens:!0,allowInput:!1,minDate:"today"},_=b([]),Y=[{value:"program",label:"Program"},{value:"operasional",label:"Operasional"},{value:"gaji karyawan",label:"Gaji Karyawan"}],D=b([]),P=b([]),E=b(""),U=b(""),M=b(""),j=b(""),e=B({applicant:"",submissionType:"",status:"Draft",programId:"",amount:null,usedAt:"",purpose:"",branchId:""}),q=B({amount:""}),v=b(!1),V=x(()=>{if(!(e.submissionType==="program"||e.submissionType==="operasional")||!o||!o.value)return!1;const s=Number(o.value.remaining||0);return Number(e.amount||0)>s}),z=x(()=>!e.amount||e.amount<=0?"":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e.amount)),o=b(null),p=b(null),A=b(!1);let C=null;const y=s=>!s||s<=0?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),J=s=>{if(!s)return"";try{const a=String(s).split("-");if(a.length<2)return s;const n=Number(a[0]),t=Number(a[1])-1,i=new Date(Date.UTC(n,t,1));return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(i)}catch{return s}},Q=x(()=>{if(!p.value||!Array.isArray(p.value.shares))return[];const s=String(e.submissionType||"");let a="program";s==="operasional"?a="ops_2":s==="gaji karyawan"&&(a="ops_1");const n=p.value.shares.map(c=>{var l;return{...c,program_share_type_key:c.program_share_type_key??c.type_key??((l=c.type)==null?void 0:l.key)??null}}),t=n.filter(c=>String(c.program_share_type_key)===a);if(t.length>0)return t;const i=n.filter(c=>String(c.program_share_type_key)==="program");return i.length>0?i:n}),L=async()=>{if(!e.programId||!e.usedAt){o.value=null;return}A.value=!0;try{const s=new Date(e.usedAt);if(isNaN(s.getTime())){o.value=null,A.value=!1;return}const a=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`;let n="program";String(e.submissionType)==="operasional"&&(n="ops_2"),String(e.submissionType)==="gaji karyawan"&&(n="ops_1");const i=await(await fetch(`/admin/api/program/${e.programId}/balance?month=${a}&share_key=${encodeURIComponent(n)}&lookback=1`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!i.success)throw new Error(i.message||"Failed to load balance");o.value=i.data}catch(s){console.error("Error loading program balance",s),g.error("Gagal memuat saldo program"),o.value=null}finally{A.value=!1}},X=async()=>{if(!e.programId){p.value=null;return}try{const a=await(await fetch(`/admin/api/program/${e.programId}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!a.success)throw new Error(a.message||"Failed to load program");p.value=a.data}catch(s){console.error("Error loading program detail",s),p.value=null}};O([()=>e.programId,()=>e.usedAt],()=>{C&&window.clearTimeout(C),C=window.setTimeout(()=>{X(),L()},300)}),O(()=>e.submissionType,s=>{const a=String(s);a==="program"&&!f.value&&(e.amount=null),["program","operasional","gaji karyawan"].includes(a)&&e.programId?(X(),L()):(p.value=null,o.value=null)});const Z=s=>{const a=s.target,n=parseFloat(a.value);isNaN(n)||n<0?e.amount=null:e.amount=Math.floor(n)},aa=async()=>{if(!f.value)return;const s=T.params.id;try{const n=await(await fetch(`/admin/api/pengajuan-dana/${s}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load");const t=n.data;if(e.applicant=t.fundraiser?String(t.fundraiser.id):"",e.status=t.status||"Draft",t.fundraiser&&!_.value.find(i=>i.value===String(t.fundraiser.id))&&_.value.unshift({value:String(t.fundraiser.id),label:t.fundraiser.name||t.fundraiser.nama||""}),e.submissionType=t.submission_type,e.amount=t.amount,e.usedAt=t.used_at,e.purpose=t.purpose||"",e.branchId=t.kantor_cabang?t.kantor_cabang.id:"",e.programId=t.program?String(t.program.id):"",t.kantor_cabang&&!D.value.find(i=>i.value===String(t.kantor_cabang.id))&&D.value.unshift({value:String(t.kantor_cabang.id),label:t.kantor_cabang.nama||""}),t.program&&!P.value.find(i=>i.value===String(t.program.id))){const i=t.program.nama_program||t.program.nama||"";P.value.unshift({value:String(t.program.id),label:i})}}catch(a){console.error("Error loading data:",a),g.error("Gagal memuat data pengajuan dana")}},ea=async()=>{try{const s=await K();j.value=s!=null&&s.id?String(s.id):"";const n=await(await fetch("/admin/api/pengajuan-dana/options",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load options");const t=n.data.users||[];_.value=t.map(l=>({value:String(l.id),label:l.name}));const i=n.data.kantor_cabangs||[];D.value=i.map(l=>({value:String(l.id),label:l.nama}));const c=n.data.programs||[];P.value=c.map(l=>({value:String(l.id),label:l.nama})),j.value&&_.value.find(k=>k.value===String(j.value))&&!e.applicant&&(e.applicant=String(j.value)),f.value&&n.data&&n.data.current&&n.data.current.program&&(e.programId=String(n.data.current.program.id))}catch(s){console.error("Error loading options",s),g.error("Gagal memuat opsi form")}},ta=[{value:"Draft",label:"Draft"},{value:"Pending",label:"Diajukan"}];x(()=>String(e.applicant)===String(j.value));const ra=x(()=>ta),$=()=>R.push("/keuangan/pengajuan-dana"),sa=async()=>{var s;if(!e.applicant){g.error("Pengaju wajib diisi");return}if(!e.submissionType){g.error("Tipe Pengajuan wajib diisi");return}if(!e.amount||e.amount<=0){g.error("Nominal wajib diisi dan harus lebih dari 0");return}if(!e.usedAt){g.error("Tanggal Digunakan wajib diisi");return}if(!e.branchId){g.error("Kantor Cabang wajib diisi");return}if(!v.value){v.value=!0;try{if(V.value){const k=y(Number(((s=o.value)==null?void 0:s.remaining)||0));g.error(`nominal melebihi batas tidak dapat menyimpan — sisa alokasi: ${k}`),v.value=!1;return}const a={fundraiser_id:e.applicant,submission_type:e.submissionType,program_id:e.programId||null,status:e.status,amount:e.amount,used_at:e.usedAt,purpose:e.purpose,kantor_cabang_id:e.branchId},n=await xa(),t=f.value?`/admin/api/pengajuan-dana/${T.params.id}`:"/admin/api/pengajuan-dana",i=f.value?"PUT":"POST",l=await(await fetch(t,{method:i,credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)})).json();if(!l.success){if(l.remaining!==void 0){g.error(`nominal melebihi batas tidak dapat menyimpan — sisa alokasi: ${y(Number(l.remaining))}`),v.value=!1;return}if(l.errors){const k=Object.values(l.errors)[0];g.error(k?String(k[0]):"Validation failed"),v.value=!1;return}throw new Error(l.message||"Failed to save")}g.success(f.value?"Pengajuan dana berhasil diupdate":"Pengajuan dana berhasil ditambahkan"),R.push("/keuangan/pengajuan-dana")}catch(a){console.error("Error saving:",a),g.error("Terjadi kesalahan saat menyimpan data")}finally{v.value=!1}}};return H(async()=>{await ea(),await aa()}),H(()=>{const s=new Date().toISOString().split("T")[0];!f.value&&(!e.usedAt||String(e.usedAt).trim()==="")&&(e.usedAt=s)}),(s,a)=>(d(),da(va,null,{default:ua(()=>{var n;return[r("div",ha,[r("div",ka,[r("h3",wa,u(G.value),1),r("button",{onClick:$,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"},"Batal")]),r("form",{onSubmit:ma(sa,["prevent"]),class:"flex flex-col"},[r("div",_a,[r("div",ja,[a[15]||(a[15]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Pengaju "),r("span",{class:"text-red-500"},"*")],-1)),w(I,{modelValue:e.applicant,"onUpdate:modelValue":a[0]||(a[0]=t=>e.applicant=t),options:_.value,placeholder:"Pilih atau cari pengaju","search-input":E.value,"onUpdate:searchInput":a[1]||(a[1]=t=>E.value=t)},null,8,["modelValue","options","search-input"])]),r("div",Sa,[a[16]||(a[16]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Tipe Pengajuan "),r("span",{class:"text-red-500"},"*")],-1)),w(I,{modelValue:e.submissionType,"onUpdate:modelValue":a[2]||(a[2]=t=>e.submissionType=t),options:Y,placeholder:"Pilih tipe pengajuan","search-input":U.value,"onUpdate:searchInput":a[3]||(a[3]=t=>U.value=t)},null,8,["modelValue","search-input"])]),e.submissionType==="program"||e.submissionType==="operasional"||e.submissionType==="gaji karyawan"?(d(),m("div",Ia,[a[17]||(a[17]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Program",-1)),w(I,{modelValue:e.programId,"onUpdate:modelValue":a[4]||(a[4]=t=>e.programId=t),options:P.value,placeholder:"Pilih program"},null,8,["modelValue","options"])])):S("",!0),r("div",Ta,[a[20]||(a[20]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Status "),r("span",{class:"text-red-500"},"*")],-1)),e.status==="Approved"?(d(),m("div",Da,[a[18]||(a[18]=r("span",{class:"flex-1"},"Disetujui",-1)),N(r("input",{type:"hidden","onUpdate:modelValue":a[5]||(a[5]=t=>e.status=t)},null,512),[[F,e.status]])])):e.status==="Rejected"?(d(),m("div",Pa,[a[19]||(a[19]=r("div",{class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/10 dark:text-red-300"},[r("div",{class:"font-medium"},"Pengajuan ditolak"),r("div",{class:"text-xs"},"Anda dapat mengajukan ulang jika diperlukan.")],-1)),r("div",Va,[r("button",{type:"button",onClick:a[6]||(a[6]=()=>{e.status="Pending"}),class:"rounded bg-brand-500 px-3 py-1 text-sm text-white"},"Ajukan lagi"),r("button",{type:"button",onClick:a[7]||(a[7]=()=>{e.status="Draft"}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Simpan sebagai Draft")])])):(d(),m("div",Aa,[w(I,{modelValue:e.status,"onUpdate:modelValue":a[8]||(a[8]=t=>e.status=t),options:ra.value,placeholder:"Pilih status"},null,8,["modelValue","options"])]))]),r("div",Ca,[a[21]||(a[21]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Nominal "),r("span",{class:"text-red-500"},"*")],-1)),r("div",Na,[N(r("input",{type:"number","onUpdate:modelValue":a[9]||(a[9]=t=>e.amount=t),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",onInput:Z},null,544),[[F,e.amount,void 0,{number:!0}]]),r("span",Fa,u(z.value),1)]),a[22]||(a[22]=r("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"Minimal nominal: Rp 1",-1)),V.value?(d(),m("p",Ra,"Nominal melebihi sisa alokasi: "+u(y(((n=o.value)==null?void 0:n.remaining)||0)),1)):q.amount?(d(),m("p",Ea,u(q.amount),1)):S("",!0)]),r("div",Ua,[a[23]||(a[23]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Tanggal Digunakan "),r("span",{class:"text-red-500"},"*")],-1)),r("div",Ma,[w(ga(fa),{modelValue:e.usedAt,"onUpdate:modelValue":a[10]||(a[10]=t=>e.usedAt=t),config:W,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih tanggal digunakan",required:""},null,8,["modelValue"])])]),r("div",qa,[a[24]||(a[24]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Kantor Cabang "),r("span",{class:"text-red-500"},"*")],-1)),w(I,{modelValue:e.branchId,"onUpdate:modelValue":a[11]||(a[11]=t=>e.branchId=t),options:D.value,placeholder:"Pilih atau cari kantor cabang","search-input":M.value,"onUpdate:searchInput":a[12]||(a[12]=t=>M.value=t)},null,8,["modelValue","options","search-input"])]),p.value?(d(),m("div",La,[r("div",Xa,[r("div",$a,[r("div",null,[a[25]||(a[25]=r("div",{class:"text-xs text-gray-500"},"Program",-1)),r("div",Ba,u(p.value.nama_program||p.value.nama||""),1)]),r("div",Oa,[p.value&&Array.isArray(p.value.shares)?(d(),m("div",Ha,[r("div",Ka,[(d(!0),m(pa,null,ca(Q.value,t=>(d(),m("span",{key:t.id||t.share_id||t.program_share_id,class:"inline-flex items-center rounded px-2 py-0.5 bg-gray-100 text-xs text-gray-700 dark:bg-gray-800/40 dark:text-gray-300"},[t.type==="percentage"||t.type_key&&String(t.type_key).toLowerCase().includes("percent")?(d(),m("span",Ga,u(Number(t.value||0))+"% ",1)):(d(),m("span",Wa,u(y(Number(t.value||0))),1))]))),128))])])):(d(),m("div",Ya," "))])]),o.value?(d(),m("div",za,[r("div",Ja,[r("div",null,[r("div",Qa,"Sisa alokasi bulan "+u(J(o.value.month)),1),r("div",Za,u(y(o.value.remaining)),1)]),r("div",ae,[r("div",null,"Inflow: "+u(y(o.value.inflow)),1),r("div",null,"Dialokasikan: "+u(y(o.value.allocated)),1),r("div",null,"Terpakai: "+u(y(o.value.outflow)),1)])]),r("div",ee,[a[26]||(a[26]=r("div",{class:"text-sm text-gray-600"},"Opsi:",-1)),r("div",te,[r("button",{type:"button",onClick:a[13]||(a[13]=()=>{e.amount=o.value.remaining}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Gunakan Seluruh Alokasi")])]),r("div",re,[r("div",null,[a[27]||(a[27]=h("Estimasi sisa setelah pengajuan: ",-1)),r("span",se,u(y((o.value.remaining||0)-(e.amount||0))),1)]),(e.amount||0)>(o.value.remaining||0)?(d(),m("div",ne,"Kekurangan: "+u(y((e.amount||0)-(o.value.remaining||0))),1)):S("",!0)])])):S("",!0)])])):S("",!0),r("div",oe,[a[28]||(a[28]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tujuan Pengajuan",-1)),N(r("textarea",{"onUpdate:modelValue":a[14]||(a[14]=t=>e.purpose=t),placeholder:"Masukkan tujuan atau alasan pengajuan dana",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[F,e.purpose]]),r("p",ie,u(e.purpose.length)+"/1000 karakter",1)])]),r("div",le,[r("button",{onClick:$,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"},"Batal"),r("button",{disabled:v.value||V.value,type:"submit",class:ba(["flex w-full justify-center rounded-lg px-4 py-2.5 text-sm font-medium sm:w-auto",v.value||V.value?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-brand-500 text-white hover:bg-brand-600"])},u(f.value?"Simpan Perubahan":"Simpan"),11,de)])],32)])]}),_:1}))}});export{ye as default};
