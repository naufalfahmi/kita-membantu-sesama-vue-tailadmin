import{d as ue,H as ce,I as ge,b as m,B as pe,f as me,g as fe,o as A,w as be,a as o,c as K,i as G,t as P,m as he,k as ve,v as ke,j as M,u as z,S as ye}from"./admin-iSZcZcUC.js";import{C as we}from"./component-CbKyyAu_.js";import{S as J}from"./SearchableSelect-Czdaj_ny.js";import{u as T,w as U}from"./xlsx-3SA47z_C.js";import{_ as xe}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BXv1ieoZ.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const _e={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Se={class:"mb-6 flex items-center justify-between"},Ce={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},je={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Te={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-4"},Ne={class:"flex-1"},De={class:"flex-1"},Ae={class:"relative"},Me={class:"flex-1"},Ve={class:"flex-1"},Re={class:"flex-1"},Ie={key:0,class:"mt-3 text-sm text-red-600"},Ee={key:0,class:"flex items-center justify-center py-20"},He={key:1},Ke={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%"}},Le={key:2,class:"py-10"},ze=ue({__name:"Absensi",setup(Fe){const X=ce(),q=ge(),Z=m(String(X.meta.title||"Absensi")),V=m(!1),N=m([]),c=m(null),S=m(""),R=m(null),L=()=>{R.value=null,c.value?c.value.purgeInfiniteCache():x()},Y=()=>{j&&clearTimeout(j),j=window.setTimeout(()=>{c.value?c.value.purgeInfiniteCache():x()},400)},W=(a,e,t)=>{const r=new URLSearchParams;if(r.append("start",String(a)),r.append("limit",String(e)),f.value&&r.append("search",f.value),b.value){const l=b.value;if(Array.isArray(l))l[0]&&r.append("date_from",I(l[0])),l[1]&&r.append("date_to",I(l[1]));else if(typeof l=="string")if(l.includes(" to ")){const[d,s]=l.split(" to ").map(i=>i.trim());d&&r.append("date_from",d),s&&r.append("date_to",s)}else if(l.includes(" - ")){const[d,s]=l.split(" - ").map(i=>i.trim());d&&r.append("date_from",d),s&&r.append("date_to",s)}else r.append("date",l)}if(y.value&&r.append("kantor_cabang_id",y.value),w.value&&r.append("tipe_absensi_id",w.value),h.value&&r.append("status",h.value),r.append("per_page","10"),t&&Array.isArray(t)&&t.length>0){const l=t[0];l.colId&&r.append("sort_by",l.colId),l.sort&&r.append("sort_direction",l.sort)}return r.toString()},I=a=>{try{if(typeof a=="string")return a;const e=new Date(a),t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),l=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${l}`}catch{return String(a)}},F=(a,e,t)=>{if(a&&e)try{const r=new Date(a),l=new Date(e);let d=Math.round((l.getTime()-r.getTime())/6e4);d<0&&(d+=1440);let s=Math.floor(d/60),i=d%60;return i===0?`± ${s} jam`:`± ${s} jam ${i} menit`}catch{}if(t!=null&&!isNaN(Number(t))){const r=Number(t);let l=Math.floor(r),d=Math.round((r-l)*60);return d===60&&(l+=1,d=0),d===0?`± ${l} jam`:`± ${l} jam ${d} menit`}return"-"},E=()=>{const a=new Map,e=new Map;let t=null;return{getRows:async r=>{console.log("[Absensi] getRows called",{start:r.startRow,end:r.endRow,sortModel:r.sortModel});const l=r.startRow,d=r.endRow,s=Math.max(1,d-l),i=l;try{if(a.has(i)){const n=a.get(i)||[];r.successCallback(n,t);return}if(e.has(i)){await e.get(i);const n=a.get(i)||[];r.successCallback(n,t);return}const g=`/admin/api/absensi?${W(l,s,r.sortModel)}`;console.log("[Absensi] fetching",g,{sortModel:r.sortModel});const v=(async()=>{var p,k,_,D;const n=await fetch(g,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":B()},credentials:"same-origin"});if(!n.ok)throw new Error("Failed to fetch");const u=await n.json();if(u.success){S.value="",t=typeof u.total=="number"?u.total:u.data?u.data.length:null,R.value=t??null;const H=JSON.parse(JSON.stringify(u.data||[]));if(a.set(i,H),r.successCallback(H,t??null),t===0||!H||H.length===0){S.value="";try{(k=(p=c.value)==null?void 0:p.showNoRowsOverlay)==null||k.call(p)}catch{}}else try{(D=(_=c.value)==null?void 0:_.hideOverlay)==null||D.call(_)}catch{}}else S.value=u.message||"Gagal memuat data absensi",R.value=0,r.successCallback([],0)})();e.set(i,v);try{await v}finally{e.delete(i)}}catch(g){console.error("Infinite getRows error:",g),S.value=(g==null?void 0:g.message)||String(g),r.failCallback()}},_blockCache:a}},C=m(E()),Q=a=>{c.value=a.api;try{a.api.setDatasource(C.value)}catch(e){console.error("Error setting datasource on grid ready:",e)}},ee=()=>{var a,e;console.log("[Absensi] sort changed, recreating datasource and purging cache",{sortModel:(e=(a=c.value)==null?void 0:a.getSortModel)==null?void 0:e.call(a)});try{if(C.value=E(),c.value){c.value.setDatasource(C.value);try{c.value.purgeInfiniteCache()}catch{}}}catch(t){console.error("[Absensi] error recreating datasource:",t)}},f=m(""),b=m(""),h=m(""),y=m(""),w=m(""),O=m([{value:"",label:"Semua Kantor Cabang"}]),$=m([{value:"",label:"Semua Tipe Absensi"}]),ae={mode:"range",dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1},te=async()=>{try{const a=await fetch("/admin/api/kantor-cabang?per_page=1000",{credentials:"same-origin"});if(a.ok){const t=((await a.json()).data||[]).map(r=>({value:String(r.id),label:r.nama||r.name||"-"}));O.value=[{value:"",label:"Semua Kantor Cabang"},...t]}try{const e=await fetch("/admin/api/tipe-absensi?per_page=1000",{credentials:"same-origin"});if(e.ok){const r=((await e.json()).data||[]).map(l=>({value:String(l.id),label:l.nama||l.name||l.label||"-"}));$.value=[{value:"",label:"Semua Tipe Absensi"},...r]}}catch(e){console.error("Error loading tipe absensi list:",e)}}catch(a){console.error("Error loading kantor cabang list:",a)}},re=[{value:"",label:"Semua Status"},{value:"hadir",label:"Hadir"},{value:"terlambat",label:"Terlambat"},{value:"pulang_awal",label:"Pulang Awal"},{value:"tidak_hadir",label:"Tidak Hadir"},{value:"izin",label:"Izin"},{value:"sakit",label:"Sakit"},{value:"cuti",label:"Cuti"}],le=[{headerName:"Nama",field:"user.name",sortable:!0,filter:!1,valueGetter:a=>{var e,t;return((t=(e=a.data)==null?void 0:e.user)==null?void 0:t.name)||"-"}},{headerName:"No Induk",field:"user.no_induk",sortable:!0,filter:!1,width:120,valueGetter:a=>{var e,t;return((t=(e=a.data)==null?void 0:e.user)==null?void 0:t.no_induk)||"-"}},{headerName:"Kantor Cabang",field:"kantor_cabang.nama",sortable:!0,filter:!1,width:150,valueGetter:a=>{var e,t;return((t=(e=a.data)==null?void 0:e.kantor_cabang)==null?void 0:t.nama)||"-"}},{headerName:"Jam Masuk",field:"jam_masuk",sortable:!0,filter:!1,width:180,valueFormatter:a=>a.value?new Date(a.value).toLocaleString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"},{headerName:"Jam Keluar",field:"jam_keluar",sortable:!0,filter:!1,width:180,valueFormatter:a=>a.value?new Date(a.value).toLocaleString("id-ID",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-"},{headerName:"Total Jam",field:"total_jam_kerja",sortable:!0,filter:!1,width:100,valueFormatter:a=>{var e,t;return F((e=a.data)==null?void 0:e.jam_masuk,(t=a.data)==null?void 0:t.jam_keluar,a.value)}},{headerName:"Status",field:"status",sortable:!0,filter:!1,width:120,cellRenderer:a=>{var g,v,n;let e=a.value||"hadir";const t=(g=a.data)==null?void 0:g.jam_masuk,r=(v=a.data)==null?void 0:v.jam_keluar,l=(n=a.data)==null?void 0:n.tipe_absensi;if(!t)e="tidak_hadir";else{if(l&&l.jam_masuk)try{new Date(t).toTimeString().slice(0,8)>l.jam_masuk?e="terlambat":e="hadir"}catch{e=a.value||"hadir"}else e=a.value||"hadir";e==="terlambat"&&(e="hadir")}if(t&&r)try{const u=new Date(t);(new Date(r).getTime()<u.getTime()||l&&l.jam_keluar&&new Date(r).toTimeString().slice(0,8)<l.jam_keluar&&e!=="terlambat")&&(e="pulang_awal")}catch{}const d={hadir:{label:"Hadir",class:"bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400"},terlambat:{label:"Terlambat",class:"bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400"},pulang_awal:{label:"Pulang Awal",class:"bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400"},tidak_hadir:{label:"Tidak Hadir",class:"bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400"},izin:{label:"Izin",class:"bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400"},sakit:{label:"Sakit",class:"bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400"},cuti:{label:"Cuti",class:"bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-400"}},s=d[e]||d.hadir,i=document.createElement("span");return i.className=`inline-flex px-2 py-1 rounded-full text-xs font-medium ${s.class}`,i.textContent=s.label,i}},{headerName:"Actions",field:"actions",sortable:!1,filter:!1,width:100,pinned:"right",cellRenderer:a=>{const e=document.createElement("div");e.className="flex items-center gap-3";const t=document.createElement("button");return t.className="flex items-center justify-center w-8 h-8 rounded-lg text-brand-500 hover:bg-brand-50 dark:hover:bg-brand-500/10 transition-colors",t.innerHTML=`
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
      `,t.onclick=()=>se(a.data.id),e.appendChild(t),e}}],ne={resizable:!0,sortable:!0,filter:!1},B=()=>{var a;return((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||""},x=async()=>{V.value=!0;try{const a=new URLSearchParams;f.value&&a.append("search",f.value),b.value&&a.append("date",b.value),h.value&&a.append("status",h.value),a.append("per_page","10");const e=`/admin/api/absensi${a.toString()?"?"+a.toString():""}`,r=await(await fetch(e,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":B()},credentials:"same-origin"})).json();r.success?N.value=JSON.parse(JSON.stringify(r.data||[])):(console.error("Failed to fetch data:",r.message),N.value=[])}catch(a){console.error("Error fetching data:",a),N.value=[]}finally{V.value=!1}},se=a=>{q.push(`/operasional/absensi/${a}`)},oe=async()=>{try{const a=new URLSearchParams;if(f.value&&a.append("search",f.value),b.value){const n=b.value;if(Array.isArray(n))n[0]&&a.append("date_from",I(n[0])),n[1]&&a.append("date_to",I(n[1]));else if(typeof n=="string")if(n.includes(" to ")){const[u,p]=n.split(" to ").map(k=>k.trim());u&&a.append("date_from",u),p&&a.append("date_to",p)}else if(n.includes(" - ")){const[u,p]=n.split(" - ").map(k=>k.trim());u&&a.append("date_from",u),p&&a.append("date_to",p)}else a.append("date",n)}y.value&&a.append("kantor_cabang_id",y.value),w.value&&a.append("tipe_absensi_id",w.value),h.value&&a.append("status",h.value),a.append("per_page","1000");const e=`/admin/api/absensi?${a.toString()}`,t=await fetch(e,{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error("Failed to fetch export data");const r=await t.json(),d=(r.success?JSON.parse(JSON.stringify(r.data||[])):JSON.parse(JSON.stringify(N.value||[]))).map(n=>{var u,p,k,_,D;return{Nama:((u=n.user)==null?void 0:u.name)||"-","No Induk":((p=n.user)==null?void 0:p.no_induk)||"-","Kantor Cabang":((k=n.kantor_cabang)==null?void 0:k.nama)||"-","Tipe Absensi":((_=n.tipe_absensi)==null?void 0:_.nama)||((D=n.tipe_absensi)==null?void 0:D.label)||"-","Jam Masuk":n.jam_masuk?new Date(n.jam_masuk).toLocaleString("id-ID"):"-","Jam Keluar":n.jam_keluar?new Date(n.jam_keluar).toLocaleString("id-ID"):"-","Total Jam Kerja":F(n.jam_masuk,n.jam_keluar,n.total_jam_kerja),Status:n.status==="terlambat"?"hadir":n.status||"-",Catatan:n.catatan||"-"}}),s=T.json_to_sheet(d),i=T.book_new();T.book_append_sheet(i,s,"Absensi");const v=`Absensi_${new Date().toISOString().split("T")[0]}.xlsx`;U(i,v)}catch(a){console.error("Export failed:",a);const e=N.value.map(s=>{var i,g,v,n,u;return{Nama:((i=s.user)==null?void 0:i.name)||"-","No Induk":((g=s.user)==null?void 0:g.no_induk)||"-","Kantor Cabang":((v=s.kantor_cabang)==null?void 0:v.nama)||"-","Tipe Absensi":((n=s.tipe_absensi)==null?void 0:n.nama)||((u=s.tipe_absensi)==null?void 0:u.label)||"-","Jam Masuk":s.jam_masuk?new Date(s.jam_masuk).toLocaleString("id-ID"):"-","Jam Keluar":s.jam_keluar?new Date(s.jam_keluar).toLocaleString("id-ID"):"-","Total Jam Kerja":F(s.jam_masuk,s.jam_keluar,s.total_jam_kerja),Status:s.status==="terlambat"?"hadir":s.status||"-",Catatan:s.catatan||"-"}}),t=T.json_to_sheet(e),r=T.book_new();T.book_append_sheet(r,t,"Absensi");const d=`Absensi_${new Date().toISOString().split("T")[0]}.xlsx`;U(r,d)}},ie=()=>{if(f.value="",b.value="",h.value="",y.value="",w.value="",C.value=E(),c.value)try{c.value.purgeInfiniteCache()}catch{x()}else x()};let j=null;return pe([f,b,h,y,w],()=>{j&&clearTimeout(j),j=setTimeout(()=>{if(C.value=E(),c.value)try{c.value.purgeInfiniteCache()}catch{x()}else x()},500)}),me(()=>{te(),x()}),(a,e)=>(A(),fe(xe,null,{default:be(()=>[o("div",_e,[o("div",Se,[o("h3",Ce,P(Z.value),1),o("button",{onClick:oe,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...e[5]||(e[5]=[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{d:"M10.8333 3.33333V9.16667H16.6667L10.8333 3.33333ZM4.16667 2.5H11.6667L17.5 8.33333V15.8333C17.5 16.2754 17.3244 16.6993 17.0118 17.0118C16.6993 17.3244 16.2754 17.5 15.8333 17.5H4.16667C3.72464 17.5 3.30072 17.3244 2.98816 17.0118C2.67559 16.6993 2.5 16.2754 2.5 15.8333V4.16667C2.5 3.72464 2.67559 3.30072 2.98816 2.98816C3.30072 2.67559 3.72464 2.5 4.16667 2.5Z",fill:"currentColor"})],-1),he(" Export Excel ",-1)])])]),o("div",je,[o("div",Te,[o("div",Ne,[e[6]||(e[6]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Nama / No Induk ",-1)),ve(o("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>f.value=t),placeholder:"Cari nama atau no induk...",class:"h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[ke,f.value]])]),o("div",De,[e[8]||(e[8]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Tanggal (Range) ",-1)),o("div",Ae,[M(z(we),{modelValue:b.value,"onUpdate:modelValue":e[1]||(e[1]=t=>b.value=t),config:ae,onOnChange:Y,class:"h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal"},null,8,["modelValue"]),e[7]||(e[7]=o("span",{class:"absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 pointer-events-none"},[o("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[o("path",{"fill-rule":"evenodd","clip-rule":"evenodd",d:"M6.66659 1.5415C7.0808 1.5415 7.41658 1.87729 7.41658 2.2915V2.99984H12.5833V2.2915C12.5833 1.87729 12.919 1.5415 13.3333 1.5415C13.7475 1.5415 14.0833 1.87729 14.0833 2.2915V2.99984L15.4166 2.99984C16.5212 2.99984 17.4166 3.89527 17.4166 4.99984V7.49984V15.8332C17.4166 16.2754 17.3244 16.6993 17.0118 17.0118C16.6993 17.3244 16.2754 17.5 15.8333 17.5H4.58325C3.47868 17.5 2.58325 16.9377 2.58325 15.8332V7.49984V4.99984C2.58325 3.89527 3.47868 2.99984 4.58325 2.99984L5.91659 2.99984V2.2915C5.91659 1.87729 6.25237 1.5415 6.66659 1.5415ZM6.66659 4.49984H4.58325C4.30711 4.49984 4.08325 4.7237 4.08325 4.99984V6.74984H15.9166V4.99984C15.9166 4.7237 15.6927 4.49984 15.4166 4.49984H13.3333H6.66659ZM15.9166 8.24984H4.08325V15.8332C4.08325 16.1093 4.30711 16.3332 4.58325 16.3332H15.4166C15.6927 16.3332 15.9166 16.1093 15.9166 15.8332V8.24984Z",fill:"currentColor"})])],-1))])]),o("div",Me,[e[9]||(e[9]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Status ",-1)),M(J,{modelValue:h.value,"onUpdate:modelValue":[e[2]||(e[2]=t=>h.value=t),L],options:re,placeholder:"Semua Status"},null,8,["modelValue"])]),o("div",Ve,[e[10]||(e[10]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kantor Cabang ",-1)),M(J,{modelValue:y.value,"onUpdate:modelValue":[e[3]||(e[3]=t=>y.value=t),L],options:O.value,placeholder:"Semua Kantor Cabang"},null,8,["modelValue","options"])]),o("div",Re,[e[11]||(e[11]=o("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Tipe Absensi ",-1)),M(J,{modelValue:w.value,"onUpdate:modelValue":[e[4]||(e[4]=t=>w.value=t),L],options:$.value,placeholder:"Semua Tipe Absensi"},null,8,["modelValue","options"])]),o("div",{class:"md:col-span-3 lg:col-span-1 flex items-end"},[o("button",{onClick:ie,class:"h-11 w-full rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Reset Filter ")])]),S.value?(A(),K("div",Ie,P(S.value),1)):G("",!0)]),V.value?(A(),K("div",Ee,[...e[12]||(e[12]=[o("div",{class:"flex flex-col items-center gap-4"},[o("div",{class:"h-12 w-12 animate-spin rounded-full border-4 border-brand-500 border-t-transparent"}),o("p",{class:"text-sm text-gray-600 dark:text-gray-400"},"Memuat data absensi...")],-1)])])):(A(),K("div",He,[o("div",Ke,[M(z(ye),{ref:"agGridRef",class:"ag-theme-alpine",style:{width:"100%",height:"480px","min-height":"300px"},columnDefs:le,defaultColDef:ne,rowModelType:"infinite",datasource:C.value,rowBuffer:1,cacheBlockSize:10,infiniteInitialRowCount:10,maxBlocksInCache:20,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!0,onGridReady:Q,onSortChanged:ee},null,8,["datasource"])])])),!V.value&&R.value===0?(A(),K("div",Le,[...e[13]||(e[13]=[o("div",{class:"flex flex-col items-center justify-center gap-3"},null,-1)])])):G("",!0)])]),_:1}))}});export{ze as default};
