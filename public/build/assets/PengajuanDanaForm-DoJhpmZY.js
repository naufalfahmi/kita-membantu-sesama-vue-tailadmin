import{d as Q,H as Z,I as aa,L as ea,A as w,b as m,e as ta,B as ra,f as na,g as sa,o as c,w as oa,a as t,t as o,q as ia,c as x,i as P,j as v,m as b,F as la,l as da,k as R,v as U,u as ua,P as ma}from"./admin-DxPS0APX.js";import{C as ga}from"./component-woW_vz8O.js";import{_ as pa,g as ca}from"./AdminLayout.vue_vue_type_script_setup_true_lang-DRybCjRc.js";import{S as _}from"./SearchableSelect-Br_fltu8.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ba={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},fa={class:"mb-6 flex items-center justify-between"},xa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},va={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ya={class:"lg:col-span-1"},ha={class:"lg:col-span-1"},ka={key:0,class:"lg:col-span-1"},wa={key:0,class:"mt-2 text-sm text-gray-500"},_a={key:1,class:"mt-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-900/40"},ja={class:"flex items-center justify-between"},Sa={class:"text-xs text-gray-500"},Ia={class:"text-lg font-medium"},Ta={class:"text-right text-xs text-gray-500"},Da={class:"mt-3 flex items-center justify-between"},Pa={class:"flex items-center gap-3"},Va={class:"mt-3"},Fa={class:"space-y-2 max-h-48 overflow-auto"},Ca={class:"font-medium"},Na={class:"text-xs text-gray-500"},Aa={class:"text-right"},Ma={class:"text-sm"},Ra={class:"text-xs text-gray-500"},Ua={class:"mt-3 text-sm text-gray-700"},Ea={class:"font-medium"},La={key:0,class:"mt-1 text-xs text-red-500"},qa={class:"lg:col-span-1"},Ba={class:"lg:col-span-1"},Oa={class:"relative"},Xa={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},$a={class:"lg:col-span-1"},Ha={class:"relative"},Ka={class:"lg:col-span-2"},Ga={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},Wa={class:"lg:col-span-2"},Ya={class:"flex items-center gap-3 mt-6 lg:justify-end"},Ja={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},re=Q({__name:"PengajuanDanaForm",setup(za){const j=Z(),V=aa(),u=ea(),{fetchUser:E}=ma(),p=w(()=>j.params.id!==void 0&&j.params.id!=="new"),L=w(()=>p.value?"Edit Pengajuan Dana":"Tambah Pengajuan Dana"),q={dateFormat:"Y-m-d",altInput:!0,altFormat:"d F Y",locale:"id",wrap:!0,clickOpens:!0,allowInput:!1,minDate:"today"},y=m([]),B=[{value:"operasional",label:"Operasional"},{value:"program",label:"Program"},{value:"kegiatan",label:"Kegiatan"},{value:"pengembangan",label:"Pengembangan"},{value:"darurat",label:"Darurat"},{value:"lainnya",label:"Lainnya"}],S=m([]),I=m([]),F=m(""),C=m(""),N=m(""),h=m(""),e=ta({applicant:"",submissionType:"",status:"Draft",programId:"",amount:null,usedAt:"",purpose:"",branchId:""}),O=w(()=>!e.amount||e.amount<=0?"":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e.amount)),l=m(null),k=m([]),T=m(!1);let D=null;const g=s=>!s||s<=0?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),X=s=>{if(!s)return"";try{const a=String(s).split("-");if(a.length<2)return s;const r=Number(a[0]),n=Number(a[1])-1,i=new Date(Date.UTC(r,n,1));return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(i)}catch{return s}},$=async()=>{if(!e.programId||!e.usedAt){l.value=null,k.value=[];return}T.value=!0;try{const s=new Date(e.usedAt);if(isNaN(s.getTime())){l.value=null,k.value=[],T.value=!1;return}const a=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,n=await(await fetch(`/admin/api/program/${e.programId}/balance?month=${a}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load balance");if(l.value=n.data,k.value=n.data.transaksis||[],!p.value){const i=Number(n.data.remaining||0);i>0&&(!e.amount||e.amount<=0)&&(e.amount=i)}}catch(s){console.error("Error loading program balance",s),u.error("Gagal memuat saldo program"),l.value=null,k.value=[]}finally{T.value=!1}};ra([()=>e.programId,()=>e.usedAt],()=>{D&&window.clearTimeout(D),D=window.setTimeout(()=>{$()},300)});const H=s=>{const a=s.target,r=parseFloat(a.value);isNaN(r)||r<0?e.amount=null:e.amount=Math.floor(r)},K=async()=>{if(!p.value)return;const s=j.params.id;try{const r=await(await fetch(`/admin/api/pengajuan-dana/${s}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load");const n=r.data;if(e.applicant=n.fundraiser?String(n.fundraiser.id):"",e.status=n.status||"Draft",n.fundraiser&&!y.value.find(i=>i.value===String(n.fundraiser.id))&&y.value.unshift({value:String(n.fundraiser.id),label:n.fundraiser.name||n.fundraiser.nama||""}),e.submissionType=n.submission_type,e.amount=n.amount,e.usedAt=n.used_at,e.purpose=n.purpose,e.branchId=n.kantor_cabang?n.kantor_cabang.id:"",e.programId=n.program?String(n.program.id):"",n.kantor_cabang&&!S.value.find(i=>i.value===String(n.kantor_cabang.id))&&S.value.unshift({value:String(n.kantor_cabang.id),label:n.kantor_cabang.nama||""}),n.program&&!I.value.find(i=>i.value===String(n.program.id))){const i=n.program.nama_program||n.program.nama||"";I.value.unshift({value:String(n.program.id),label:i})}}catch(a){console.error("Error loading data:",a),u.error("Gagal memuat data pengajuan dana")}},G=async()=>{try{const s=await E();h.value=s!=null&&s.id?String(s.id):"";const r=await(await fetch("/admin/api/pengajuan-dana/options",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success)throw new Error(r.message||"Failed to load options");const n=r.data.users||[];y.value=n.map(d=>({value:String(d.id),label:d.name}));const i=r.data.kantor_cabangs||[];S.value=i.map(d=>({value:String(d.id),label:d.nama}));const f=r.data.programs||[];I.value=f.map(d=>({value:String(d.id),label:d.nama})),h.value&&y.value.find(z=>z.value===String(h.value))&&!e.applicant&&(e.applicant=String(h.value)),p.value&&r.data&&r.data.current&&r.data.current.program&&(e.programId=String(r.data.current.program.id))}catch(s){console.error("Error loading options",s),u.error("Gagal memuat opsi form")}},A=[{value:"Draft",label:"Draft"},{value:"pending",label:"Diajukan"}],W=w(()=>String(e.applicant)===String(h.value)),Y=w(()=>(W.value,A)),M=()=>V.push("/keuangan/pengajuan-dana"),J=async()=>{if(!e.applicant){u.error("Pengaju wajib diisi");return}if(!e.submissionType){u.error("Tipe Pengajuan wajib diisi");return}if(!e.amount||e.amount<=0){u.error("Nominal wajib diisi dan harus lebih dari 0");return}if(!e.usedAt){u.error("Tanggal Digunakan wajib diisi");return}if(!e.branchId){u.error("Kantor Cabang wajib diisi");return}try{const s={fundraiser_id:e.applicant,submission_type:e.submissionType,program_id:e.programId||null,status:e.status,amount:e.amount,used_at:e.usedAt,purpose:e.purpose,kantor_cabang_id:e.branchId},a=await ca(),r=p.value?`/admin/api/pengajuan-dana/${j.params.id}`:"/admin/api/pengajuan-dana",n=p.value?"PUT":"POST",f=await(await fetch(r,{method:n,credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s)})).json();if(!f.success){if(f.errors){const d=Object.values(f.errors)[0];u.error(d?String(d[0]):"Validation failed");return}throw new Error(f.message||"Failed to save")}u.success(p.value?"Pengajuan dana berhasil diupdate":"Pengajuan dana berhasil ditambahkan"),V.push("/keuangan/pengajuan-dana")}catch(s){console.error("Error saving:",s),u.error("Terjadi kesalahan saat menyimpan data")}};return na(async()=>{await G(),await K()}),(s,a)=>(c(),sa(pa,null,{default:oa(()=>[t("div",ba,[t("div",fa,[t("h3",xa,o(L.value),1),t("button",{onClick:M,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"},"Batal")]),t("form",{onSubmit:ia(J,["prevent"]),class:"flex flex-col"},[t("div",va,[t("div",ya,[a[12]||(a[12]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Pengaju "),t("span",{class:"text-red-500"},"*")],-1)),v(_,{modelValue:e.applicant,"onUpdate:modelValue":a[0]||(a[0]=r=>e.applicant=r),options:y.value,placeholder:"Pilih atau cari pengaju","search-input":F.value,"onUpdate:searchInput":a[1]||(a[1]=r=>F.value=r)},null,8,["modelValue","options","search-input"])]),t("div",ha,[a[13]||(a[13]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tipe Pengajuan "),t("span",{class:"text-red-500"},"*")],-1)),v(_,{modelValue:e.submissionType,"onUpdate:modelValue":a[2]||(a[2]=r=>e.submissionType=r),options:B,placeholder:"Pilih tipe pengajuan","search-input":C.value,"onUpdate:searchInput":a[3]||(a[3]=r=>C.value=r)},null,8,["modelValue","search-input"])]),e.submissionType==="program"?(c(),x("div",ka,[a[17]||(a[17]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Program",-1)),v(_,{modelValue:e.programId,"onUpdate:modelValue":a[4]||(a[4]=r=>e.programId=r),options:I.value,placeholder:"Pilih program"},null,8,["modelValue","options"]),T.value?(c(),x("div",wa,"Memuat saldo...")):l.value?(c(),x("div",_a,[t("div",ja,[t("div",null,[t("div",Sa,"Sisa alokasi bulan "+o(X(l.value.month)),1),t("div",Ia,o(g(l.value.remaining)),1)]),t("div",Ta,[t("div",null,"Inflow: "+o(g(l.value.inflow)),1),t("div",null,"Dialokasikan: "+o(g(l.value.allocated)),1),t("div",null,"Terpakai: "+o(g(l.value.outflow)),1)])]),t("div",Da,[a[14]||(a[14]=t("div",{class:"text-sm text-gray-600"},"Opsi:",-1)),t("div",Pa,[t("button",{type:"button",onClick:a[5]||(a[5]=()=>{e.amount=l.value.remaining}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Gunakan Seluruh Alokasi")])]),t("div",Va,[a[15]||(a[15]=t("div",{class:"mb-2 text-sm font-medium"},"Daftar Transaksi (bulan)",-1)),t("div",Fa,[(c(!0),x(la,null,da(k.value,r=>(c(),x("div",{key:r.id,class:"flex items-center justify-between rounded-md border border-gray-200 bg-white px-3 py-2 text-sm dark:border-gray-700 dark:bg-gray-800"},[t("div",null,[t("div",Ca,o(r.kode||r.id),1),t("div",Na,o(r.tanggal_transaksi),1)]),t("div",Aa,[t("div",Ma,"Nominal: "+o(g(r.nominal)),1),t("div",Ra,"Terpakai: "+o(g(r.used))+" â€” Tersedia: "+o(g(r.available)),1)])]))),128))])]),t("div",Ua,[t("div",null,[a[16]||(a[16]=b("Estimasi sisa setelah pengajuan: ",-1)),t("span",Ea,o(g((l.value.remaining||0)-(e.amount||0))),1)]),(e.amount||0)>(l.value.remaining||0)?(c(),x("div",La,"Kekurangan: "+o(g((e.amount||0)-(l.value.remaining||0))),1)):P("",!0)])])):P("",!0)])):P("",!0),t("div",qa,[a[18]||(a[18]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Status "),t("span",{class:"text-red-500"},"*")],-1)),v(_,{modelValue:e.status,"onUpdate:modelValue":a[6]||(a[6]=r=>e.status=r),options:Y.value,placeholder:"Pilih status"},null,8,["modelValue","options"])]),t("div",Ba,[a[19]||(a[19]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Nominal "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Oa,[R(t("input",{type:"number","onUpdate:modelValue":a[7]||(a[7]=r=>e.amount=r),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",onInput:H},null,544),[[U,e.amount,void 0,{number:!0}]]),t("span",Xa,o(O.value),1)]),a[20]||(a[20]=t("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"Minimal nominal: Rp 1",-1))]),t("div",$a,[a[21]||(a[21]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Tanggal Digunakan "),t("span",{class:"text-red-500"},"*")],-1)),t("div",Ha,[v(ua(ga),{modelValue:e.usedAt,"onUpdate:modelValue":a[8]||(a[8]=r=>e.usedAt=r),config:q,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih tanggal digunakan",required:""},null,8,["modelValue"])])]),t("div",Ka,[a[22]||(a[22]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tujuan Pengajuan",-1)),R(t("textarea",{"onUpdate:modelValue":a[9]||(a[9]=r=>e.purpose=r),placeholder:"Masukkan tujuan atau alasan pengajuan dana",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[U,e.purpose]]),t("p",Ga,o(e.purpose.length)+"/1000 karakter",1)]),t("div",Wa,[a[23]||(a[23]=t("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[b("Kantor Cabang "),t("span",{class:"text-red-500"},"*")],-1)),v(_,{modelValue:e.branchId,"onUpdate:modelValue":a[10]||(a[10]=r=>e.branchId=r),options:S.value,placeholder:"Pilih atau cari kantor cabang","search-input":N.value,"onUpdate:searchInput":a[11]||(a[11]=r=>N.value=r)},null,8,["modelValue","options","search-input"])])]),t("div",Ya,[t("button",{onClick:M,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"},"Batal"),t("button",Ja,o(p.value?"Simpan Perubahan":"Simpan"),1)])],32)])]),_:1}))}});export{re as default};
