import{d as W,H as Z,I as aa,M as ea,A as d,b as p,B as ta,f as ra,Q as sa,g as la,o as N,w as oa,a as s,t as v,q as na,j as A,m as f,u as ia,k as U,v as $,c as P,i as ua,n as da,V as ma}from"./admin-DE34o4oK.js";import{_ as pa}from"./AdminLayout.vue_vue_type_script_setup_true_lang-B_NZxCTe.js";import{S as ca}from"./SearchableSelect-Dmwptd_X.js";import{S as ga}from"./SearchableMultiSelect-SdnNKzsR.js";import{C as ya}from"./component-vMEk-HR_.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const va={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ba={class:"mb-6 flex items-center justify-between"},fa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ha={class:"mb-6 grid grid-cols-1 gap-4 lg:grid-cols-2"},xa={class:"relative"},_a={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},ka={class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},wa=["readonly"],Na={key:0,class:"text-xs text-gray-500 mt-1 dark:text-gray-400"},ja={class:"relative"},Sa=["value"],Aa={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},Pa={class:"text-xs text-gray-500 mt-1 dark:text-gray-400"},Ta={key:0},Va={key:1},Ma={class:"flex items-center gap-3 mt-6 lg:justify-end"},Ra=["disabled"],B="fee_mitra",Ia=W({__name:"PayrollMitraForm",setup(Fa){const b=Z(),T=aa(),g=ea(),{fetchUser:E,user:y}=sa(),h=d(()=>b.params.id!==void 0&&b.params.id!=="new"),I=d(()=>h.value?"Edit Payroll Mitra":"Tambah Payroll Mitra"),x=p(!1),j=p([]),V=p([]),M=p(""),R=p(""),O=d(()=>j.value.map(t=>({value:t.id,label:t.nama}))),G=d(()=>V.value.map(t=>({value:t.id,label:t.nama_program}))),J=new Date().toISOString().split("T")[0],a=p({mitra_id:"",program_ids:[],program_id:"",nama_mitra:"",jumlah:0,persentase:0,total:0,payroll_date:J}),u=p({type:"percentage",value:null,key:null}),L=d(()=>u.value.type==="nominal"?"Nominal Fee Mitra":"Persentase (%)"),_=d(()=>u.value.type==="nominal"),q=t=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",maximumFractionDigits:0}).format(t??0),H=t=>t==null||Number.isNaN(t)?"0%":Number.isInteger(t)?`${t}%`:`${Number(t).toFixed(2).replace(/\.00$/,"")}%`,F=d(()=>{const t=u.value.value;return t==null?"":u.value.type==="nominal"?`Fee Mitra ditetapkan sebagai nominal: ${q(t)}`:`Persentase default dari program: ${H(t)}`}),k=d(()=>{const t=Number(a.value.jumlah)||0,r=Number(a.value.persentase)||0;return _.value&&u.value.value!==null?Number(u.value.value):Number(t*r/100)}),C=d({get(){return(Number(a.value.persentase)||0).toFixed(0)},set(t){const r=String(t).replace(/%/g,"").replace(/,/g,"").trim(),e=parseFloat(r);a.value.persentase=isNaN(e)?0:e}}),S=p(!1),D=async(t,r={})=>{const{applyToForm:e=!0}=r;if(u.value={type:"percentage",value:null,key:null},!!t)try{const m=await fetch(`/admin/api/program/${t}`,{credentials:"same-origin"});if(!m.ok)return;const o=await m.json();if(!o.success||!o.data)return;const c=Array.isArray(o.data.shares)?o.data.shares:[];let l=c.find(X=>String(X.program_share_type_key)===B);!l&&c.length>0&&(l=c[0]);const i=l==null?void 0:l.value,n=i!=null&&!Number.isNaN(Number(i))?Number(i):null,w=(l==null?void 0:l.type)||"percentage";u.value={type:w,value:n,key:(l==null?void 0:l.program_share_type_key)??B},e&&n!==null&&(a.value.persentase=n)}catch(m){console.error("loadProgramShare:",m)}};ta(()=>a.value.program_ids,async t=>{S.value||(a.value.jumlah=0,Array.isArray(t)&&t.length===1?await D(t[0]):u.value={type:"percentage",value:null,key:null})});const K=async()=>{try{const t=(()=>{if(!y.value)return!1;const i=y.value.roles||(y.value.role?[y.value.role]:[]);return Array.isArray(i)&&i.some(n=>{const w=typeof n=="string"?n:n==null?void 0:n.name;return typeof w=="string"&&w.trim().toLowerCase()==="admin cabang"})})(),e=!!(y.value&&y.value.is_admin)&&!t?"/admin/api/mitra?per_page=1000":"/admin/api/mitra?per_page=1000&only_assigned=1",[m,o]=await Promise.all([fetch(e,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=1000",{credentials:"same-origin"})]),c=await m.json(),l=await o.json();j.value=c.success?c.data:[],V.value=l.success?l.data:[]}catch{}},Y=async t=>{try{const e=await(await fetch(`/admin/api/mitra-payroll/${t}`,{credentials:"same-origin"})).json();e.success?(S.value=!0,Object.assign(a.value,e.data),a.value.jumlah=e.data.jumlah!==void 0&&e.data.jumlah!==null?Number(e.data.jumlah):a.value.jumlah,a.value.persentase=e.data.persentase!==void 0&&e.data.persentase!==null?Number(e.data.persentase):a.value.persentase,a.value.total=e.data.total!==void 0&&e.data.total!==null?Number(e.data.total):a.value.total,e.data.mitra&&e.data.mitra.id&&(a.value.mitra_id=e.data.mitra.id),Array.isArray(e.data.program_ids)&&e.data.program_ids.length>0?(a.value.program_ids=e.data.program_ids,a.value.program_id=e.data.program_ids[0]):e.data.program&&e.data.program.id&&(a.value.program_ids=[e.data.program.id],a.value.program_id=e.data.program.id),await ma(),S.value=!1,Array.isArray(a.value.program_ids)&&a.value.program_ids.length===1&&await D(a.value.program_ids[0],{applyToForm:!1})):g.error("Gagal memuat data")}catch{g.error("Gagal memuat data")}},z=async()=>{if(!a.value.jumlah||!a.value.persentase){g.error("Jumlah dan persentase wajib diisi");return}x.value=!0;try{if(a.value.mitra_id){const i=j.value.find(n=>n.id===a.value.mitra_id);a.value.nama_mitra=i?i.nama:""}a.value.total=k.value;const t=h.value?`/admin/api/mitra-payroll/${b.params.id}`:"/admin/api/mitra-payroll",r=h.value?"PUT":"POST",m=(await(await fetch("/admin/api/csrf-token",{credentials:"same-origin"})).json()).csrf_token,o={...a.value};Array.isArray(a.value.program_ids)&&a.value.program_ids.length>0?(o.program_ids=a.value.program_ids,a.value.program_ids.length===1&&(o.program_id=a.value.program_ids[0])):a.value.program_id&&(o.program_id=a.value.program_id);const l=await(await fetch(t,{method:r,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":m},credentials:"same-origin",body:JSON.stringify(o)})).json();l.success?(g.success("Berhasil"),T.push("/user-kepegawaian/payroll-mitra")):g.error(l.message||"Gagal menyimpan")}catch{g.error("Gagal menyimpan")}finally{x.value=!1}},Q=()=>T.push("/user-kepegawaian/payroll-mitra");return ra(async()=>{await E(),await K(),h.value&&b.params.id&&await Y(b.params.id)}),(t,r)=>(N(),la(pa,null,{default:oa(()=>[s("div",va,[s("div",ba,[s("h3",fa,v(I.value),1)]),s("form",{onSubmit:na(z,["prevent"]),class:"flex flex-col"},[s("div",ha,[s("div",null,[r[7]||(r[7]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f("Pilih Mitra "),s("span",{class:"text-red-500"},"*")],-1)),A(ca,{modelValue:a.value.mitra_id,"onUpdate:modelValue":r[0]||(r[0]=e=>a.value.mitra_id=e),options:O.value,placeholder:"Pilih Mitra","search-input":M.value,"onUpdate:searchInput":r[1]||(r[1]=e=>M.value=e)},null,8,["modelValue","options","search-input"])]),s("div",null,[r[8]||(r[8]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f("Pilih Program "),s("span",{class:"text-red-500"},"*")],-1)),A(ga,{modelValue:a.value.program_ids,"onUpdate:modelValue":r[2]||(r[2]=e=>a.value.program_ids=e),options:G.value,placeholder:"Pilih Program (bisa banyak)","search-input":R.value,"onUpdate:searchInput":r[3]||(r[3]=e=>R.value=e)},null,8,["modelValue","options","search-input"])]),s("div",null,[r[9]||(r[9]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f("Tanggal Payroll "),s("span",{class:"text-red-500"},"*")],-1)),A(ia(ya),{modelValue:a.value.payroll_date,"onUpdate:modelValue":r[4]||(r[4]=e=>a.value.payroll_date=e),config:{dateFormat:"Y-m-d"},class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},null,8,["modelValue"])]),s("div",null,[r[10]||(r[10]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f("Jumlah "),s("span",{class:"text-red-500"},"*")],-1)),s("div",xa,[U(s("input",{type:"number","onUpdate:modelValue":r[5]||(r[5]=e=>a.value.jumlah=e),placeholder:"Masukkan jumlah",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-24 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},null,512),[[$,a.value.jumlah,void 0,{number:!0}]]),s("span",_a," Rp "+v(a.value.jumlah?Number(a.value.jumlah).toLocaleString("id-ID"):"0"),1)])]),s("div",null,[s("label",ka,[f(v(L.value)+" ",1),r[11]||(r[11]=s("span",{class:"text-red-500"},"*",-1))]),U(s("input",{type:"text","onUpdate:modelValue":r[6]||(r[6]=e=>C.value=e),placeholder:"Masukkan persentase",required:"",readonly:_.value,class:da(["dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90",_.value?"cursor-not-allowed bg-gray-100/70 dark:bg-gray-900/70":""])},null,10,wa),[[$,C.value]]),F.value?(N(),P("p",Na,v(F.value),1)):ua("",!0)]),s("div",null,[r[12]||(r[12]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Total",-1)),s("div",ja,[s("input",{type:"number",value:k.value,readonly:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-24 text-sm text-gray-800 placeholder:text-gray-400"},null,8,Sa),s("span",Aa," Rp "+v(k.value?Number(k.value).toLocaleString("id-ID"):"0"),1)]),s("p",Pa,[_.value?(N(),P("span",Ta,"Total mengikuti nominal fee mitra dari konfigurasi program.")):(N(),P("span",Va,"Total dihitung otomatis: jumlah × persentase / 100"))])])]),s("div",Ma,[s("button",{onClick:Q,type:"button",class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 sm:w-auto"},"Batal"),s("button",{type:"submit",disabled:x.value,class:"flex items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},v(x.value?"Menyimpan...":"Simpan"),9,Ra)])],32)])]),_:1}))}});export{Ia as default};
