import{d as q,b as P,H as D,I,L as X,A as w,e as S,B as G,f as H,g as L,o as p,w as J,a,t as x,q as C,k,m as K,v as f,c as m,F as V,l as F,j as N}from"./admin-D1yXdFtM.js";import{_ as W}from"./AdminLayout.vue_vue_type_script_setup_true_lang-DrTR74V6.js";import{S as U}from"./SearchableSelect-BuJ2Z-dj.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const z={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Q={class:"mb-6 flex items-center justify-between"},Y={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Z={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ee={class:"lg:col-span-2"},ae={class:"lg:col-span-2"},te={class:"overflow-x-auto mt-2"},re={class:"w-full table-auto border border-gray-200 dark:border-gray-800 rounded-md"},se={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},oe={class:"px-4 py-3"},ne={class:"px-4 py-3"},le={class:"flex items-center gap-2"},de=["onUpdate:modelValue"],ie={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},pe={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},ce={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},ue=["onUpdate:modelValue"],me={class:"px-4 py-3"},ge={class:"px-4 py-3"},ye={class:"flex items-center gap-2"},he=["onUpdate:modelValue"],_e={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},be={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},xe=["onClick"],ke={class:"mt-2 text-xs text-gray-500 dark:text-gray-400"},fe={class:"flex items-center gap-3 mt-6 lg:justify-end"},ve={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Se=q({__name:"ProgramForm",setup(we){P("");const y=D(),_=I(),c=X(),g=w(()=>y.params.id!==void 0&&y.params.id!=="new"),M=w(()=>g.value?"Edit Program":"Tambah Program"),t=S({nama_program:"",tipe_pembagian_marketing:"",jumlah_persentase:null,shares:{},customRows:[]}),h=P([]),u=S({}),j=[{value:"percentage",label:"Persentase"},{value:"nominal",label:"Nominal"}],v=w(()=>{let r=0;for(const o of Object.keys(t.shares)){const e=t.shares[o];e&&e.type==="percentage"&&e.value!==null&&!Number.isNaN(e.value)&&(r+=Number(e.value))}return r>0?parseFloat(r.toFixed(2)):0});G(()=>v.value,r=>{t.jumlah_persentase=r},{immediate:!0});const A=async()=>{try{const r=await fetch("/admin/api/program-share-types",{credentials:"same-origin"});if(!r.ok)return;const o=await r.json();if(o.success&&Array.isArray(o.data)){h.value=o.data.slice().sort((e,l)=>{const n=e.orders??0,d=l.orders??0;return n-d});for(const e of h.value)t.shares[e.key]||(t.shares[e.key]={type:e.default_type||"percentage",value:null}),u[e.key]===void 0&&(u[e.key]="");Array.isArray(t.customRows)||(t.customRows=[])}}catch(r){console.error("Failed to load program share types:",r)}},T=async()=>{var r;try{const o=(r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.getAttribute("content");if(o)return o;const e=await fetch("/admin/api/csrf-token",{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Failed to get CSRF token: ${e.status}`);return(await e.json()).csrf_token||""}catch(o){return console.error("Failed to get CSRF token:",o),""}},E=()=>{const r=`custom_${Date.now()}`;t.customRows.push({key:r,name:"",type:"percentage",value:null}),u[r]=""},B=r=>{t.customRows.splice(r,1)},O=async()=>{var r;if(g.value&&y.params.id){const o=y.params.id;try{const e=await T(),n=await(await fetch(`/admin/api/program/${o}`,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":e},credentials:"same-origin"})).json();if(n.success&&n.data){const d=n.data;if(t.nama_program=d.nama_program||"",t.tipe_pembagian_marketing=d.tipe_pembagian_marketing||"",t.jumlah_persentase=d.jumlah_persentase?parseFloat(d.jumlah_persentase):null,Array.isArray(d.shares)){t.customRows=[];for(const s of d.shares){const i=s.program_share_type_key||(s.program_share_type_id?(r=h.value.find(b=>b.id===s.program_share_type_id))==null?void 0:r.key:null);if(i&&t.shares[i]!==void 0)t.shares[i]={type:s.type||"percentage",value:s.value!==null?parseFloat(s.value):null};else{const b=s.program_share_type_key||`custom_${Date.now()}_${Math.floor(Math.random()*1e3)}`;t.customRows.push({key:b,name:s.name||"",type:s.type||"percentage",value:s.value!==null?parseFloat(s.value):null}),u[b]=""}}}}else c.error("Gagal memuat data program"),_.push("/administrasi/program")}catch(e){console.error("Error loading data:",e),c.error("Terjadi kesalahan saat memuat data"),_.push("/administrasi/program")}}},R=()=>{_.push("/administrasi/program")},$=async()=>{if(!t.nama_program){c.error("Nama Program wajib diisi");return}try{const r=await T();if(!r){c.error("Gagal mendapatkan CSRF token. Silakan refresh halaman.");return}const o={nama_program:t.nama_program,tipe_pembagian_marketing:t.tipe_pembagian_marketing||null,jumlah_persentase:v.value||null,shares:[]};for(const s of h.value){const i=t.shares[s.key];o.shares.push({program_share_type_key:s.key,program_share_type_id:s.id,name:s.name,type:(i==null?void 0:i.type)||s.default_type||"percentage",value:(i==null?void 0:i.value)!==void 0?(i==null?void 0:i.value)??null:null,orders:s.orders??null})}for(const s of t.customRows)o.shares.push({program_share_type_key:s.key,program_share_type_id:null,name:s.name||null,type:s.type||"percentage",value:s.value!==void 0?s.value??null:null,is_custom:!0});const e=g.value?`/admin/api/program/${y.params.id}`:"/admin/api/program",l=g.value?"PUT":"POST",d=await(await fetch(e,{method:l,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":r},credentials:"same-origin",body:JSON.stringify(o)})).json();if(d.success)c.success(g.value?"Program berhasil diupdate":"Program berhasil ditambahkan"),_.push("/administrasi/program");else if(d.errors){const s=Object.values(d.errors).flat().join(", ");c.error(`Validasi gagal: ${s}`)}else c.error(d.message||"Gagal menyimpan data")}catch(r){console.error("Error saving:",r),c.error("Terjadi kesalahan saat menyimpan data")}};return H(async()=>{await A(),await O()}),(r,o)=>(p(),L(W,null,{default:J(()=>[a("div",z,[a("div",Q,[a("h3",Y,x(M.value),1),a("button",{onClick:R,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),a("form",{onSubmit:C($,["prevent"]),class:"flex flex-col"},[a("div",Z,[a("div",ee,[o[1]||(o[1]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[K(" Nama Program "),a("span",{class:"text-red-500"},"*")],-1)),k(a("input",{type:"text","onUpdate:modelValue":o[0]||(o[0]=e=>t.nama_program=e),placeholder:"Masukkan nama program",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[f,t.nama_program]])]),a("div",ae,[o[3]||(o[3]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Pembagian (DP, OPS 1, OPS 2, Program, Fee Mitra, Bonus, Championship) ",-1)),a("div",te,[a("table",re,[o[2]||(o[2]=a("thead",{class:"bg-gray-50 dark:bg-gray-900"},[a("tr",null,[a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nama"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Tipe"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nilai")])],-1)),a("tbody",null,[(p(!0),m(V,null,F(h.value,e=>(p(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",se,x(e.name),1),a("td",oe,[N(U,{modelValue:t.shares[e.key].type,"onUpdate:modelValue":l=>t.shares[e.key].type=l,options:j,placeholder:"Pilih Tipe","search-input":u[e.key],"onUpdate:searchInput":l=>u[e.key]=l},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",ne,[a("div",le,[k(a("input",{type:"number","onUpdate:modelValue":l=>t.shares[e.key].value=l,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,de),[[f,t.shares[e.key].value,void 0,{number:!0}]]),t.shares[e.key].type==="percentage"?(p(),m("span",ie,"%")):(p(),m("span",pe,"Rp"))])])]))),128)),(p(!0),m(V,null,F(t.customRows,(e,l)=>(p(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",ce,[k(a("input",{"onUpdate:modelValue":n=>e.name=n,placeholder:"Nama",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm"},null,8,ue),[[f,e.name]])]),a("td",me,[N(U,{modelValue:e.type,"onUpdate:modelValue":n=>e.type=n,options:j,placeholder:"Pilih Tipe","search-input":u[e.key],"onUpdate:searchInput":n=>u[e.key]=n},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",ge,[a("div",ye,[k(a("input",{type:"number","onUpdate:modelValue":n=>e.value=n,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,he),[[f,e.value,void 0,{number:!0}]]),e.type==="percentage"?(p(),m("span",_e,"%")):(p(),m("span",be,"Rp")),a("button",{type:"button",onClick:C(()=>B(l),["prevent"]),class:"text-red-500 ml-2"},"Hapus",8,xe)])])]))),128))])])]),a("p",ke,'Jumlah Persentase (hanya menghitung yang tipe "Persentase"): '+x(v.value),1)])]),a("div",fe,[a("div",{class:"flex-1 lg:flex lg:items-center lg:justify-start"},[a("button",{type:"button",onClick:E,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Tambah Baris ")]),a("button",{onClick:R,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"}," Batal "),a("button",ve,x(g.value?"Simpan Perubahan":"Simpan"),1)])],32)])]),_:1}))}});export{Se as default};
