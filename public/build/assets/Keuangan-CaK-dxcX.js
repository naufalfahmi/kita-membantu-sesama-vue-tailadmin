import{d as fe,H as pe,I as be,b,M as ye,A,Q as ve,f as we,X as _e,B as ke,g as xe,o as C,w as De,a as u,j as L,t as K,m as Ce,u as Q,c as N,F as Se,l as Ne,i as Te,S as Re,V as Z}from"./admin-Dkcn-Fr1.js";import{C as Fe}from"./component-DPlpI-Ez.js";import{u as G,w as Ie}from"./xlsx-3SA47z_C.js";import{_ as Ae}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BlnWM0N6.js";import{_ as Ke}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-DbEURa5N.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Be={class:"mb-6 flex items-center justify-between"},Ee={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Me={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},$e={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},ze={class:"relative"},Ve={class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},He={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},je={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Oe={class:"relative",style:{width:"100%",height:"450px"}},Le={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Ge={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},We={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Ue={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Je={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},qe={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},Xe={class:"text-gray-500 dark:text-gray-500 text-sm"},oa=fe({__name:"Keuangan",setup(Ye){const ee=pe();be();const ae=b(String(ee.meta.title||"Keuangan")),P=b(null),T=b(null),W=b(null),M=ye(),{fetchUser:te,hasPermission:$,isAdmin:z}=ve();A(()=>z()||$("create keuangan")),A(()=>z()||$("update keuangan")),A(()=>z()||$("delete keuangan"));const V=b(!1),B=b(null),re={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},R=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:p},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:p},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:p},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:p},{headerName:"Program",field:"program",valueFormatter:p},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:p},{headerName:"Bonus",field:"bonus",valueFormatter:p},{headerName:"Championship",field:"championship",valueFormatter:p}]}],H={resizable:!0,sortable:!0,filter:!1};H.minWidth=120,H.cellClass="text-sm";function p(e){return e&&e.value!==void 0&&e.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e.value):""}const ne=e=>p({value:e});function se(e){switch((e||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(e)}}function U(e,t){var r;const o=se(e);if(o&&o!==String(e))return o;try{for(const n of t||[]){const i=(r=n==null?void 0:n.shares_meta)==null?void 0:r[e];if(i){if(typeof i=="string")return i;if(i.label||i.name||i.title)return i.label||i.name||i.title}if(n&&n.share_labels&&n.share_labels[e])return n.share_labels[e]}}catch{}let l=String(e).replace(/^custom_/,"").replace(/_/g," ");return l=l.replace(/\b\w/g,n=>n.toUpperCase()),l}const x=b([]),J=b([]),y=b((()=>{const e=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],o=[],l=new Date("2024-01-01");for(let r=1;r<=200;r++){const n=(r-1)%e.length,i=(r-1)%t.length,g=new Date(l);g.setDate(g.getDate()+(r-1)*2);const m=Math.floor(Math.random()*75e6)+25e6;o.push({id:r.toString(),pic:e[n],jumlah:m,kantorCabang:t[i],tanggalKeuangan:g.toISOString().split("T")[0]})}return o})()),k=b(""),q=A(()=>y.value),oe=A(()=>q.value.length===0),le=()=>{B.value&&(y.value=y.value.filter(e=>e.id!==B.value),M.success("Data keuangan berhasil dihapus"),V.value=!1,B.value=null,F())},ie=()=>{V.value=!1,B.value=null},ue=()=>{const e=[],t=[],o=[],l=[];let r=0;R.forEach(c=>{if(c.field){const f=c.headerName||c.field;t.push(f),o.push(""),l.push({s:{r:0,c:r},e:{r:1,c:r}}),e.push(c.field),r+=1}else if(c.children&&Array.isArray(c.children)){const f=c.headerName||"",a=c.children.length;for(let s=0;s<a;s++)t.push(s===0?f:"");l.push({s:{r:0,c:r},e:{r:0,c:r+a-1}}),c.children.forEach(s=>{o.push(s.headerName||s.field),e.push(s.field),r+=1})}});const n=[];n.push(t),n.push(o),y.value.forEach(c=>{const f=[];e.forEach(a=>{const s=c[a];f.push(typeof s=="number"?s:s??"")}),n.push(f)}),x.value&&x.value.length&&x.value.forEach(c=>{const f=[];e.forEach(a=>{const s=c[a];f.push(typeof s=="number"?s:s??"")}),n.push(f)});const i=G.aoa_to_sheet(n);i["!merges"]=i["!merges"]||[],l.forEach(c=>i["!merges"].push(c));const g=G.book_new();G.book_append_sheet(g,i,"Keuangan");const h=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ie(g,h)},ce=(e,t)=>{if(!t||t.length===0)return e;const o=[...e];return t.forEach(l=>{const{colId:r,sort:n}=l;o.sort((i,g)=>{let m=i[r],h=g[r];return r==="tanggalKeuangan"?(m=new Date(m).getTime(),h=new Date(h).getTime()):r==="jumlah"?(m=m||0,h=h||0):typeof m=="string"&&(m=m.toLowerCase(),h=h.toLowerCase()),m<h?n==="asc"?-1:1:m>h?n==="asc"?1:-1:0})}),o},E=b({getRows:e=>{setTimeout(()=>{const t=e.startRow||0,o=e.endRow||0;let l=q.value;e.sortModel&&e.sortModel.length>0&&(l=ce(l,e.sortModel));const r=l.slice(t,o);let n;l.length===0?n=0:l.length<=o?n=l.length:n=void 0,e.successCallback(r,n)},50)}}),X=async()=>{var e,t;try{let o="/admin/api/keuangan/program-shares-summary";try{const a=k.value;let s=null,d=null;if(a){if(Array.isArray(a))s=a[0]?a[0]instanceof Date?a[0].toISOString().split("T")[0]:String(a[0]):null,d=a[1]?a[1]instanceof Date?a[1].toISOString().split("T")[0]:String(a[1]):null;else if(typeof a=="string"){const D=a.includes(" to ")?" to ":a.includes(" - ")?" - ":"";if(D){const j=a.split(D);s=((e=j[0])==null?void 0:e.trim())||null,d=((t=j[1])==null?void 0:t.trim())||null}else s=a||null,d=a||null}}const v={};s&&(v.start_date=s),d&&(v.end_date=d);const w=new URLSearchParams(v).toString();w&&(o+=`?${w}`)}catch{}const r=await(await fetch(o,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){M.error("Gagal memuat ringkasan program");return}const n=r.data.rows||[],i=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],g=[];g.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),g.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:p,resizable:!0});const m=r.data&&r.data.share_type_labels?r.data.share_type_labels:{};n.forEach(a=>{const s=[];s.push({headerName:"Nominal Transaksi",field:`p_${a.program_id||a.id}_nominal`,valueFormatter:p,resizable:!0,width:160});const d=i.map(w=>{let D="";try{const O=a.shares_meta||{},_=O[w]||O[w.toString()]||null;if(_)if(_.type==="percentage"&&_.value!==null&&_.value!==void 0){const S=Number(_.value);Number.isFinite(S)?D=Number.isInteger(S)?` (${S}%)`:` (${S%1===0?S:parseFloat(S.toFixed(2))}%)`:D=` (${_.value}%)`}else _.type==="nominal"&&_.value!==null&&_.value!==void 0&&(D=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(_.value)})`)}catch{}return{headerName:`${m[w]||U(w,n)}${D}`,field:`p_${a.program_id||a.id}_${w}`,valueFormatter:p,resizable:!0,minWidth:120}});s.push(...d);const v=`${a.program_name||a.nama_program||a.nama||"Program"}`;g.push({headerName:v,children:s})}),R.splice(0,R.length,...g),Z(()=>{var s;const a=T.value||((s=P.value)==null?void 0:s.api);if(a)try{a.setColumnDefs(R);try{a.setDatasource&&E.value?a.setDatasource(E.value):a.setRowData(y.value)}catch{try{a.setRowData(y.value)}catch{}}a.setPinnedBottomRowData(x.value);try{a.sizeColumnsToFit()}catch{}setTimeout(()=>{try{Y()}catch{}},80)}catch(d){console.error("Failed to apply dynamic columns to grid",d)}});const h={summary_label:"TOTAL"},c=n.reduce((a,s)=>a+(s.total_transaksi||0),0);n.forEach(a=>{const s=`p_${a.program_id||a.id}_nominal`;h[s]=a.total_transaksi||0,i.forEach(d=>{const v=`p_${a.program_id||a.id}_${d}`;h[v]=a[d]||0})}),h.nominal=c;const f=[];f.push({label:"Nominal Keseluruhan Transaksi",value:c}),i.forEach(a=>{const s=n.reduce((v,w)=>v+(Number(w[a]||0)||0),0),d=m[a]||U(a,n);f.push({label:`Nominal All ${d}`,value:s})}),J.value=f,y.value=[h],x.value=[],F(!0)}catch(o){console.error(o),M.error("Terjadi kesalahan saat memuat ringkasan program")}},F=(e=!1)=>{Z(()=>{var o;const t=T.value||((o=P.value)==null?void 0:o.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&E.value?t.setDatasource(E.value):t.setRowData(y.value)}catch{}t.setPinnedBottomRowData(x.value),e&&window.setTimeout(()=>{var r;const l=T.value||((r=P.value)==null?void 0:r.api);if(l)try{l.ensureIndexVisible(0,"top")}catch{}},100)}catch(l){console.error("Error refreshing grid:",l)}})};we(async()=>{await te(),await X(),F()});function de(e){T.value=e.api,W.value=e.columnApi;try{e.api.setRowData&&e.api.setRowData(y.value)}catch{}}function Y(){var l;const e=W.value;if(!e)return;const t=e.getAllColumns();if(!t||!t.length)return;const o=t.map(r=>r.getColId());try{e.autoSizeColumns(o,!1)}catch{try{(l=T.value)==null||l.sizeColumnsToFit()}catch{}}}function me(e){try{e.api.sizeColumnsToFit()}catch{}Y()}_e(()=>{I&&clearTimeout(I)});const he=()=>{F()};let I=null;ke([k],()=>{I&&clearTimeout(I),I=setTimeout(async()=>{try{await X()}catch{}F(!0)},300)});const ge=()=>{k.value=""};return(e,t)=>(C(),xe(Ae,null,{default:De(()=>[u("div",Pe,[u("div",Be,[u("h3",Ee,K(ae.value),1),u("div",{class:"flex items-center gap-3"},[u("button",{onClick:ue,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[u("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[u("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Ce(" Export Excel ",-1)])])])]),u("div",Me,[u("div",$e,[u("div",null,[t[2]||(t[2]=u("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),u("div",ze,[L(Q(Fe),{modelValue:k.value,"onUpdate:modelValue":t[0]||(t[0]=o=>k.value=o),config:re,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),u("div",{class:"mt-4"},[u("button",{onClick:ge,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),u("div",Ve,[(C(!0),N(Se,null,Ne(J.value,(o,l)=>(C(),N("div",{key:`summary-${l}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[u("p",He,K(o.label),1),u("p",je,K(ne(o.value)),1)]))),128))]),u("div",Oe,[u("div",Le,[L(Q(Re),{ref_key:"agGridRef",ref:P,onGridReady:de,onFirstDataRendered:me,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:R,defaultColDef:H,pinnedBottomRowData:x.value,rowData:y.value,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:he},null,8,["pinnedBottomRowData","rowData"])]),oe.value?(C(),N("div",Ge,[(C(),N("svg",We,[e.filterPIC||e.filterKantorCabang||k.value||e.filterJumlahMin||e.filterJumlahMax?(C(),N("path",Ue)):(C(),N("path",Je))])),u("p",qe,K(k.value?"Tidak ada data ditemukan":"Tidak ada data"),1),u("p",Xe,K(k.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Te("",!0)])]),L(Ke,{isOpen:V.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:le,onCancel:ie},null,8,["isOpen"])]),_:1}))}});export{oa as default};
