import{d as Q,H as W,I as aa,L as ea,b as u,A as S,e as ta,f as ra,P as na,B as N,g as oa,o as f,w as sa,a as e,t as w,q as P,c as I,i as j,j as _,m as y,k as $,v as K,F as ia,l as la,u as da}from"./admin-DWWWdAEt.js";import{C as ua}from"./component-BRMjHl6r.js";import{_ as ca}from"./AdminLayout.vue_vue_type_script_setup_true_lang-I_FaATJq.js";import{S as T}from"./SearchableSelect-6WdPU1WG.js";import{A as ma}from"./AsyncSearchableSelect-BqndhEHO.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ga={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},pa={class:"mb-6 flex items-center justify-between"},ba={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},fa={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ya=["value"],ka={key:0,class:"lg:col-span-2"},ha={class:"overflow-x-auto rounded-lg border border-gray-300 bg-white dark:border-gray-700"},xa={class:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300"},va={class:"px-4 py-2 align-top"},wa={class:"font-medium"},Ia={class:"px-4 py-2 align-top text-gray-500 text-sm"},_a={class:"px-4 py-2 align-top text-right font-medium"},ja={class:"flex items-center gap-3"},Ca={class:"flex-1"},Va={class:"relative"},Sa={class:"lg:col-span-2"},Na={class:"flex items-center gap-3 mt-6 lg:justify-end"},Ta=["disabled"],Aa=["disabled"],Ma={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Pa=Q({__name:"TransaksiForm",setup(Da){const k=W(),A=aa(),m=ea(),c=u(null),C=S(()=>{var a,r,n;const s=(n=(r=(a=c.value)==null?void 0:a.role)==null?void 0:r.name)==null?void 0:n.toLowerCase();return s==="fundrising"||s==="fundraising"}),p=S(()=>k.params.id!==void 0&&k.params.id!=="new"),O=S(()=>p.value?"Edit Transaksi":"Tambah Transaksi"),M=u(!1),b=u(!1),G={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},D=u([]),J=u(new Map),F=u([]),U=u([]),h=u(null),x=u(null),v=u([]),B=u(""),R=u(""),V=u(""),t=ta({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),{fetchUser:z}=na(),H=async()=>{try{const s=await fetch("/admin/api/user",{credentials:"same-origin"});if(s.ok){const a=await s.json();a.success&&a.user&&(c.value=a.user)}}catch(s){console.error("Error fetching current user:",s)}},X=async()=>{try{const s=(()=>{if(!c.value)return!1;const o=c.value.roles||(c.value.role?[c.value.role]:[]);return Array.isArray(o)&&o.some(i=>{const l=typeof i=="string"?i:i==null?void 0:i.name;return typeof l=="string"&&l.trim().toLowerCase()==="admin cabang"})})(),r=!!(c.value&&c.value.is_admin)&&!s?"/admin/api/kantor-cabang?per_page=1000":"/admin/api/kantor-cabang?per_page=1000&only_assigned=1",[n,d]=await Promise.all([fetch(r,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(n.ok){const o=await n.json(),i=o.success&&o.data?Array.isArray(o.data)?o.data:o.data.data||[]:[];D.value=i.map(l=>({value:l.id,label:l.nama})),J.value=new Map(i.map(l=>[l.id,l]))}if(d.ok){const o=await d.json(),i=o.success&&o.data?Array.isArray(o.data)?o.data:o.data.data||[]:[];F.value=i.map(l=>({value:l.id,label:l.nama_program}))}try{const o=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(o.ok){const i=await o.json(),l=i.success&&i.data?Array.isArray(i.data)?i.data:i.data.data||[]:[];U.value=l.map(g=>({value:g.id,label:g.nama||g.name||""}))}}catch{}}catch(s){console.error("Error fetching options:",s),m.error("Gagal memuat data opsi")}},Y=async()=>{if(p.value&&k.params.id){M.value=!0;try{const s=k.params.id,a=await fetch(`/admin/api/transaksi/${s}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const r=await a.json();if(r.success&&r.data){const n=r.data;t.branchId=n.kantor_cabang_id||"",t.nominal=n.nominal,t.donorId=n.donatur_id||"",t.programId=n.program_id||"",t.mitraId=n.mitra_id||"",t.transactionDate=n.tanggal_transaksi||"",t.notes=n.keterangan||""}}catch(s){console.error("Error loading transaksi:",s),m.error("Gagal memuat data transaksi")}finally{M.value=!1}}},E=()=>{A.push("/keuangan/transaksi")},q=()=>{t.mitraId=null,V.value=""},Z=async()=>{var s;if(!t.branchId){m.warning("Kantor Cabang wajib diisi");return}if(!t.nominal||t.nominal<=0){m.warning("Nominal wajib diisi");return}if(!t.donorId){m.warning("Donatur wajib diisi");return}if(!t.programId){m.warning("Program wajib diisi");return}if(!t.transactionDate){m.warning("Tanggal transaksi wajib diisi");return}b.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const r=await a.json(),n={kantor_cabang_id:t.branchId,nominal:t.nominal,donatur_id:t.donorId,program_id:t.programId,mitra_id:t.mitraId||null,tanggal_transaksi:t.transactionDate,keterangan:t.notes||null};C.value&&((s=c.value)!=null&&s.id)&&(n.fundraiser_id=c.value.id);let d;p.value?d=await fetch(`/admin/api/transaksi/${k.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r.csrf_token},credentials:"same-origin",body:JSON.stringify(n)}):d=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r.csrf_token},credentials:"same-origin",body:JSON.stringify(n)});const o=await d.json();if(o.success)m.success(o.message||(p.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),A.push("/keuangan/transaksi");else if(o.errors){const i=Object.values(o.errors).flat().join(", ");m.error(i)}else m.error(o.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}finally{b.value=!1}};ra(async()=>{var s,a;await z(),await H(),await X(),await Y(),C.value&&!p.value&&(a=(s=c.value)==null?void 0:s.kantor_cabang)!=null&&a.id&&(t.branchId=String(c.value.kantor_cabang.id))}),N(()=>t.donorId,async s=>{if(h.value=null,t.fundraiserId="",!!s)try{const a=await fetch(`/admin/api/donatur/${s}`,{credentials:"same-origin"});if(!a.ok)return;const r=await a.json();if(r.success&&r.data){const n=r.data;n.pic_user?(h.value={id:n.pic_user.id,name:n.pic_user.nama},t.fundraiserId=n.pic_user.id):n.pic&&(h.value={id:n.pic,name:""},t.fundraiserId=n.pic),n.mitra&&n.mitra.id?t.mitraId=String(n.mitra.id):n.mitra_id&&(t.mitraId=String(n.mitra_id))}}catch(a){console.error("Failed to load donor details:",a)}});const L=()=>{v.value=[];const s=Number(t.nominal)||0;if(!x.value||!Array.isArray(x.value.shares))return;const a=n=>n?String(n).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "):"",r=n=>{if(n==null)return null;const d=Number(n);return Number.isNaN(d)?null:d};v.value=x.value.shares.map(n=>{const d=(n.type||"percentage")==="percentage",o=r(n.value),i=d&&o!==null?Math.round(Number(s*(o/100))):o!==null?Math.round(o):0,l=n.name||(n.program_share_type_key?a(n.program_share_type_key):"-");let g="-";return o!==null&&(d?g=Number.isInteger(o)?`${o}%`:`${parseFloat(String(o)).toFixed(2).replace(/\.00$/,"")}%`:g=Number(o).toLocaleString()),{name:l,type:n.type||"percentage",value:o,amount:i,displayValue:g}})};return N(()=>t.programId,async s=>{if(x.value=null,v.value=[],!!s)try{const a=await fetch(`/admin/api/program/${s}`,{credentials:"same-origin"});if(!a.ok)return;const r=await a.json();r.success&&r.data&&(x.value=r.data,L())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),N(()=>t.nominal,()=>{L()}),(s,a)=>(f(),oa(ca,null,{default:sa(()=>[e("div",ga,[e("div",pa,[e("h3",ba,w(O.value),1),e("button",{onClick:E,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),e("form",{onSubmit:P(Z,["prevent"]),class:"flex flex-col"},[e("div",fa,[e("div",null,[a[11]||(a[11]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[y(" Kantor Cabang "),e("span",{class:"text-red-500"},"*")],-1)),_(T,{modelValue:t.branchId,"onUpdate:modelValue":a[0]||(a[0]=r=>t.branchId=r),options:D.value,placeholder:"Kantor Cabang","search-input":B.value,"onUpdate:searchInput":a[1]||(a[1]=r=>B.value=r),disabled:C.value},null,8,["modelValue","options","search-input","disabled"])]),e("div",null,[a[12]||(a[12]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[y(" Nominal "),e("span",{class:"text-red-500"},"*")],-1)),$(e("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=r=>t.nominal=r),placeholder:"Nominal",min:"0",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[K,t.nominal,void 0,{number:!0}]])]),e("div",null,[a[13]||(a[13]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[y(" Donatur "),e("span",{class:"text-red-500"},"*")],-1)),_(ma,{modelValue:t.donorId,"onUpdate:modelValue":a[3]||(a[3]=r=>t.donorId=r),"fetch-url":"/admin/api/donatur",placeholder:"Donatur"},null,8,["modelValue"])]),e("div",null,[a[14]||(a[14]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),e("input",{type:"text",value:h.value?h.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,ya),j("",!0)]),e("div",null,[a[15]||(a[15]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[y(" Program "),e("span",{class:"text-red-500"},"*")],-1)),_(T,{modelValue:t.programId,"onUpdate:modelValue":a[5]||(a[5]=r=>t.programId=r),options:F.value,placeholder:"Program","search-input":R.value,"onUpdate:searchInput":a[6]||(a[6]=r=>R.value=r)},null,8,["modelValue","options","search-input"])]),v.value.length>0?(f(),I("div",ka,[a[17]||(a[17]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rincian Pembagian Program",-1)),e("div",ha,[e("table",xa,[a[16]||(a[16]=e("thead",{class:"bg-gray-50 dark:bg-gray-800"},[e("tr",null,[e("th",{class:"px-4 py-2 font-medium"},"Nama"),e("th",{class:"px-4 py-2 font-medium"},"Nilai"),e("th",{class:"px-4 py-2 font-medium text-right"},"Jumlah (Rp)")])],-1)),e("tbody",null,[(f(!0),I(ia,null,la(v.value,(r,n)=>(f(),I("tr",{key:n,class:"border-t border-gray-100 dark:border-gray-800"},[e("td",va,[e("div",wa,w(r.name),1)]),e("td",Ia,w(r.displayValue),1),e("td",_a,"Rp "+w(r.amount.toLocaleString()),1)]))),128))])])])])):j("",!0),e("div",null,[a[19]||(a[19]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),e("div",ja,[e("div",Ca,[_(T,{modelValue:t.mitraId,"onUpdate:modelValue":a[7]||(a[7]=r=>t.mitraId=r),options:U.value,placeholder:"Mitra (opsional)","search-input":V.value,"onUpdate:searchInput":a[8]||(a[8]=r=>V.value=r)},null,8,["modelValue","options","search-input"])]),t.mitraId?(f(),I("button",{key:0,type:"button",title:"Hapus Mitra",onClick:P(q,["stop"]),class:"h-10 w-10 flex items-center justify-center rounded-lg border border-gray-300 bg-white text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-300"},[...a[18]||(a[18]=[e("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M18 6L6 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M6 6L18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])])):j("",!0)])]),e("div",null,[a[21]||(a[21]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[y(" Tanggal Transaksi "),e("span",{class:"text-red-500"},"*")],-1)),e("div",Va,[_(da(ua),{modelValue:t.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=r=>t.transactionDate=r),config:G,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[20]||(a[20]=e("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[e("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),e("div",Sa,[a[22]||(a[22]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),$(e("textarea",{"onUpdate:modelValue":a[10]||(a[10]=r=>t.notes=r),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[K,t.notes]]),a[23]||(a[23]=e("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),e("div",Na,[e("button",{onClick:E,type:"button",disabled:b.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,Ta),e("button",{type:"submit",disabled:b.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[b.value?(f(),I("svg",Ma,[...a[24]||(a[24]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):j("",!0),y(" "+w(b.value?"Menyimpan...":p.value?"Simpan Perubahan":"Simpan"),1)],8,Aa)])],32)])]),_:1}))}});export{Pa as default};
