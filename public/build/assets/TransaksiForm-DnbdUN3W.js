import{d as Y,H as q,I as Z,L as Q,b as i,A as j,e as W,f as aa,B as C,g as ea,o as k,w as ra,a as r,t as x,q as ta,c as v,i as V,j as h,m as p,k as P,v as $,F as na,l as sa,u as oa}from"./admin-D1yXdFtM.js";import{C as la}from"./component-Hk3v1wIn.js";import{_ as ia}from"./AdminLayout.vue_vue_type_script_setup_true_lang-DrTR74V6.js";import{S as N}from"./SearchableSelect-BuJ2Z-dj.js";import{A as da}from"./AsyncSearchableSelect-CbWuxfUc.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ua={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ca={class:"mb-6 flex items-center justify-between"},ma={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},pa={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ga=["value"],ba={key:0,class:"lg:col-span-2"},fa={class:"overflow-x-auto rounded-lg border border-gray-300 bg-white dark:border-gray-700"},ya={class:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300"},ka={class:"px-4 py-2 align-top"},xa={class:"font-medium"},ha={class:"px-4 py-2 align-top text-gray-500 text-sm"},va={class:"px-4 py-2 align-top text-right font-medium"},wa={class:"relative"},Ia={class:"lg:col-span-2"},_a={class:"flex items-center gap-3 mt-6 lg:justify-end"},ja=["disabled"],Ca=["disabled"],Va={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ua=Y({__name:"TransaksiForm",setup(Na){const g=q(),S=Z(),d=Q(),u=i(null),w=j(()=>{var a,e,t;const s=(t=(e=(a=u.value)==null?void 0:a.role)==null?void 0:e.name)==null?void 0:t.toLowerCase();return s==="fundrising"||s==="fundraising"}),c=j(()=>g.params.id!==void 0&&g.params.id!=="new"),L=j(()=>c.value?"Edit Transaksi":"Tambah Transaksi"),T=i(!1),m=i(!1),K={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},D=i([]),O=i(new Map),M=i([]),F=i([]),b=i(null),f=i(null),y=i([]),A=i(""),U=i(""),B=i(""),n=W({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),J=async()=>{try{const s=await fetch("/admin/api/user",{credentials:"same-origin"});if(s.ok){const a=await s.json();a.success&&a.user&&(u.value=a.user)}}catch(s){console.error("Error fetching current user:",s)}},z=async()=>{try{const[s,a]=await Promise.all([fetch("/admin/api/kantor-cabang?per_page=1000&only_assigned=1",{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(s.ok){const e=await s.json(),t=e.success&&e.data?Array.isArray(e.data)?e.data:e.data.data||[]:[];D.value=t.map(l=>({value:l.id,label:l.nama})),O.value=new Map(t.map(l=>[l.id,l]))}if(a.ok){const e=await a.json(),t=e.success&&e.data?Array.isArray(e.data)?e.data:e.data.data||[]:[];M.value=t.map(l=>({value:l.id,label:l.nama_program}))}try{const e=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(e.ok){const t=await e.json(),l=t.success&&t.data?Array.isArray(t.data)?t.data:t.data.data||[]:[];F.value=l.map(o=>({value:o.id,label:o.nama||o.name||""}))}}catch{}}catch(s){console.error("Error fetching options:",s),d.error("Gagal memuat data opsi")}},G=async()=>{if(c.value&&g.params.id){T.value=!0;try{const s=g.params.id,a=await fetch(`/admin/api/transaksi/${s}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const e=await a.json();if(e.success&&e.data){const t=e.data;n.branchId=t.kantor_cabang_id||"",n.nominal=t.nominal,n.donorId=t.donatur_id||"",n.programId=t.program_id||"",n.mitraId=t.mitra_id||"",n.transactionDate=t.tanggal_transaksi||"",n.notes=t.keterangan||""}}catch(s){console.error("Error loading transaksi:",s),d.error("Gagal memuat data transaksi")}finally{T.value=!1}}},E=()=>{S.push("/keuangan/transaksi")},H=async()=>{var s;if(!n.branchId){d.warning("Kantor Cabang wajib diisi");return}if(!n.nominal||n.nominal<=0){d.warning("Nominal wajib diisi");return}if(!n.donorId){d.warning("Donatur wajib diisi");return}if(!n.programId){d.warning("Program wajib diisi");return}if(!n.transactionDate){d.warning("Tanggal transaksi wajib diisi");return}m.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const e=await a.json(),t={kantor_cabang_id:n.branchId,nominal:n.nominal,donatur_id:n.donorId,program_id:n.programId,mitra_id:n.mitraId||null,tanggal_transaksi:n.transactionDate,keterangan:n.notes||null};w.value&&((s=u.value)!=null&&s.id)&&(t.fundraiser_id=u.value.id);let l;c.value?l=await fetch(`/admin/api/transaksi/${g.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":e.csrf_token},credentials:"same-origin",body:JSON.stringify(t)}):l=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":e.csrf_token},credentials:"same-origin",body:JSON.stringify(t)});const o=await l.json();if(o.success)d.success(o.message||(c.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),S.push("/keuangan/transaksi");else if(o.errors){const I=Object.values(o.errors).flat().join(", ");d.error(I)}else d.error(o.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),d.error("Terjadi kesalahan saat menyimpan data")}finally{m.value=!1}};aa(async()=>{var s,a;await J(),await z(),await G(),w.value&&!c.value&&(a=(s=u.value)==null?void 0:s.kantor_cabang)!=null&&a.id&&(n.branchId=String(u.value.kantor_cabang.id))}),C(()=>n.donorId,async s=>{if(b.value=null,n.fundraiserId="",!!s)try{const a=await fetch(`/admin/api/donatur/${s}`,{credentials:"same-origin"});if(!a.ok)return;const e=await a.json();if(e.success&&e.data){const t=e.data;t.pic_user?(b.value={id:t.pic_user.id,name:t.pic_user.nama},n.fundraiserId=t.pic_user.id):t.pic&&(b.value={id:t.pic,name:""},n.fundraiserId=t.pic)}}catch(a){console.error("Failed to load donor details:",a)}});const R=()=>{y.value=[];const s=Number(n.nominal)||0;if(!f.value||!Array.isArray(f.value.shares))return;const a=t=>t?String(t).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" "):"",e=t=>{if(t==null)return null;const l=Number(t);return Number.isNaN(l)?null:l};y.value=f.value.shares.map(t=>{const l=(t.type||"percentage")==="percentage",o=e(t.value),I=l&&o!==null?Math.round(Number(s*(o/100))):o!==null?Math.round(o):0,X=t.name||(t.program_share_type_key?a(t.program_share_type_key):"-");let _="-";return o!==null&&(l?_=Number.isInteger(o)?`${o}%`:`${parseFloat(String(o)).toFixed(2).replace(/\.00$/,"")}%`:_=Number(o).toLocaleString()),{name:X,type:t.type||"percentage",value:o,amount:I,displayValue:_}})};return C(()=>n.programId,async s=>{if(f.value=null,y.value=[],!!s)try{const a=await fetch(`/admin/api/program/${s}`,{credentials:"same-origin"});if(!a.ok)return;const e=await a.json();e.success&&e.data&&(f.value=e.data,R())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),C(()=>n.nominal,()=>{R()}),(s,a)=>(k(),ea(ia,null,{default:ra(()=>[r("div",ua,[r("div",ca,[r("h3",ma,x(L.value),1),r("button",{onClick:E,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),r("form",{onSubmit:ta(H,["prevent"]),class:"flex flex-col"},[r("div",pa,[r("div",null,[a[11]||(a[11]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[p(" Kantor Cabang "),r("span",{class:"text-red-500"},"*")],-1)),h(N,{modelValue:n.branchId,"onUpdate:modelValue":a[0]||(a[0]=e=>n.branchId=e),options:D.value,placeholder:"Kantor Cabang","search-input":A.value,"onUpdate:searchInput":a[1]||(a[1]=e=>A.value=e),disabled:w.value},null,8,["modelValue","options","search-input","disabled"])]),r("div",null,[a[12]||(a[12]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[p(" Nominal "),r("span",{class:"text-red-500"},"*")],-1)),P(r("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=e=>n.nominal=e),placeholder:"Nominal",min:"0",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,n.nominal,void 0,{number:!0}]])]),r("div",null,[a[13]||(a[13]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[p(" Donatur "),r("span",{class:"text-red-500"},"*")],-1)),h(da,{modelValue:n.donorId,"onUpdate:modelValue":a[3]||(a[3]=e=>n.donorId=e),"fetch-url":"/admin/api/donatur",placeholder:"Donatur"},null,8,["modelValue"])]),r("div",null,[a[14]||(a[14]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),r("input",{type:"text",value:b.value?b.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,ga),V("",!0)]),r("div",null,[a[15]||(a[15]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[p(" Program "),r("span",{class:"text-red-500"},"*")],-1)),h(N,{modelValue:n.programId,"onUpdate:modelValue":a[5]||(a[5]=e=>n.programId=e),options:M.value,placeholder:"Program","search-input":U.value,"onUpdate:searchInput":a[6]||(a[6]=e=>U.value=e)},null,8,["modelValue","options","search-input"])]),y.value.length>0?(k(),v("div",ba,[a[17]||(a[17]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rincian Pembagian Program",-1)),r("div",fa,[r("table",ya,[a[16]||(a[16]=r("thead",{class:"bg-gray-50 dark:bg-gray-800"},[r("tr",null,[r("th",{class:"px-4 py-2 font-medium"},"Nama"),r("th",{class:"px-4 py-2 font-medium"},"Nilai"),r("th",{class:"px-4 py-2 font-medium text-right"},"Jumlah (Rp)")])],-1)),r("tbody",null,[(k(!0),v(na,null,sa(y.value,(e,t)=>(k(),v("tr",{key:t,class:"border-t border-gray-100 dark:border-gray-800"},[r("td",ka,[r("div",xa,x(e.name),1)]),r("td",ha,x(e.displayValue),1),r("td",va,"Rp "+x(e.amount.toLocaleString()),1)]))),128))])])])])):V("",!0),r("div",null,[a[18]||(a[18]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),h(N,{modelValue:n.mitraId,"onUpdate:modelValue":a[7]||(a[7]=e=>n.mitraId=e),options:F.value,placeholder:"Mitra (opsional)","search-input":B.value,"onUpdate:searchInput":a[8]||(a[8]=e=>B.value=e)},null,8,["modelValue","options","search-input"])]),r("div",null,[a[20]||(a[20]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[p(" Tanggal Transaksi "),r("span",{class:"text-red-500"},"*")],-1)),r("div",wa,[h(oa(la),{modelValue:n.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=e=>n.transactionDate=e),config:K,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[19]||(a[19]=r("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[r("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[r("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),r("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),r("div",Ia,[a[21]||(a[21]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),P(r("textarea",{"onUpdate:modelValue":a[10]||(a[10]=e=>n.notes=e),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,n.notes]]),a[22]||(a[22]=r("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),r("div",_a,[r("button",{onClick:E,type:"button",disabled:m.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,ja),r("button",{type:"submit",disabled:m.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[m.value?(k(),v("svg",Va,[...a[23]||(a[23]=[r("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),r("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):V("",!0),p(" "+x(m.value?"Menyimpan...":c.value?"Simpan Perubahan":"Simpan"),1)],8,Ca)])],32)])]),_:1}))}});export{Ua as default};
