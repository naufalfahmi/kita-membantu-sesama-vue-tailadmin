import{d as I,b as R,H as J,I as X,M as G,A as x,e as S,B as H,f as L,g as z,o as p,w as K,a,t as _,q as C,k as v,m as W,v as w,c as m,F as N,l as V,j as F,n as Q}from"./admin-BlGUh0eZ.js";import{_ as Y}from"./AdminLayout.vue_vue_type_script_setup_true_lang-z-bM49vL.js";import{S as U}from"./SearchableSelect-BnfFi4ku.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Z={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ee={class:"mb-6 flex items-center justify-between"},ae={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},te={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},re={class:"lg:col-span-2"},se={class:"lg:col-span-2"},oe={class:"overflow-x-auto mt-2"},ne={class:"w-full table-auto border border-gray-200 dark:border-gray-800 rounded-md"},le={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},de={class:"px-4 py-3"},ie={class:"px-4 py-3"},pe={class:"flex items-center gap-2"},ue=["onUpdate:modelValue"],ce={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},me={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},ge={class:"px-4 py-3 text-sm text-gray-700 dark:text-gray-400"},ye=["onUpdate:modelValue"],he={class:"px-4 py-3"},be={class:"px-4 py-3"},xe={class:"flex items-center gap-2"},_e=["onUpdate:modelValue"],ke={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},fe={key:1,class:"text-sm text-gray-600 dark:text-gray-400"},ve=["onClick"],we={class:"mt-2 text-xs text-gray-500 dark:text-gray-400"},je={class:"flex items-center gap-3 mt-6 lg:justify-end"},Te={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Pe={class:"fixed right-6 bottom-6 z-50"},Re=["title"],Se={class:"text-lg font-semibold"},Me=I({__name:"ProgramForm",setup(Ce){R("");const h=J(),k=X(),u=G(),g=x(()=>h.params.id!==void 0&&h.params.id!=="new"),M=x(()=>g.value?"Edit Program":"Tambah Program"),r=S({nama_program:"",tipe_pembagian_marketing:"",jumlah_persentase:null,shares:{},customRows:[]}),b=R([]),c=S({}),j=[{value:"percentage",label:"Persentase"},{value:"nominal",label:"Nominal"}],y=x(()=>{let t=0;for(const s of Object.keys(r.shares)){const e=r.shares[s];e&&e.type==="percentage"&&e.value!==null&&!Number.isNaN(e.value)&&(t+=Number(e.value))}return t>0?parseFloat(t.toFixed(2)):0});H(()=>y.value,t=>{r.jumlah_persentase=t},{immediate:!0});const A=x(()=>{const t=Number(y.value||0);return Number.isInteger(t)?`${t}%`:t.toFixed(2)+"%"}),B=x(()=>Number(y.value||0)>100?"bg-red-500 hover:bg-red-600":"bg-brand-500 hover:bg-brand-600"),E=async()=>{try{const t=await fetch("/admin/api/program-share-types",{credentials:"same-origin"});if(!t.ok)return;const s=await t.json();if(s.success&&Array.isArray(s.data)){b.value=s.data.slice().sort((e,l)=>{const n=e.orders??0,d=l.orders??0;return n-d});for(const e of b.value)r.shares[e.key]||(r.shares[e.key]={type:e.default_type||"percentage",value:null}),c[e.key]===void 0&&(c[e.key]="");Array.isArray(r.customRows)||(r.customRows=[])}}catch(t){console.error("Failed to load program share types:",t)}},T=async()=>{var t;try{const s=(t=document.querySelector('meta[name="csrf-token"]'))==null?void 0:t.getAttribute("content");if(s)return s;const e=await fetch("/admin/api/csrf-token",{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Failed to get CSRF token: ${e.status}`);return(await e.json()).csrf_token||""}catch(s){return console.error("Failed to get CSRF token:",s),""}},O=()=>{const t=`custom_${Date.now()}`;r.customRows.push({key:t,name:"",type:"percentage",value:null}),c[t]=""},$=t=>{r.customRows.splice(t,1)},q=async()=>{var t;if(g.value&&h.params.id){const s=h.params.id;try{const e=await T(),n=await(await fetch(`/admin/api/program/${s}`,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":e},credentials:"same-origin"})).json();if(n.success&&n.data){const d=n.data;if(r.nama_program=d.nama_program||"",r.tipe_pembagian_marketing=d.tipe_pembagian_marketing||"",r.jumlah_persentase=d.jumlah_persentase?parseFloat(d.jumlah_persentase):null,Array.isArray(d.shares)){r.customRows=[];for(const o of d.shares){const i=o.program_share_type_key||(o.program_share_type_id?(t=b.value.find(f=>f.id===o.program_share_type_id))==null?void 0:t.key:null);if(i&&r.shares[i]!==void 0)r.shares[i]={type:o.type||"percentage",value:o.value!==null?parseFloat(o.value):null};else{const f=o.program_share_type_key||`custom_${Date.now()}_${Math.floor(Math.random()*1e3)}`;r.customRows.push({key:f,name:o.name||"",type:o.type||"percentage",value:o.value!==null?parseFloat(o.value):null}),c[f]=""}}}}else u.error("Gagal memuat data program"),k.push("/administrasi/program")}catch(e){console.error("Error loading data:",e),u.error("Terjadi kesalahan saat memuat data"),k.push("/administrasi/program")}}},P=()=>{k.push("/administrasi/program")},D=async()=>{if(!r.nama_program){u.error("Nama Program wajib diisi");return}try{const t=await T();if(!t){u.error("Gagal mendapatkan CSRF token. Silakan refresh halaman.");return}const s={nama_program:r.nama_program,tipe_pembagian_marketing:r.tipe_pembagian_marketing||null,jumlah_persentase:y.value||null,shares:[]};for(const o of b.value){const i=r.shares[o.key];s.shares.push({program_share_type_key:o.key,program_share_type_id:o.id,name:o.name,type:(i==null?void 0:i.type)||o.default_type||"percentage",value:(i==null?void 0:i.value)!==void 0?(i==null?void 0:i.value)??null:null,orders:o.orders??null})}for(const o of r.customRows)s.shares.push({program_share_type_key:o.key,program_share_type_id:null,name:o.name||null,type:o.type||"percentage",value:o.value!==void 0?o.value??null:null,is_custom:!0});const e=g.value?`/admin/api/program/${h.params.id}`:"/admin/api/program",l=g.value?"PUT":"POST",d=await(await fetch(e,{method:l,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":t},credentials:"same-origin",body:JSON.stringify(s)})).json();if(d.success)u.success(g.value?"Program berhasil diupdate":"Program berhasil ditambahkan"),k.push("/administrasi/program");else if(d.errors){const o=Object.values(d.errors).flat().join(", ");u.error(`Validasi gagal: ${o}`)}else u.error(d.message||"Gagal menyimpan data")}catch(t){console.error("Error saving:",t),u.error("Terjadi kesalahan saat menyimpan data")}};return L(async()=>{await E(),await q()}),(t,s)=>(p(),z(Y,null,{default:K(()=>[a("div",Z,[a("div",ee,[a("h3",ae,_(M.value),1),a("button",{onClick:P,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),a("form",{onSubmit:C(D,["prevent"]),class:"flex flex-col"},[a("div",te,[a("div",re,[s[1]||(s[1]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[W(" Nama Program "),a("span",{class:"text-red-500"},"*")],-1)),v(a("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=e=>r.nama_program=e),placeholder:"Masukkan nama program",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[w,r.nama_program]])]),a("div",se,[s[3]||(s[3]=a("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Pembagian (DP, OPS 1, OPS 2, Program, Fee Mitra, Bonus, Championship) ",-1)),a("div",oe,[a("table",ne,[s[2]||(s[2]=a("thead",{class:"bg-gray-50 dark:bg-gray-900"},[a("tr",null,[a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nama"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Tipe"),a("th",{class:"text-left px-4 py-2 text-sm text-gray-600 dark:text-gray-300"},"Nilai")])],-1)),a("tbody",null,[(p(!0),m(N,null,V(b.value,e=>(p(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",le,_(e.name),1),a("td",de,[F(U,{modelValue:r.shares[e.key].type,"onUpdate:modelValue":l=>r.shares[e.key].type=l,options:j,placeholder:"Pilih Tipe","search-input":c[e.key],"onUpdate:searchInput":l=>c[e.key]=l},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",ie,[a("div",pe,[v(a("input",{type:"number","onUpdate:modelValue":l=>r.shares[e.key].value=l,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,ue),[[w,r.shares[e.key].value,void 0,{number:!0}]]),r.shares[e.key].type==="percentage"?(p(),m("span",ce,"%")):(p(),m("span",me,"Rp"))])])]))),128)),(p(!0),m(N,null,V(r.customRows,(e,l)=>(p(),m("tr",{key:e.key,class:"border-t border-gray-100 dark:border-gray-800"},[a("td",ge,[v(a("input",{"onUpdate:modelValue":n=>e.name=n,placeholder:"Nama",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm"},null,8,ye),[[w,e.name]])]),a("td",he,[F(U,{modelValue:e.type,"onUpdate:modelValue":n=>e.type=n,options:j,placeholder:"Pilih Tipe","search-input":c[e.key],"onUpdate:searchInput":n=>c[e.key]=n},null,8,["modelValue","onUpdate:modelValue","search-input","onUpdate:searchInput"])]),a("td",be,[a("div",xe,[v(a("input",{type:"number","onUpdate:modelValue":n=>e.value=n,placeholder:"0",min:"0",step:"0.01",class:"h-10 w-full rounded-lg border border-gray-300 px-3 text-sm dark:bg-gray-900"},null,8,_e),[[w,e.value,void 0,{number:!0}]]),e.type==="percentage"?(p(),m("span",ke,"%")):(p(),m("span",fe,"Rp")),a("button",{type:"button",onClick:C(()=>$(l),["prevent"]),class:"text-red-500 ml-2"},"Hapus",8,ve)])])]))),128))])])]),a("p",we,'Jumlah Persentase (hanya menghitung yang tipe "Persentase"): '+_(y.value),1)])]),a("div",je,[a("div",{class:"flex-1 lg:flex lg:items-center lg:justify-start"},[a("button",{type:"button",onClick:O,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Tambah Baris ")]),a("button",{onClick:P,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"}," Batal "),a("button",Te,_(g.value?"Simpan Perubahan":"Simpan"),1)])],32)]),a("div",Pe,[a("button",{title:y.value>100?"Jumlah persentase melebihi 100%":"Jumlah persentase",class:Q(["flex items-center gap-3 px-4 py-3 rounded-lg text-white shadow-lg",B.value])},[s[4]||(s[4]=a("span",{class:"text-sm"},"Jumlah Persentase",-1)),a("span",Se,_(A.value),1)],10,Re)])]),_:1}))}});export{Me as default};
