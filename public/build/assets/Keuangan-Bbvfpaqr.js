import{d as De,H as Se,I as Ce,b as g,M as Ne,A as $,Q as Te,f as Fe,X as Pe,B as Re,g as Ke,o as v,w as Ae,a as s,j as O,c as p,i as j,t as k,m as ue,u as Ie,F as Z,l as ee,V as de}from"./admin-CP3xNH-B.js";import{C as Me}from"./component-BygBhH5i.js";import{u as ae,w as $e}from"./xlsx-3SA47z_C.js";import{_ as Be}from"./AdminLayout.vue_vue_type_script_setup_true_lang-A0mRaxhO.js";import{_ as Ve}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-B1qUpxO1.js";import{A as ce}from"./AsyncSearchableSelect-DlKEIZ10.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ze={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Ee={class:"mb-6 flex items-center justify-between"},Oe={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},je={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},He={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-3"},Le={class:"relative"},Ue={key:0,class:"mb-6 flex items-center justify-center gap-3 rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.02]"},Ge={key:1,class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},We={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},qe={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Xe={class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ye={class:"grid gap-4 md:grid-cols-2 lg:grid-cols-3"},Je={class:"bg-gray-100 dark:bg-gray-800/50 px-4 py-3 border-b border-gray-200 dark:border-gray-700"},Qe={class:"flex items-center justify-between"},Ze={class:"font-semibold text-gray-800 dark:text-white/90"},ea={class:"overflow-x-auto"},aa={class:"w-full"},ta={class:"divide-y divide-gray-200 dark:divide-gray-700"},ra={class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},sa={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},oa={class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},la={key:0,class:"text-xs text-gray-500 ml-2"},na={key:1,class:"text-xs text-gray-500 ml-2"},ia={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},ua={key:0,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},da={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},ka=De({__name:"Keuangan",setup(ca){const me=Se();Ce();const ge=g(String(me.meta.title||"Keuangan")),H=g(null),B=g(null),he=g(null),R=Ne(),{fetchUser:be,hasPermission:L,isAdmin:U}=Te();$(()=>U()||L("create keuangan")),$(()=>U()||L("update keuangan")),$(()=>U()||L("delete keuangan"));const G=g(!1),V=g(null),z=g(!1),fe={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},W=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:h},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:h},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:h},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:h},{headerName:"Program",field:"program",valueFormatter:h},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:h},{headerName:"Bonus",field:"bonus",valueFormatter:h},{headerName:"Championship",field:"championship",valueFormatter:h}]}];function h(t){return t&&t.value!==void 0&&t.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t.value):""}const K=t=>h({value:t}),te=t=>{if(t==null)return"";const a=Number(t);return Number.isFinite(a)?Number.isInteger(a)?`${a}%`:`${parseFloat(a.toFixed(2))}%`:`${String(t)}%`};function re(t){switch((t||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(t)}}function ye(t){return String(t||"").replace(/^custom_/,"")}function q(t,a){var i,b;const e=ye(t);try{if(x.value&&(x.value[t]||x.value[e]))return x.value[t]||x.value[e]}catch{}const o=re(e);if(o&&o!==String(e))return o;try{for(const u of a||[]){if(!u)continue;const l=((i=u==null?void 0:u.shares_meta)==null?void 0:i[t])||((b=u==null?void 0:u.shares_meta)==null?void 0:b[e]);if(l){if(typeof l=="string")return l;if(l.label||l.name||l.title)return l.label||l.name||l.title}if(u&&u.share_labels&&(u.share_labels[t]||u.share_labels[e]))return u.share_labels[t]||u.share_labels[e]}}catch{}let n=String(e).replace(/_/g," ");return n=n.replace(/\b\w/g,u=>u.toUpperCase()),n}const X=g([]),S=g([]),C=g([]),x=g({}),se=g([]),D=g((()=>{const t=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],a=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],e=[],o=new Date("2024-01-01");for(let n=1;n<=200;n++){const i=(n-1)%t.length,b=(n-1)%a.length,u=new Date(o);u.setDate(u.getDate()+(n-1)*2);const l=Math.floor(Math.random()*75e6)+25e6;e.push({id:n.toString(),pic:t[i],jumlah:l,kantorCabang:a[b],tanggalKeuangan:u.toISOString().split("T")[0]})}return e})()),A=g(""),N=g(""),T=g(""),oe=$(()=>D.value);$(()=>oe.value.length===0);const ve=()=>{V.value&&(D.value=D.value.filter(t=>t.id!==V.value),R.success("Data keuangan berhasil dihapus"),G.value=!1,V.value=null,I())},pe=()=>{G.value=!1,V.value=null},le=t=>{if(!t)return 0;const a=Number(t.total_transaksi||0),e=(C.value||[]).reduce((o,n)=>{const i=Number((t==null?void 0:t[n])||0);return o+(Number.isFinite(i)?i:0)},0);return Math.max(0,a-e)},xe=async()=>{try{await Y(),I(!0),R.success("Data berhasil diperbarui")}catch{R.error("Gagal memperbarui data")}},ne=()=>{const t=["Program","Nominal Transaksi",...C.value.map(l=>x.value[l]||re(l))],a=[];a.push(t),S.value.forEach(l=>{const d=[];d.push((l==null?void 0:l.program_name)||""),d.push(Number((l==null?void 0:l.total_transaksi)||0)),C.value.forEach(w=>{d.push(Number((l==null?void 0:l[w])||0))}),a.push(d)});const e=[];e.push("TOTAL");const o=S.value.reduce((l,d)=>l+Number((d==null?void 0:d.total_transaksi)||0),0);e.push(o),C.value.forEach(l=>{const d=S.value.reduce((w,F)=>w+Number((F==null?void 0:F[l])||0),0);e.push(d)}),a.push(e);const n=ae.aoa_to_sheet(a),i=ae.book_new();ae.book_append_sheet(i,n,"Keuangan");const u=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;$e(i,u)},ke=(t,a)=>{if(!a||a.length===0)return t;const e=[...t];return a.forEach(o=>{const{colId:n,sort:i}=o;e.sort((b,u)=>{let l=b[n],d=u[n];return n==="tanggalKeuangan"?(l=new Date(l).getTime(),d=new Date(d).getTime()):n==="jumlah"?(l=l||0,d=d||0):typeof l=="string"&&(l=l.toLowerCase(),d=d.toLowerCase()),l<d?i==="asc"?-1:1:l>d?i==="asc"?1:-1:0})}),e},E=g({getRows:t=>{setTimeout(()=>{const a=t.startRow||0,e=t.endRow||0;let o=oe.value;t.sortModel&&t.sortModel.length>0&&(o=ke(o,t.sortModel));const n=o.slice(a,e);let i;o.length===0?i=0:o.length<=e?i=o.length:i=void 0,t.successCallback(n,i)},50)}}),Y=async()=>{var t,a;z.value=!0;try{let e="/admin/api/keuangan/program-shares-summary";try{const r=A.value;let c=null,m=null;if(r){if(Array.isArray(r))c=r[0]?r[0]instanceof Date?r[0].toISOString().split("T")[0]:String(r[0]):null,m=r[1]?r[1]instanceof Date?r[1].toISOString().split("T")[0]:String(r[1]):null;else if(typeof r=="string"){const P=r.includes(" to ")?" to ":r.includes(" - ")?" - ":"";if(P){const J=r.split(P);c=((t=J[0])==null?void 0:t.trim())||null,m=((a=J[1])==null?void 0:a.trim())||null}else c=r||null,m=r||null}}const f={};c&&(f.start_date=c),m&&(f.end_date=m),N.value&&(f.fundraiser_id=N.value),T.value&&(f.mitra_id=T.value);const y=new URLSearchParams(f).toString();y&&(e+=`?${y}`)}catch{}const n=await(await fetch(e,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success){R.error("Gagal memuat ringkasan program");return}const i=n.data.rows||[],b=n.data.columns&&n.data.columns.length?n.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"];S.value=(i||[]).filter(Boolean),C.value=b;const u=[];u.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),u.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:h,resizable:!0}),x.value=n.data&&n.data.share_type_labels?n.data.share_type_labels:{},i.forEach(r=>{if(!r)return;const c=[];c.push({headerName:"Nominal Transaksi",field:`p_${r.program_id||r.id}_nominal`,valueFormatter:h,resizable:!0,width:160});const m=b.map(y=>{let P="";try{const Q=r.shares_meta||{},_=Q[y]||Q[y.toString()]||null;_&&(_.type==="percentage"&&_.value!==null&&_.value!==void 0?P=` (${te(_.value)})`:_.type==="nominal"&&_.value!==null&&_.value!==void 0&&(P=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(_.value)})`))}catch{}return{headerName:`${x.value[y]||q(y,i)}${P}`,field:`p_${r.program_id||r.id}_${y}`,valueFormatter:h,resizable:!0,minWidth:120}});c.push(...m);const f=`${r.program_name||r.nama_program||r.nama||"Program"}`;u.push({headerName:f,children:c})}),W.splice(0,W.length,...u),de(()=>{var c;const r=B.value||((c=H.value)==null?void 0:c.api);if(r)try{r.setColumnDefs(W);try{r.setDatasource&&E.value?r.setDatasource(E.value):r.setRowData(D.value)}catch{try{r.setRowData(D.value)}catch{}}r.setPinnedBottomRowData(X.value);try{r.sizeColumnsToFit()}catch{}setTimeout(()=>{try{_e()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const l={summary_label:"TOTAL"},d=i.reduce((r,c)=>r+Number((c==null?void 0:c.total_transaksi)||0),0);i.forEach(r=>{if(!r)return;const c=`p_${r.program_id||r.id}_nominal`;l[c]=Number(r.total_transaksi||0),b.forEach(m=>{const f=`p_${r.program_id||r.id}_${m}`;l[f]=Number((r==null?void 0:r[m])||0)})}),l.nominal=d;const w=[];w.push({label:"Nominal Keseluruhan Transaksi",value:d});let F=0;b.forEach(r=>{const c=i.reduce((f,y)=>f+Number((y==null?void 0:y[r])||0),0),m=x.value[r]||q(r,i);w.push({label:`Nominal All ${m}`,value:c}),F+=c});const ie=d-F;ie>0&&w.push({label:"Sisa Belum Teralokasi",value:ie}),se.value=w,D.value=[l],X.value=[],I(!0)}catch(e){console.error(e),R.error("Terjadi kesalahan saat memuat ringkasan program")}finally{z.value=!1}},I=(t=!1)=>{de(()=>{var e;const a=B.value||((e=H.value)==null?void 0:e.api);if(a)try{try{a.purgeInfiniteCache?a.purgeInfiniteCache():a.setDatasource&&E.value?a.setDatasource(E.value):a.setRowData(D.value)}catch{}a.setPinnedBottomRowData(X.value),t&&window.setTimeout(()=>{var n;const o=B.value||((n=H.value)==null?void 0:n.api);if(o)try{o.ensureIndexVisible(0,"top")}catch{}},100)}catch(o){console.error("Error refreshing grid:",o)}})};Fe(async()=>{await be(),await Y(),I()});function _e(){var o;const t=he.value;if(!t)return;const a=t.getAllColumns();if(!a||!a.length)return;const e=a.map(n=>n.getColId());try{t.autoSizeColumns(e,!1)}catch{try{(o=B.value)==null||o.sizeColumnsToFit()}catch{}}}Pe(()=>{M&&clearTimeout(M)});let M=null;Re([A,N,T],()=>{M&&clearTimeout(M),M=setTimeout(async()=>{try{await Y()}catch{}I(!0)},300)});const we=()=>{A.value="",N.value="",T.value=""};return(t,a)=>(v(),Ke(Be,null,{default:Ae(()=>[s("div",ze,[s("div",Ee,[s("h3",Oe,k(ge.value),1),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:ne,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...a[3]||(a[3]=[s("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),ue(" Export Excel ",-1)])])])]),s("div",je,[s("div",He,[s("div",null,[a[4]||(a[4]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),s("div",Le,[O(Ie(Me),{modelValue:A.value,"onUpdate:modelValue":a[0]||(a[0]=e=>A.value=e),config:fe,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])]),s("div",null,[a[5]||(a[5]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Fundraiser",-1)),O(ce,{modelValue:N.value,"onUpdate:modelValue":a[1]||(a[1]=e=>N.value=e),"fetch-url":"/admin/api/karyawan","label-key":"nama","value-key":"id",placeholder:"Pilih Fundraiser","allow-clear":!0,"include-all":!0,"all-label":"Semua Fundraiser",params:{role:"fundraiser"}},null,8,["modelValue"])]),s("div",null,[a[6]||(a[6]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Mitra",-1)),O(ce,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=e=>T.value=e),"fetch-url":"/admin/api/mitra","label-key":"nama","value-key":"id",placeholder:"Pilih Mitra","allow-clear":!0,"include-all":!0,"all-label":"Semua Mitra"},null,8,["modelValue"])])]),s("div",{class:"mt-4"},[s("button",{onClick:we,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),z.value?(v(),p("div",Ue,[...a[7]||(a[7]=[s("svg",{class:"animate-spin h-5 w-5 text-brand-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-400"},"Memuat data...",-1)])])):j("",!0),z.value?j("",!0):(v(),p("div",Ge,[(v(!0),p(Z,null,ee(se.value,(e,o)=>(v(),p("div",{key:`summary-${o}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[s("p",We,k(e.label),1),s("p",qe,k(K(e.value)),1)]))),128))])),s("div",Xe,[s("div",{class:"mb-4 flex items-center justify-between"},[a[8]||(a[8]=s("h4",{class:"font-semibold text-gray-800 dark:text-white/90"},"Per-Program Breakdown",-1)),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:xe,class:"h-9 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Refresh"),s("button",{onClick:ne,class:"h-9 rounded-lg bg-green-500 px-3 py-1.5 text-sm text-white hover:bg-green-600"},"Export Excel")])]),s("div",Ye,[(v(!0),p(Z,null,ee(S.value,e=>(v(),p("div",{key:e.program_id,class:"rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("div",Je,[s("div",Qe,[s("h4",Ze,k(e.program_name||"Program"),1)])]),s("div",ea,[s("table",aa,[a[11]||(a[11]=s("thead",{class:"bg-gray-50 dark:bg-gray-800/30"},[s("tr",null,[s("th",{class:"sticky left-0 z-10 min-w-[200px] border-r border-gray-200 bg-gray-50 px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:border-gray-700 dark:bg-gray-800/30 dark:text-gray-300"},"Pembagian"),s("th",{class:"border-r border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:border-gray-700 dark:text-gray-300"},[s("div",{class:"flex flex-col items-center gap-1"},[s("span",null,"Total")])])])],-1)),s("tbody",ta,[s("tr",ra,[a[9]||(a[9]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Nominal Transaksi",-1)),s("td",sa,k(K((e==null?void 0:e.total_transaksi)||0)),1)]),(v(!0),p(Z,null,ee(C.value,(o,n)=>{var i;return v(),p("tr",{key:`share-row-${e.program_id}-${o}-${n}`,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},[s("td",oa,[ue(k(((i=x.value.value)==null?void 0:i[o])||q(o,S.value.value))+" ",1),e!=null&&e.shares_meta&&e.shares_meta[o]&&e.shares_meta[o].type==="percentage"&&e.shares_meta[o].value!==null?(v(),p("span",la,"("+k(te(e.shares_meta[o].value))+")",1)):e!=null&&e.shares_meta&&e.shares_meta[o]&&e.shares_meta[o].type==="nominal"&&e.shares_meta[o].value!==null?(v(),p("span",na,"("+k(K(e.shares_meta[o].value))+")",1)):j("",!0)]),s("td",ia,k(K((e==null?void 0:e[o])||0)),1)])}),128)),le(e)>0?(v(),p("tr",ua,[a[10]||(a[10]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Sisa Belum Teralokasi",-1)),s("td",da,k(K(le(e))),1)])):j("",!0)])])])]))),128))])])]),O(Ve,{isOpen:G.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ve,onCancel:pe},null,8,["isOpen"])]),_:1}))}});export{ka as default};
