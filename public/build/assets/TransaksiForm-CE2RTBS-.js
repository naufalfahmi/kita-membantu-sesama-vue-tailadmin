import{d as q,H as Z,I as Q,L as W,b as u,A as C,e as aa,f as ea,P as ta,B as V,g as ra,o as v,w as na,a as e,t as w,q as sa,c as _,i as N,j as I,m as f,k as L,v as $,F as oa,l as la,u as ia}from"./admin-DjHSnzD-.js";import{C as da}from"./component-MWmIP9_c.js";import{_ as ua}from"./AdminLayout.vue_vue_type_script_setup_true_lang-C5pXoctL.js";import{S}from"./SearchableSelect-C7lWwq6w.js";import{A as ca}from"./AsyncSearchableSelect-CmVTu1uf.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ma={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ga={class:"mb-6 flex items-center justify-between"},pa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ba={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},fa=["value"],ya={key:0,class:"lg:col-span-2"},ka={class:"overflow-x-auto rounded-lg border border-gray-300 bg-white dark:border-gray-700"},ha={class:"min-w-full text-sm text-left text-gray-700 dark:text-gray-300"},xa={class:"px-4 py-2 align-top"},va={class:"font-medium"},wa={class:"px-4 py-2 align-top text-gray-500 text-sm"},Ia={class:"px-4 py-2 align-top text-right font-medium"},_a={class:"relative"},ja={class:"lg:col-span-2"},Ca={class:"flex items-center gap-3 mt-6 lg:justify-end"},Va=["disabled"],Na=["disabled"],Sa={key:0,class:"animate-spin h-4 w-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ra=q({__name:"TransaksiForm",setup(Ta){const y=Z(),T=Q(),m=W(),c=u(null),j=C(()=>{var a,t,n;const o=(n=(t=(a=c.value)==null?void 0:a.role)==null?void 0:t.name)==null?void 0:n.toLowerCase();return o==="fundrising"||o==="fundraising"}),p=C(()=>y.params.id!==void 0&&y.params.id!=="new"),K=C(()=>p.value?"Edit Transaksi":"Tambah Transaksi"),A=u(!1),b=u(!1),O={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",allowInput:!1},D=u([]),G=u(new Map),M=u([]),F=u([]),k=u(null),h=u(null),x=u([]),U=u(""),B=u(""),R=u(""),r=aa({branchId:"",nominal:null,donorId:"",programId:"",mitraId:"",fundraiserId:"",transactionDate:"",notes:""}),{fetchUser:J}=ta(),z=async()=>{try{const o=await fetch("/admin/api/user",{credentials:"same-origin"});if(o.ok){const a=await o.json();a.success&&a.user&&(c.value=a.user)}}catch(o){console.error("Error fetching current user:",o)}},H=async()=>{try{const o=(()=>{if(!c.value)return!1;const s=c.value.roles||(c.value.role?[c.value.role]:[]);return Array.isArray(s)&&s.some(l=>{const i=typeof l=="string"?l:l==null?void 0:l.name;return typeof i=="string"&&i.trim().toLowerCase()==="admin cabang"})})(),t=!!(c.value&&c.value.is_admin)&&!o?"/admin/api/kantor-cabang?per_page=1000":"/admin/api/kantor-cabang?per_page=1000&only_assigned=1",[n,d]=await Promise.all([fetch(t,{credentials:"same-origin"}),fetch("/admin/api/program?per_page=100",{credentials:"same-origin"})]);if(n.ok){const s=await n.json(),l=s.success&&s.data?Array.isArray(s.data)?s.data:s.data.data||[]:[];D.value=l.map(i=>({value:i.id,label:i.nama})),G.value=new Map(l.map(i=>[i.id,i]))}if(d.ok){const s=await d.json(),l=s.success&&s.data?Array.isArray(s.data)?s.data:s.data.data||[]:[];M.value=l.map(i=>({value:i.id,label:i.nama_program}))}try{const s=await fetch("/admin/api/mitra?per_page=100",{credentials:"same-origin"});if(s.ok){const l=await s.json(),i=l.success&&l.data?Array.isArray(l.data)?l.data:l.data.data||[]:[];F.value=i.map(g=>({value:g.id,label:g.nama||g.name||""}))}}catch{}}catch(o){console.error("Error fetching options:",o),m.error("Gagal memuat data opsi")}},X=async()=>{if(p.value&&y.params.id){A.value=!0;try{const o=y.params.id,a=await fetch(`/admin/api/transaksi/${o}`,{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch transaksi");const t=await a.json();if(t.success&&t.data){const n=t.data;r.branchId=n.kantor_cabang_id||"",r.nominal=n.nominal,r.donorId=n.donatur_id||"",r.programId=n.program_id||"",r.mitraId=n.mitra_id||"",r.transactionDate=n.tanggal_transaksi||"",r.notes=n.keterangan||""}}catch(o){console.error("Error loading transaksi:",o),m.error("Gagal memuat data transaksi")}finally{A.value=!1}}},E=()=>{T.push("/keuangan/transaksi")},Y=async()=>{var o;if(!r.branchId){m.warning("Kantor Cabang wajib diisi");return}if(!r.nominal||r.nominal<=0){m.warning("Nominal wajib diisi");return}if(!r.donorId){m.warning("Donatur wajib diisi");return}if(!r.programId){m.warning("Program wajib diisi");return}if(!r.transactionDate){m.warning("Tanggal transaksi wajib diisi");return}b.value=!0;try{const a=await fetch("/admin/api/csrf-token",{credentials:"same-origin"});if(!a.ok)throw new Error("Failed to fetch CSRF token");const t=await a.json(),n={kantor_cabang_id:r.branchId,nominal:r.nominal,donatur_id:r.donorId,program_id:r.programId,mitra_id:r.mitraId||null,tanggal_transaksi:r.transactionDate,keterangan:r.notes||null};j.value&&((o=c.value)!=null&&o.id)&&(n.fundraiser_id=c.value.id);let d;p.value?d=await fetch(`/admin/api/transaksi/${y.params.id}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t.csrf_token},credentials:"same-origin",body:JSON.stringify(n)}):d=await fetch("/admin/api/transaksi",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":t.csrf_token},credentials:"same-origin",body:JSON.stringify(n)});const s=await d.json();if(s.success)m.success(s.message||(p.value?"Transaksi berhasil diupdate":"Transaksi berhasil ditambahkan")),T.push("/keuangan/transaksi");else if(s.errors){const l=Object.values(s.errors).flat().join(", ");m.error(l)}else m.error(s.message||"Gagal menyimpan transaksi")}catch(a){console.error("Error saving:",a),m.error("Terjadi kesalahan saat menyimpan data")}finally{b.value=!1}};ea(async()=>{var o,a;await J(),await z(),await H(),await X(),j.value&&!p.value&&(a=(o=c.value)==null?void 0:o.kantor_cabang)!=null&&a.id&&(r.branchId=String(c.value.kantor_cabang.id))}),V(()=>r.donorId,async o=>{if(k.value=null,r.fundraiserId="",!!o)try{const a=await fetch(`/admin/api/donatur/${o}`,{credentials:"same-origin"});if(!a.ok)return;const t=await a.json();if(t.success&&t.data){const n=t.data;n.pic_user?(k.value={id:n.pic_user.id,name:n.pic_user.nama},r.fundraiserId=n.pic_user.id):n.pic&&(k.value={id:n.pic,name:""},r.fundraiserId=n.pic)}}catch(a){console.error("Failed to load donor details:",a)}});const P=()=>{x.value=[];const o=Number(r.nominal)||0;if(!h.value||!Array.isArray(h.value.shares))return;const a=n=>n?String(n).replace(/[-_]+/g," ").replace(/\b[a-f0-9]{4,}\b/g,"").trim().split(" ").filter(Boolean).map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "):"",t=n=>{if(n==null)return null;const d=Number(n);return Number.isNaN(d)?null:d};x.value=h.value.shares.map(n=>{const d=(n.type||"percentage")==="percentage",s=t(n.value),l=d&&s!==null?Math.round(Number(o*(s/100))):s!==null?Math.round(s):0,i=n.name||(n.program_share_type_key?a(n.program_share_type_key):"-");let g="-";return s!==null&&(d?g=Number.isInteger(s)?`${s}%`:`${parseFloat(String(s)).toFixed(2).replace(/\.00$/,"")}%`:g=Number(s).toLocaleString()),{name:i,type:n.type||"percentage",value:s,amount:l,displayValue:g}})};return V(()=>r.programId,async o=>{if(h.value=null,x.value=[],!!o)try{const a=await fetch(`/admin/api/program/${o}`,{credentials:"same-origin"});if(!a.ok)return;const t=await a.json();t.success&&t.data&&(h.value=t.data,P())}catch(a){console.error("Failed to load program details:",a)}},{immediate:!1}),V(()=>r.nominal,()=>{P()}),(o,a)=>(v(),ra(ua,null,{default:na(()=>[e("div",ma,[e("div",ga,[e("h3",pa,w(K.value),1),e("button",{onClick:E,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),e("form",{onSubmit:sa(Y,["prevent"]),class:"flex flex-col"},[e("div",ba,[e("div",null,[a[11]||(a[11]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Kantor Cabang "),e("span",{class:"text-red-500"},"*")],-1)),I(S,{modelValue:r.branchId,"onUpdate:modelValue":a[0]||(a[0]=t=>r.branchId=t),options:D.value,placeholder:"Kantor Cabang","search-input":U.value,"onUpdate:searchInput":a[1]||(a[1]=t=>U.value=t),disabled:j.value},null,8,["modelValue","options","search-input","disabled"])]),e("div",null,[a[12]||(a[12]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Nominal "),e("span",{class:"text-red-500"},"*")],-1)),L(e("input",{type:"number","onUpdate:modelValue":a[2]||(a[2]=t=>r.nominal=t),placeholder:"Nominal",min:"0",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,r.nominal,void 0,{number:!0}]])]),e("div",null,[a[13]||(a[13]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Donatur "),e("span",{class:"text-red-500"},"*")],-1)),I(ca,{modelValue:r.donorId,"onUpdate:modelValue":a[3]||(a[3]=t=>r.donorId=t),"fetch-url":"/admin/api/donatur",placeholder:"Donatur"},null,8,["modelValue"])]),e("div",null,[a[14]||(a[14]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Fundraiser ",-1)),e("input",{type:"text",value:k.value?k.value.name:"Tidak ada Fundraiser",disabled:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:border-brand-300"},null,8,fa),N("",!0)]),e("div",null,[a[15]||(a[15]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Program "),e("span",{class:"text-red-500"},"*")],-1)),I(S,{modelValue:r.programId,"onUpdate:modelValue":a[5]||(a[5]=t=>r.programId=t),options:M.value,placeholder:"Program","search-input":B.value,"onUpdate:searchInput":a[6]||(a[6]=t=>B.value=t)},null,8,["modelValue","options","search-input"])]),x.value.length>0?(v(),_("div",ya,[a[17]||(a[17]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rincian Pembagian Program",-1)),e("div",ka,[e("table",ha,[a[16]||(a[16]=e("thead",{class:"bg-gray-50 dark:bg-gray-800"},[e("tr",null,[e("th",{class:"px-4 py-2 font-medium"},"Nama"),e("th",{class:"px-4 py-2 font-medium"},"Nilai"),e("th",{class:"px-4 py-2 font-medium text-right"},"Jumlah (Rp)")])],-1)),e("tbody",null,[(v(!0),_(oa,null,la(x.value,(t,n)=>(v(),_("tr",{key:n,class:"border-t border-gray-100 dark:border-gray-800"},[e("td",xa,[e("div",va,w(t.name),1)]),e("td",wa,w(t.displayValue),1),e("td",Ia,"Rp "+w(t.amount.toLocaleString()),1)]))),128))])])])])):N("",!0),e("div",null,[a[18]||(a[18]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Mitra ",-1)),I(S,{modelValue:r.mitraId,"onUpdate:modelValue":a[7]||(a[7]=t=>r.mitraId=t),options:F.value,placeholder:"Mitra (opsional)","search-input":R.value,"onUpdate:searchInput":a[8]||(a[8]=t=>R.value=t)},null,8,["modelValue","options","search-input"])]),e("div",null,[a[20]||(a[20]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[f(" Tanggal Transaksi "),e("span",{class:"text-red-500"},"*")],-1)),e("div",_a,[I(ia(da),{modelValue:r.transactionDate,"onUpdate:modelValue":a[9]||(a[9]=t=>r.transactionDate=t),config:O,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Tanggal Transaksi"},null,8,["modelValue"]),a[19]||(a[19]=e("span",{class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-3 top-1/2 dark:text-gray-400"},[e("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[e("path",{d:"M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 9.99999C18.3333 5.39762 14.6024 1.66666 10 1.66666C5.39763 1.66666 1.66667 5.39762 1.66667 9.99999C1.66667 14.6024 5.39763 18.3333 10 18.3333Z",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M10 5V10L13.3333 11.6667",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"})])],-1))])]),e("div",ja,[a[21]||(a[21]=e("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Keterangan ",-1)),L(e("textarea",{"onUpdate:modelValue":a[10]||(a[10]=t=>r.notes=t),placeholder:"Keterangan",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[$,r.notes]]),a[22]||(a[22]=e("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"}," Maksimal 1000 karakter. ",-1))])]),e("div",Ca,[e("button",{onClick:E,type:"button",disabled:b.value,class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"}," Batal ",8,Va),e("button",{type:"submit",disabled:b.value,class:"flex w-full justify-center items-center gap-2 rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto disabled:opacity-50 disabled:cursor-not-allowed"},[b.value?(v(),_("svg",Sa,[...a[23]||(a[23]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)])])):N("",!0),f(" "+w(b.value?"Menyimpan...":p.value?"Simpan Perubahan":"Simpan"),1)],8,Na)])],32)])]),_:1}))}});export{Ra as default};
