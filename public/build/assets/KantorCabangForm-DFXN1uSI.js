import{d as z,H as J,I as W,M as Y,b as Z,A as j,e as Q,B as K,f as aa,V as S,X as ea,g as ta,o as P,w as ra,a as r,t as E,q as oa,k as c,c as na,i as sa,n as da,v as g,m as la}from"./admin-C6Git2IM.js";import{_ as ia}from"./AdminLayout.vue_vue_type_script_setup_true_lang-CzENBu_z.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ua={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ca={class:"mb-6 flex items-center justify-between"},ga={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},pa={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ma={class:"lg:col-span-1"},ka=["readonly","disabled"],ba={key:0,class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},ya={class:"lg:col-span-1"},ha={class:"lg:col-span-1"},xa={class:"lg:col-span-1"},fa={class:"lg:col-span-1"},wa={class:"lg:col-span-1"},va={class:"lg:col-span-1"},Ma={class:"lg:col-span-1"},Ta={class:"lg:col-span-2"},Ca={class:"lg:col-span-2"},La={class:"mt-3 grid grid-cols-1 gap-4 lg:grid-cols-2"},Fa={class:"flex items-center gap-3 mt-6 lg:justify-end"},ja={type:"submit",class:"flex w-full justify-center rounded-lg bg-brand-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-brand-600 sm:w-auto"},Ra=z({__name:"KantorCabangForm",setup(Ka){const b=J(),y=W(),m=Y(),h=Z(null);let l=null,p=null,x=!1;const i=j(()=>b.params.id!==void 0&&b.params.id!=="new"),R=j(()=>i.value?"Edit Kantor Cabang":"Tambah Kantor Cabang"),a=Q({kode:"",nama:"",kelurahan:"",kecamatan:"",kota:"",provinsi:"",kode_pos:"",alamat:"",latitude:"",longitude:"",radius:null}),I=async()=>{if(h.value)try{window.maplibregl||await new Promise((o,e)=>{if(document.querySelector('script[src*="maplibre-gl"]')){const s=setInterval(()=>{window.maplibregl&&(clearInterval(s),o())},100);return}const t=document.createElement("script");t.src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js",t.onload=()=>o(),t.onerror=()=>e(new Error("Failed to load MapTiler")),document.head.appendChild(t);const n=document.createElement("link");n.rel="stylesheet",n.href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css",document.head.appendChild(n)}),U()}catch(o){console.error("Error loading MapTiler:",o)}},U=()=>{if(!h.value||!window.maplibregl)return;const o=a.longitude?parseFloat(a.longitude):106.8451,e=a.latitude?parseFloat(a.latitude):-6.2088;l=new window.maplibregl.Map({container:h.value,style:"https://api.maptiler.com/maps/streets-v2/style.json?key=M3H6Ho6JJ93ZPH10DnYt",center:[o,e],zoom:a.latitude&&a.longitude?15:13}),l.on("load",()=>{p=new window.maplibregl.Marker({draggable:!0}).setLngLat([o,e]).addTo(l),p.on("dragend",()=>{const t=p.getLngLat();a.longitude=t.lng.toFixed(6),a.latitude=t.lat.toFixed(6),f()}),l.on("click",t=>{const{lng:n,lat:s}=t.lngLat;p.setLngLat([n,s]),a.longitude=n.toFixed(6),a.latitude=s.toFixed(6),f()})})},A=(o,e,t,n)=>{const d=t/6378137,u=n*Math.PI/180,k=o*Math.PI/180,B=e*Math.PI/180,M=Math.sin(k),T=Math.cos(k),C=Math.sin(d),L=Math.cos(d),F=M*L+T*C*Math.cos(u),H=Math.asin(F),O=Math.sin(u)*C*T,$=L-M*F,D=B+Math.atan2(O,$);return{lat:H*180/Math.PI,lon:D*180/Math.PI}},V=(o,e,t,n=64)=>{const s=[];for(let d=0;d<=n;d++){const u=d*360/n,k=A(o,e,t,u);s.push([k.lon,k.lat])}return{type:"Feature",geometry:{type:"Polygon",coordinates:[s]}}},f=()=>{if(!l)return;const o=parseFloat(a.latitude||"0"),e=parseFloat(a.longitude||"0"),t=a.radius,n="kantor-radius-src",s="kantor-radius-fill",d="kantor-radius-outline";if(l.getLayer(d))try{l.removeLayer(d)}catch{}if(l.getLayer(s))try{l.removeLayer(s)}catch{}if(l.getSource(n))try{l.removeSource(n)}catch{}if(!t||!o||!e)return;const u=V(o,e,Number(t),128);l.addSource(n,{type:"geojson",data:u}),l.addLayer({id:s,type:"fill",source:n,paint:{"fill-color":"#3b82f6","fill-opacity":.12}}),l.addLayer({id:d,type:"line",source:n,paint:{"line-color":"#2563eb","line-width":2}})};K(()=>a.radius,()=>{l&&f()});const q=async o=>{if(!o||o.trim()==="")return null;try{const e=encodeURIComponent(o+", Indonesia"),t=await fetch(`https://nominatim.openstreetmap.org/search?q=${e}&format=json&limit=1&addressdetails=1`,{headers:{"User-Agent":"KMS-Application/1.0"}});if(!t.ok)throw new Error("Geocoding request failed");const n=await t.json();return n&&n.length>0?{lat:parseFloat(n[0].lat),lng:parseFloat(n[0].lon)}:null}catch(e){return console.error("Error geocoding address:",e),null}},N=(o,e)=>{!l||!p||(p.setLngLat([e,o]),a.latitude=o.toFixed(6),a.longitude=e.toFixed(6),l.flyTo({center:[e,o],zoom:15,duration:1e3}))};K(()=>[a.alamat,a.kelurahan,a.kecamatan,a.kota,a.provinsi],async(o,e)=>{if(x||!l||!p||!o[0]&&!o[1]&&!o[2]&&!o[3]&&!o[4])return;const t=[];a.alamat&&t.push(a.alamat),a.kelurahan&&t.push(a.kelurahan),a.kecamatan&&t.push(a.kecamatan),a.kota&&t.push(a.kota),a.provinsi&&t.push(a.provinsi);const n=t.join(", ");if(!(n.trim()===""||(await new Promise(d=>setTimeout(d,500)),[a.alamat,a.kelurahan,a.kecamatan,a.kota,a.provinsi].filter(Boolean).join(", ")!==n))){x=!0;try{const d=await q(n);d&&N(d.lat,d.lng)}catch(d){console.error("Error updating map from address:",d)}finally{x=!1}}},{deep:!0});const w=async()=>{var o;try{const e=(o=document.querySelector('meta[name="csrf-token"]'))==null?void 0:o.getAttribute("content");if(e)return e;const t=await fetch("/admin/api/csrf-token",{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Failed to get CSRF token: ${t.status}`);return(await t.json()).csrf_token||""}catch(e){return console.error("Failed to get CSRF token:",e),""}},_=async()=>{if(!i.value)try{const o=await w(),t=await(await fetch("/admin/api/kantor-cabang-next-kode",{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":o},credentials:"same-origin"})).json();t.success&&t.data&&(a.kode=t.data.kode||"")}catch(o){console.error("Error loading next kode:",o)}},X=async()=>{if(i.value&&b.params.id){const o=b.params.id;try{const e=await w(),n=await(await fetch(`/admin/api/kantor-cabang/${o}`,{method:"GET",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":e},credentials:"same-origin"})).json();if(n.success&&n.data){const s=n.data;if(a.kode=s.kode||"",a.nama=s.nama||"",a.kelurahan=s.kelurahan||"",a.kecamatan=s.kecamatan||"",a.kota=s.kota||"",a.provinsi=s.provinsi||"",a.kode_pos=s.kode_pos||"",a.radius=s.radius??null,a.alamat=s.alamat||"",a.latitude=s.latitude?String(s.latitude):"",a.longitude=s.longitude?String(s.longitude):"",s.latitude&&s.longitude&&(await S(),l&&p)){const d=parseFloat(s.latitude),u=parseFloat(s.longitude);p.setLngLat([u,d]),l.flyTo({center:[u,d],zoom:15,duration:1e3})}}else m.error("Gagal memuat data kantor cabang"),y.push("/administrasi/kantor-cabang")}catch(e){console.error("Error loading data:",e),m.error("Terjadi kesalahan saat memuat data"),y.push("/administrasi/kantor-cabang")}}},v=()=>{y.push("/administrasi/kantor-cabang")},G=async()=>{if(!a.nama){m.error("Nama Kantor Cabang wajib diisi");return}try{const o=await w();if(!o){m.error("Gagal mendapatkan CSRF token. Silakan refresh halaman.");return}const e={nama:a.nama,kelurahan:a.kelurahan||null,kecamatan:a.kecamatan||null,kota:a.kota||null,provinsi:a.provinsi||null,kode_pos:a.kode_pos||null,alamat:a.alamat||null,latitude:a.latitude?parseFloat(a.latitude):null,longitude:a.longitude?parseFloat(a.longitude):null,radius:a.radius!==null?parseInt(String(a.radius),10):null};i.value&&a.kode&&(e.kode=a.kode);const t=i.value?`/admin/api/kantor-cabang/${b.params.id}`:"/admin/api/kantor-cabang",n=i.value?"PUT":"POST",d=await(await fetch(t,{method:n,headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest",Accept:"application/json","X-CSRF-TOKEN":o},credentials:"same-origin",body:JSON.stringify(e)})).json();if(d.success)m.success(i.value?"Kantor cabang berhasil diupdate":"Kantor cabang berhasil ditambahkan"),y.push("/administrasi/kantor-cabang");else if(d.errors){const u=Object.values(d.errors).flat().join(", ");m.error(`Validasi gagal: ${u}`)}else m.error(d.message||"Gagal menyimpan data")}catch(o){console.error("Error saving:",o),m.error("Terjadi kesalahan saat menyimpan data")}};return aa(async()=>{i.value?await X():await _(),await S(),I()}),ea(()=>{l&&(l.remove(),l=null),p=null}),(o,e)=>(P(),ta(ia,null,{default:ra(()=>[r("div",ua,[r("div",ca,[r("h3",ga,E(R.value),1),r("button",{onClick:v,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"}," Batal ")]),r("form",{onSubmit:oa(G,["prevent"]),class:"flex flex-col"},[r("div",pa,[r("div",ma,[e[11]||(e[11]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kode Kantor Cabang ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>a.kode=t),placeholder:"Kode akan di-generate otomatis",readonly:!i.value,disabled:!i.value,class:da(["dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",{"cursor-not-allowed opacity-60":!i.value}])},null,10,ka),[[g,a.kode]]),i.value?sa("",!0):(P(),na("p",ba," Kode akan di-generate otomatis "))]),r("div",ya,[e[12]||(e[12]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[la(" Nama Kantor Cabang "),r("span",{class:"text-red-500"},"*")],-1)),c(r("input",{type:"text","onUpdate:modelValue":e[1]||(e[1]=t=>a.nama=t),placeholder:"Masukkan nama kantor cabang",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.nama]])]),r("div",ha,[e[13]||(e[13]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kelurahan ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[2]||(e[2]=t=>a.kelurahan=t),placeholder:"Masukkan kelurahan",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.kelurahan]])]),r("div",xa,[e[14]||(e[14]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kecamatan ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[3]||(e[3]=t=>a.kecamatan=t),placeholder:"Masukkan kecamatan",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.kecamatan]])]),r("div",fa,[e[15]||(e[15]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kota ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[4]||(e[4]=t=>a.kota=t),placeholder:"Masukkan kota",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.kota]])]),r("div",wa,[e[16]||(e[16]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Provinsi ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=t=>a.provinsi=t),placeholder:"Masukkan provinsi",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.provinsi]])]),r("div",va,[e[17]||(e[17]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Kode Pos ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[6]||(e[6]=t=>a.kode_pos=t),placeholder:"Masukkan kode pos",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.kode_pos]])]),r("div",Ma,[e[18]||(e[18]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Radius (meter)",-1)),c(r("input",{type:"number","onUpdate:modelValue":e[7]||(e[7]=t=>a.radius=t),placeholder:"Radius (m)",min:"0",class:"h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"},null,512),[[g,a.radius,void 0,{number:!0}]])]),r("div",Ta,[e[19]||(e[19]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Alamat ",-1)),c(r("textarea",{"onUpdate:modelValue":e[8]||(e[8]=t=>a.alamat=t),placeholder:"Masukkan alamat lengkap",rows:"3",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[g,a.alamat]])]),r("div",Ca,[e[22]||(e[22]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Pilih Lokasi di Peta ",-1)),r("div",{ref_key:"mapContainer",ref:h,class:"w-full rounded-lg border border-gray-300 dark:border-gray-700",style:{height:"400px"}},null,512),r("div",La,[r("div",null,[e[20]||(e[20]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Latitude ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[9]||(e[9]=t=>a.latitude=t),placeholder:"Koordinat latitude",readonly:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 dark:placeholder:text-white/30"},null,512),[[g,a.latitude]])]),r("div",null,[e[21]||(e[21]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"}," Longitude ",-1)),c(r("input",{type:"text","onUpdate:modelValue":e[10]||(e[10]=t=>a.longitude=t),placeholder:"Koordinat longitude",readonly:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-gray-50 px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 dark:border-gray-700 dark:bg-gray-800 dark:text-white/90 dark:placeholder:text-white/30"},null,512),[[g,a.longitude]])])]),e[23]||(e[23]=r("p",{class:"mt-2 text-xs text-gray-500 dark:text-gray-400"}," Klik pada peta untuk memilih lokasi atau drag marker untuk memperbarui koordinat. Titik di peta akan otomatis diperbarui saat Anda mengisi Kelurahan, Kecamatan, Kota, atau Provinsi. ",-1))])]),r("div",Fa,[r("button",{onClick:v,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"}," Batal "),r("button",ja,E(i.value?"Simpan Perubahan":"Simpan"),1)])],32)])]),_:1}))}});export{Ra as default};
