import{d as ye,H as ve,I as be,b as D,M as _e,A as P,Q as we,f as ke,X as De,B as xe,g as Ce,o as A,w as Se,a as g,j as U,t as J,m as Te,u as ae,c as V,i as Re,S as Fe,V as te}from"./admin-D1J7V-ZI.js";import{C as Ne}from"./component-BE0ZUxfh.js";import{u as q,w as Ie}from"./xlsx-3SA47z_C.js";import{_ as $e}from"./AdminLayout.vue_vue_type_script_setup_true_lang-hhmXvr9A.js";import{_ as Ee}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-BcKIivn1.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ke={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Pe={class:"mb-6 flex items-center justify-between"},Ae={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Be={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Me={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},ze={class:"relative"},Ve={class:"relative",style:{width:"100%",height:"450px"}},Oe={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},je={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},He={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},Le={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Ge={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},We={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},Ue={class:"text-gray-500 dark:text-gray-500 text-sm"},ta=ye({__name:"LaporanTransaksiKeuangan",setup(Je){const re=ve();be();const ne=D(String(re.meta.title||"Keuangan")),B=D(null),N=D(null),X=D(null),O=_e(),{fetchUser:oe,hasPermission:j,isAdmin:H}=we();P(()=>H()||j("create keuangan")),P(()=>H()||j("update keuangan")),P(()=>H()||j("delete keuangan"));const L=D(!1),M=D(null),se={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},I=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:w},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:w},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:w},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:w},{headerName:"Program",field:"program",valueFormatter:w},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:w},{headerName:"Bonus",field:"bonus",valueFormatter:w},{headerName:"Championship",field:"championship",valueFormatter:w}]}],G={resizable:!0,sortable:!0,filter:!1};G.minWidth=120,G.cellClass="text-sm";function w(a){return a&&a.value!==void 0&&a.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a.value):""}function ie(a){switch((a||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(a)}}const T=D([]),C=D((()=>{const a=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],n=[],o=new Date("2024-01-01");for(let r=1;r<=200;r++){const u=(r-1)%a.length,y=(r-1)%t.length,v=new Date(o);v.setDate(v.getDate()+(r-1)*2);const h=Math.floor(Math.random()*75e6)+25e6;n.push({id:r.toString(),pic:a[u],jumlah:h,kantorCabang:t[y],tanggalKeuangan:v.toISOString().split("T")[0]})}return n})()),S=D(""),Y=P(()=>C.value),le=P(()=>Y.value.length===0),de=()=>{M.value&&(C.value=C.value.filter(a=>a.id!==M.value),O.success("Data keuangan berhasil dihapus"),L.value=!1,M.value=null,E())},ce=()=>{L.value=!1,M.value=null},ue=()=>{const a=[],t=[],n=[],o=[];let r=0;I.forEach(l=>{if(l.field){const k=l.headerName||l.field;t.push(k),n.push(""),o.push({s:{r:0,c:r},e:{r:1,c:r}}),a.push(l.field),r+=1}else if(l.children&&Array.isArray(l.children)){const k=l.headerName||"",x=l.children.length;for(let f=0;f<x;f++)t.push(f===0?k:"");o.push({s:{r:0,c:r},e:{r:0,c:r+x-1}}),l.children.forEach(f=>{n.push(f.headerName||f.field),a.push(f.field),r+=1})}});const u=[];u.push(t),u.push(n),C.value.forEach(l=>{const k=[];a.forEach(x=>{const f=l[x];k.push(typeof f=="number"?f:f??"")}),u.push(k)}),T.value&&T.value.length&&T.value.forEach(l=>{const k=[];a.forEach(x=>{const f=l[x];k.push(typeof f=="number"?f:f??"")}),u.push(k)});const y=q.aoa_to_sheet(u);y["!merges"]=y["!merges"]||[],o.forEach(l=>y["!merges"].push(l));const v=q.book_new();q.book_append_sheet(v,y,"Keuangan");const _=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ie(v,_)},me=(a,t)=>{if(!t||t.length===0)return a;const n=[...a];return t.forEach(o=>{const{colId:r,sort:u}=o;n.sort((y,v)=>{let h=y[r],_=v[r];return r==="tanggalKeuangan"?(h=new Date(h).getTime(),_=new Date(_).getTime()):r==="jumlah"?(h=h||0,_=_||0):typeof h=="string"&&(h=h.toLowerCase(),_=_.toLowerCase()),h<_?u==="asc"?-1:1:h>_?u==="asc"?1:-1:0})}),n},Q=()=>({getRows:a=>{setTimeout(()=>{const t=a.startRow||0,n=a.endRow||0;let o=Y.value;a.sortModel&&a.sortModel.length>0&&(o=me(o,a.sortModel));const r=o.slice(t,n);let u;o.length===0?u=0:o.length<=n?u=o.length:u=void 0,a.successCallback(r,u)},50)}}),$=D(Q()),Z=async()=>{var a,t;try{let n="/admin/api/keuangan/program-shares-summary";try{const e=S.value;let s=null,d=null;if(e){if(Array.isArray(e))s=e[0]?e[0]instanceof Date?e[0].toISOString().split("T")[0]:String(e[0]):null,d=e[1]?e[1]instanceof Date?e[1].toISOString().split("T")[0]:String(e[1]):null;else if(typeof e=="string"){const c=e.includes(" to ")?" to ":e.includes(" - ")?" - ":"";if(c){const p=e.split(c);s=((a=p[0])==null?void 0:a.trim())||null,d=((t=p[1])==null?void 0:t.trim())||null}else s=e||null,d=e||null}}const m={};s&&(m.start_date=s),d&&(m.end_date=d);const i=new URLSearchParams(m).toString();i&&(n+=`?${i}`)}catch{}const r=await(await fetch(n,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){O.error("Gagal memuat ringkasan program");return}const u=r.data&&r.data.share_type_labels?r.data.share_type_labels:{},y=r.data.rows||[],v=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],h=[];h.push({headerName:"Tanggal Transaksi",field:"tanggal",pinned:"left",width:250}),h.push({headerName:"Nominal Transaksi",field:"nominal",pinned:"left",width:160,valueFormatter:w,resizable:!0}),y.forEach(e=>{const s=[];s.push({headerName:"Nominal Transaksi",field:`p_${e.program_id||e.id}_nominal`,valueFormatter:w,resizable:!0,width:160});const d=v.map(i=>{let c="";try{const p=e.shares_meta||{},b=p[i]||p[i.toString()]||null;if(b)if(b.type==="percentage"&&b.value!==null&&b.value!==void 0){const F=Number(b.value);Number.isFinite(F)?c=Number.isInteger(F)?` (${F}%)`:` (${F%1===0?F:parseFloat(F.toFixed(2))}%)`:c=` (${b.value}%)`}else b.type==="nominal"&&b.value!==null&&b.value!==void 0&&(c=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(b.value)})`)}catch{}return{headerName:`${u[i]||ie(i)}${c}`,field:`p_${e.program_id||e.id}_${i}`,valueFormatter:w,resizable:!0,minWidth:120}});s.push(...d);const m=`${e.program_name||e.nama_program||e.nama||"Program"}`;h.push({headerName:m,children:s})}),I.splice(0,I.length,...h),te(()=>{var s;const e=N.value||((s=B.value)==null?void 0:s.api);if(e)try{e.setColumnDefs(I);try{e.setDatasource&&$.value?e.setDatasource($.value):e.setRowData(C.value)}catch{try{e.setRowData(C.value)}catch{}}e.setPinnedBottomRowData(T.value);try{e.sizeColumnsToFit()}catch{}setTimeout(()=>{try{ee()}catch{}},80)}catch(d){console.error("Failed to apply dynamic columns to grid",d)}});const _=r.data.transaksis||[],l={},k=e=>{if(!e)return"";const s=new Date(e);return isNaN(s.getTime())?e:s.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})};_.forEach(e=>{const s=(e.tanggal_transaksi||e.tanggal||e.date||"").toString(),d=s;l[d]||(l[d]={tanggal:k(s),kode:null,nominal:0},y.forEach(i=>{l[d][`p_${i.program_id||i.id}_nominal`]=0,v.forEach(c=>{l[d][`p_${i.program_id||i.id}_${c}`]=0})}));const m=l[d];m.kode=m.kode||e.kode||null,m.nominal=(m.nominal||0)+(e.nominal||0),y.forEach(i=>{v.forEach(c=>{const p=`p_${i.program_id||i.id}_${c}`,b=`p_${i.program_id||i.id}`;c==="program"&&e[b]!==void 0?m[p]+=e[b]||0:m[p]+=e[p]||0});try{const c=i.program_id||i.id;e.program_id&&String(e.program_id)===String(c)&&(m[`p_${c}_nominal`]=(m[`p_${c}_nominal`]||0)+(e.nominal||0))}catch{}})});const x=Object.values(l);C.value=x;const f=x.reduce((e,s)=>e+(s.nominal||0),0),z={tanggal:"TOTAL"},W={tanggal:"DISBURSED TOTALS"},R=r.data&&r.data.disbursed_totals_by_program?r.data.disbursed_totals_by_program:{};y.forEach(e=>{const s=`p_${e.program_id||e.id}_nominal`;z[s]=e.total_transaksi||0,W[s]=0,v.forEach(d=>{const m=`p_${e.program_id||e.id}_${d}`;z[m]=e[d]||0;const i=m,c=`p_${e.program_id||e.id}`;let p=0;R&&R[i]!==void 0?p=R[i]:d==="program"&&R&&R[c]!==void 0&&(p=R[c]),W[m]=p||0})}),z.nominal=f,T.value=[z,W],E(!0)}catch(n){console.error(n),O.error("Terjadi kesalahan saat memuat ringkasan program")}},E=(a=!1)=>{te(()=>{var n;const t=N.value||((n=B.value)==null?void 0:n.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&$.value?t.setDatasource($.value):t.setRowData(C.value)}catch{}t.setPinnedBottomRowData(T.value),a&&window.setTimeout(()=>{var r;const o=N.value||((r=B.value)==null?void 0:r.api);if(o)try{o.ensureIndexVisible(0,"top")}catch{}},100)}catch(o){console.error("Error refreshing grid:",o)}})};ke(async()=>{await oe(),await Z(),E()});function ge(a){N.value=a.api,X.value=a.columnApi;try{const t=$.value||Q();a.api.setDatasource&&a.api.setDatasource(t)}catch(t){console.error("Failed to set datasource for infinite row model",t)}}function ee(){var o;const a=X.value;if(!a)return;const t=a.getAllColumns();if(!t||!t.length)return;const n=t.map(r=>r.getColId());try{a.autoSizeColumns(n,!1)}catch{try{(o=N.value)==null||o.sizeColumnsToFit()}catch{}}}function he(a){try{a.api.sizeColumnsToFit()}catch{}ee()}De(()=>{K&&clearTimeout(K)});const fe=()=>{E()};let K=null;xe([S],()=>{K&&clearTimeout(K),K=setTimeout(async()=>{try{await Z()}catch{}E(!0)},300)});const pe=()=>{S.value=""};return(a,t)=>(A(),Ce($e,null,{default:Se(()=>[g("div",Ke,[g("div",Pe,[g("h3",Ae,J(ne.value),1),g("div",{class:"flex items-center gap-3"},[g("button",{onClick:ue,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[g("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[g("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Te(" Export Excel ",-1)])])])]),g("div",Be,[g("div",Me,[g("div",null,[t[2]||(t[2]=g("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),g("div",ze,[U(ae(Ne),{modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=n=>S.value=n),config:se,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),g("div",{class:"mt-4"},[g("button",{onClick:pe,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),g("div",Ve,[g("div",Oe,[U(ae(Fe),{ref_key:"agGridRef",ref:B,onGridReady:ge,onFirstDataRendered:he,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:I,defaultColDef:G,pinnedBottomRowData:T.value,rowModelType:"infinite",cacheBlockSize:50,maxBlocksInCache:10,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:fe},null,8,["pinnedBottomRowData"])]),le.value?(A(),V("div",je,[(A(),V("svg",He,[a.filterPIC||a.filterKantorCabang||S.value||a.filterJumlahMin||a.filterJumlahMax?(A(),V("path",Le)):(A(),V("path",Ge))])),g("p",We,J(S.value?"Tidak ada data ditemukan":"Tidak ada data"),1),g("p",Ue,J(S.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Re("",!0)])]),U(Ee,{isOpen:L.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:de,onCancel:ce},null,8,["isOpen"])]),_:1}))}});export{ta as default};
