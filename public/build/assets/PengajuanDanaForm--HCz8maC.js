import{d as sa,H as na,I as oa,L as ia,A as v,b as c,e as L,B as la,f as X,g as da,o as i,w as ua,a as r,t as l,q as ma,c as d,i as k,j as w,m as h,k as C,v as N,u as ga,F as pa,l as ca,n as ba,P as ya}from"./admin-B_mUB0GB.js";import{C as fa}from"./component-DTNTv1d6.js";import{_ as xa,g as va}from"./AdminLayout.vue_vue_type_script_setup_true_lang-D7k0ChKy.js";import{S}from"./SearchableSelect-DM6rfCaB.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ha={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},ka={class:"mb-6 flex items-center justify-between"},wa={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},_a={class:"grid grid-cols-1 gap-x-6 gap-y-5 lg:grid-cols-2"},ja={class:"lg:col-span-1"},Sa={class:"lg:col-span-1"},Ia={key:0,class:"lg:col-span-1"},Da={key:0,class:"mt-2 text-sm text-gray-500"},Ta={class:"lg:col-span-1"},Pa={key:0,class:"h-11 flex items-center rounded-lg border border-gray-300 bg-transparent px-4 text-sm text-gray-700 dark:border-gray-700 dark:text-gray-400"},Va={key:1,class:"space-y-2"},Aa={class:"flex items-center gap-3"},Ca={key:2},Na={class:"lg:col-span-1"},Fa={class:"relative"},Ra={class:"absolute text-gray-500 -translate-y-1/2 pointer-events-none right-4 top-1/2 dark:text-gray-400 text-sm"},Ea={key:0,class:"mt-1 text-xs text-red-500"},Ma={key:1,class:"mt-1 text-xs text-red-500"},Ua={class:"lg:col-span-1"},qa={class:"relative"},La={class:"lg:col-span-2"},Xa={key:1,class:"lg:col-span-2"},Oa={class:"mt-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-900/40"},$a={class:"flex items-center justify-between"},Ba={class:"text-lg font-medium"},Ha={class:"text-right text-xs text-gray-500"},Ka={key:0},Wa={class:"flex flex-wrap justify-end gap-2"},Ga={key:0},Ya={key:1},za={key:1,class:"text-xs"},Ja={key:0,class:"mt-3 border-t pt-3"},Qa={class:"flex items-center justify-between"},Za={class:"text-xs text-gray-500"},ae={class:"text-lg font-medium"},ee={class:"text-right text-xs text-gray-500"},te={class:"mt-3 flex items-center justify-between"},re={class:"flex items-center gap-3"},se={class:"mt-3 text-sm text-gray-700"},ne={class:"font-medium"},oe={key:0,class:"mt-1 text-xs text-red-500"},ie={class:"lg:col-span-2"},le={class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},de={class:"flex items-center gap-3 mt-6 lg:justify-end"},ue=["disabled"],fe=sa({__name:"PengajuanDanaForm",setup(me){const I=na(),F=oa(),g=ia(),{fetchUser:O}=ya(),y=v(()=>I.params.id!==void 0&&I.params.id!=="new"),$=v(()=>y.value?"Edit Pengajuan Dana":"Tambah Pengajuan Dana"),B={dateFormat:"Y-m-d",altInput:!0,altFormat:"d F Y",locale:"id",wrap:!0,clickOpens:!0,allowInput:!1,minDate:"today"},_=c([]),H=[{value:"operasional",label:"Operasional"},{value:"program",label:"Program"},{value:"kegiatan",label:"Kegiatan"},{value:"pengembangan",label:"Pengembangan"},{value:"darurat",label:"Darurat"},{value:"lainnya",label:"Lainnya"}],D=c([]),T=c([]),R=c(""),E=c(""),M=c(""),j=c(""),e=L({applicant:"",submissionType:"",status:"Draft",programId:"",amount:null,usedAt:"",purpose:"",branchId:""}),U=L({amount:""}),f=c(!1),P=v(()=>{if(e.submissionType!=="program"||!o||!o.value)return!1;const s=Number(o.value.remaining||0);return Number(e.amount||0)>s}),K=v(()=>!e.amount||e.amount<=0?"":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e.amount)),o=c(null),p=c(null),V=c(!1);let A=null;const b=s=>!s||s<=0?"Rp 0":new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),W=s=>{if(!s)return"";try{const a=String(s).split("-");if(a.length<2)return s;const n=Number(a[0]),t=Number(a[1])-1,u=new Date(Date.UTC(n,t,1));return new Intl.DateTimeFormat("id-ID",{month:"long",year:"numeric"}).format(u)}catch{return s}},G=v(()=>!p.value||!Array.isArray(p.value.shares)?[]:p.value.shares.filter(s=>{var n;const a=s.program_share_type_key??s.type_key??((n=s.type)==null?void 0:n.key)??null;return String(a)==="program"})),Y=async()=>{if(!e.programId||!e.usedAt){o.value=null;return}V.value=!0;try{const s=new Date(e.usedAt);if(isNaN(s.getTime())){o.value=null,V.value=!1;return}const a=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`,t=await(await fetch(`/admin/api/program/${e.programId}/balance?month=${a}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!t.success)throw new Error(t.message||"Failed to load balance");if(o.value=t.data,!y.value){const u=Number(t.data.remaining||0);u>0&&(!e.amount||e.amount<=0)&&(e.amount=u)}}catch(s){console.error("Error loading program balance",s),g.error("Gagal memuat saldo program"),o.value=null}finally{V.value=!1}},z=async()=>{if(!e.programId){p.value=null;return}try{const a=await(await fetch(`/admin/api/program/${e.programId}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!a.success)throw new Error(a.message||"Failed to load program");p.value=a.data}catch(s){console.error("Error loading program detail",s),p.value=null}};la([()=>e.programId,()=>e.usedAt],()=>{A&&window.clearTimeout(A),A=window.setTimeout(()=>{z(),Y()},300)});const J=s=>{const a=s.target,n=parseFloat(a.value);isNaN(n)||n<0?e.amount=null:e.amount=Math.floor(n)},Q=async()=>{if(!y.value)return;const s=I.params.id;try{const n=await(await fetch(`/admin/api/pengajuan-dana/${s}`,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load");const t=n.data;if(e.applicant=t.fundraiser?String(t.fundraiser.id):"",e.status=t.status||"Draft",t.fundraiser&&!_.value.find(u=>u.value===String(t.fundraiser.id))&&_.value.unshift({value:String(t.fundraiser.id),label:t.fundraiser.name||t.fundraiser.nama||""}),e.submissionType=t.submission_type,e.amount=t.amount,e.usedAt=t.used_at,e.purpose=t.purpose||"",e.branchId=t.kantor_cabang?t.kantor_cabang.id:"",e.programId=t.program?String(t.program.id):"",t.kantor_cabang&&!D.value.find(u=>u.value===String(t.kantor_cabang.id))&&D.value.unshift({value:String(t.kantor_cabang.id),label:t.kantor_cabang.nama||""}),t.program&&!T.value.find(u=>u.value===String(t.program.id))){const u=t.program.nama_program||t.program.nama||"";T.value.unshift({value:String(t.program.id),label:u})}}catch(a){console.error("Error loading data:",a),g.error("Gagal memuat data pengajuan dana")}},Z=async()=>{try{const s=await O();j.value=s!=null&&s.id?String(s.id):"";const n=await(await fetch("/admin/api/pengajuan-dana/options",{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success)throw new Error(n.message||"Failed to load options");const t=n.data.users||[];_.value=t.map(m=>({value:String(m.id),label:m.name}));const u=n.data.kantor_cabangs||[];D.value=u.map(m=>({value:String(m.id),label:m.nama}));const x=n.data.programs||[];T.value=x.map(m=>({value:String(m.id),label:m.nama})),j.value&&_.value.find(ra=>ra.value===String(j.value))&&!e.applicant&&(e.applicant=String(j.value)),y.value&&n.data&&n.data.current&&n.data.current.program&&(e.programId=String(n.data.current.program.id))}catch(s){console.error("Error loading options",s),g.error("Gagal memuat opsi form")}},aa=[{value:"Draft",label:"Draft"},{value:"Pending",label:"Diajukan"}];v(()=>String(e.applicant)===String(j.value));const ea=v(()=>aa),q=()=>F.push("/keuangan/pengajuan-dana"),ta=async()=>{if(!e.applicant){g.error("Pengaju wajib diisi");return}if(!e.submissionType){g.error("Tipe Pengajuan wajib diisi");return}if(!e.amount||e.amount<=0){g.error("Nominal wajib diisi dan harus lebih dari 0");return}if(!e.usedAt){g.error("Tanggal Digunakan wajib diisi");return}if(!e.branchId){g.error("Kantor Cabang wajib diisi");return}if(!f.value){f.value=!0;try{if(P.value){const m=b((o==null?void 0:o.remaining)||0);g.error(`nominal melebihi batas tidak dapat menyimpan — sisa alokasi: ${m}`),f.value=!1;return}const s={fundraiser_id:e.applicant,submission_type:e.submissionType,program_id:e.programId||null,status:e.status,amount:e.amount,used_at:e.usedAt,purpose:e.purpose,kantor_cabang_id:e.branchId},a=await va(),n=y.value?`/admin/api/pengajuan-dana/${I.params.id}`:"/admin/api/pengajuan-dana",t=y.value?"PUT":"POST",x=await(await fetch(n,{method:t,credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(s)})).json();if(!x.success){if(x.remaining!==void 0){g.error(`nominal melebihi batas tidak dapat menyimpan — sisa alokasi: ${b(Number(x.remaining))}`),f.value=!1;return}if(x.errors){const m=Object.values(x.errors)[0];g.error(m?String(m[0]):"Validation failed"),f.value=!1;return}throw new Error(x.message||"Failed to save")}g.success(y.value?"Pengajuan dana berhasil diupdate":"Pengajuan dana berhasil ditambahkan"),F.push("/keuangan/pengajuan-dana")}catch(s){console.error("Error saving:",s),g.error("Terjadi kesalahan saat menyimpan data")}finally{f.value=!1}}};return X(async()=>{await Z(),await Q()}),X(()=>{const s=new Date().toISOString().split("T")[0];!y.value&&(!e.usedAt||String(e.usedAt).trim()==="")&&(e.usedAt=s)}),(s,a)=>(i(),da(xa,null,{default:ua(()=>{var n;return[r("div",ha,[r("div",ka,[r("h3",wa,l($.value),1),r("button",{onClick:q,class:"flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]"},"Batal")]),r("form",{onSubmit:ma(ta,["prevent"]),class:"flex flex-col"},[r("div",_a,[r("div",ja,[a[15]||(a[15]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Pengaju "),r("span",{class:"text-red-500"},"*")],-1)),w(S,{modelValue:e.applicant,"onUpdate:modelValue":a[0]||(a[0]=t=>e.applicant=t),options:_.value,placeholder:"Pilih atau cari pengaju","search-input":R.value,"onUpdate:searchInput":a[1]||(a[1]=t=>R.value=t)},null,8,["modelValue","options","search-input"])]),r("div",Sa,[a[16]||(a[16]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Tipe Pengajuan "),r("span",{class:"text-red-500"},"*")],-1)),w(S,{modelValue:e.submissionType,"onUpdate:modelValue":a[2]||(a[2]=t=>e.submissionType=t),options:H,placeholder:"Pilih tipe pengajuan","search-input":E.value,"onUpdate:searchInput":a[3]||(a[3]=t=>E.value=t)},null,8,["modelValue","search-input"])]),e.submissionType==="program"?(i(),d("div",Ia,[a[17]||(a[17]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Program",-1)),w(S,{modelValue:e.programId,"onUpdate:modelValue":a[4]||(a[4]=t=>e.programId=t),options:T.value,placeholder:"Pilih program"},null,8,["modelValue","options"]),V.value?(i(),d("div",Da,"Memuat saldo...")):k("",!0)])):k("",!0),r("div",Ta,[a[20]||(a[20]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Status "),r("span",{class:"text-red-500"},"*")],-1)),e.status==="Approved"?(i(),d("div",Pa,[a[18]||(a[18]=r("span",{class:"flex-1"},"Disetujui",-1)),C(r("input",{type:"hidden","onUpdate:modelValue":a[5]||(a[5]=t=>e.status=t)},null,512),[[N,e.status]])])):e.status==="Rejected"?(i(),d("div",Va,[a[19]||(a[19]=r("div",{class:"rounded-lg border border-red-200 bg-red-50 p-3 text-sm text-red-700 dark:border-red-800 dark:bg-red-900/10 dark:text-red-300"},[r("div",{class:"font-medium"},"Pengajuan ditolak"),r("div",{class:"text-xs"},"Anda dapat mengajukan ulang jika diperlukan.")],-1)),r("div",Aa,[r("button",{type:"button",onClick:a[6]||(a[6]=()=>{e.status="Pending"}),class:"rounded bg-brand-500 px-3 py-1 text-sm text-white"},"Ajukan lagi"),r("button",{type:"button",onClick:a[7]||(a[7]=()=>{e.status="Draft"}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Simpan sebagai Draft")])])):(i(),d("div",Ca,[w(S,{modelValue:e.status,"onUpdate:modelValue":a[8]||(a[8]=t=>e.status=t),options:ea.value,placeholder:"Pilih status"},null,8,["modelValue","options"])]))]),r("div",Na,[a[21]||(a[21]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Nominal "),r("span",{class:"text-red-500"},"*")],-1)),r("div",Fa,[C(r("input",{type:"number","onUpdate:modelValue":a[9]||(a[9]=t=>e.amount=t),placeholder:"Masukkan nominal",min:"1",step:"1",required:"",class:"dark:bg-dark-900 h-11 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pr-24 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",onInput:J},null,544),[[N,e.amount,void 0,{number:!0}]]),r("span",Ra,l(K.value),1)]),a[22]||(a[22]=r("p",{class:"mt-1 text-xs text-gray-500 dark:text-gray-400"},"Minimal nominal: Rp 1",-1)),P.value?(i(),d("p",Ea,"Nominal melebihi sisa alokasi: "+l(b(((n=o.value)==null?void 0:n.remaining)||0)),1)):U.amount?(i(),d("p",Ma,l(U.amount),1)):k("",!0)]),r("div",Ua,[a[23]||(a[23]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Tanggal Digunakan "),r("span",{class:"text-red-500"},"*")],-1)),r("div",qa,[w(ga(fa),{modelValue:e.usedAt,"onUpdate:modelValue":a[10]||(a[10]=t=>e.usedAt=t),config:B,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih tanggal digunakan",required:""},null,8,["modelValue"])])]),r("div",La,[a[24]||(a[24]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},[h("Kantor Cabang "),r("span",{class:"text-red-500"},"*")],-1)),w(S,{modelValue:e.branchId,"onUpdate:modelValue":a[11]||(a[11]=t=>e.branchId=t),options:D.value,placeholder:"Pilih atau cari kantor cabang","search-input":M.value,"onUpdate:searchInput":a[12]||(a[12]=t=>M.value=t)},null,8,["modelValue","options","search-input"])]),p.value?(i(),d("div",Xa,[r("div",Oa,[r("div",$a,[r("div",null,[a[25]||(a[25]=r("div",{class:"text-xs text-gray-500"},"Program",-1)),r("div",Ba,l(p.value.nama_program||p.value.nama||""),1)]),r("div",Ha,[p.value&&Array.isArray(p.value.shares)?(i(),d("div",Ka,[r("div",Wa,[(i(!0),d(pa,null,ca(G.value,t=>(i(),d("span",{key:t.id||t.share_id||t.program_share_id,class:"inline-flex items-center rounded px-2 py-0.5 bg-gray-100 text-xs text-gray-700 dark:bg-gray-800/40 dark:text-gray-300"},[t.type==="percentage"||t.type_key&&String(t.type_key).toLowerCase().includes("percent")?(i(),d("span",Ga,l(Number(t.value||0))+"% ",1)):(i(),d("span",Ya,l(b(Number(t.value||0))),1))]))),128))])])):(i(),d("div",za," "))])]),o.value?(i(),d("div",Ja,[r("div",Qa,[r("div",null,[r("div",Za,"Sisa alokasi bulan "+l(W(o.value.month)),1),r("div",ae,l(b(o.value.remaining)),1)]),r("div",ee,[r("div",null,"Inflow: "+l(b(o.value.inflow)),1),r("div",null,"Dialokasikan: "+l(b(o.value.allocated)),1),r("div",null,"Terpakai: "+l(b(o.value.outflow)),1)])]),r("div",te,[a[26]||(a[26]=r("div",{class:"text-sm text-gray-600"},"Opsi:",-1)),r("div",re,[r("button",{type:"button",onClick:a[13]||(a[13]=()=>{e.amount=o.value.remaining}),class:"rounded bg-gray-100 px-3 py-1 text-sm"},"Gunakan Seluruh Alokasi")])]),r("div",se,[r("div",null,[a[27]||(a[27]=h("Estimasi sisa setelah pengajuan: ",-1)),r("span",ne,l(b((o.value.remaining||0)-(e.amount||0))),1)]),(e.amount||0)>(o.value.remaining||0)?(i(),d("div",oe,"Kekurangan: "+l(b((e.amount||0)-(o.value.remaining||0))),1)):k("",!0)])])):k("",!0)])])):k("",!0),r("div",ie,[a[28]||(a[28]=r("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Tujuan Pengajuan",-1)),C(r("textarea",{"onUpdate:modelValue":a[14]||(a[14]=t=>e.purpose=t),placeholder:"Masukkan tujuan atau alasan pengajuan dana",maxlength:"1000",rows:"4",class:"dark:bg-dark-900 w-full rounded-lg border border-gray-300 bg-transparent bg-none px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800"},null,512),[[N,e.purpose]]),r("p",le,l(e.purpose.length)+"/1000 karakter",1)])]),r("div",de,[r("button",{onClick:q,type:"button",class:"flex w-full justify-center rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03] sm:w-auto"},"Batal"),r("button",{disabled:f.value||P.value,type:"submit",class:ba(["flex w-full justify-center rounded-lg px-4 py-2.5 text-sm font-medium sm:w-auto",f.value||P.value?"bg-gray-300 text-gray-600 cursor-not-allowed":"bg-brand-500 text-white hover:bg-brand-600"])},l(y.value?"Simpan Perubahan":"Simpan"),11,ue)])],32)])]}),_:1}))}});export{fe as default};
