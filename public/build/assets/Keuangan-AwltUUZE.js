import{d as pe,H as ye,I as ve,b as D,L as be,A as K,P as we,f as _e,W as ke,B as De,g as xe,o as A,w as Ce,a as g,j as W,t as U,m as Se,u as ee,c as z,i as Te,Q as Re,U as ae}from"./admin-Dzqbb435.js";import{C as Fe}from"./component-DQWepy05.js";import{u as J,w as Ne}from"./xlsx-3SA47z_C.js";import{_ as Ie}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BEZrvUOQ.js";import{_ as Pe}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-CBjn2u9t.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const $e={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Ee={class:"mb-6 flex items-center justify-between"},Ke={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Ae={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Be={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},Me={class:"relative"},ze={class:"relative",style:{width:"100%",height:"450px"}},Ve={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Oe={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},je={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},He={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Le={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},Ge={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},We={class:"text-gray-500 dark:text-gray-500 text-sm"},aa=pe({__name:"Keuangan",setup(Ue){const te=ye();ve();const re=D(String(te.meta.title||"Keuangan")),B=D(null),N=D(null),q=D(null),V=be(),{fetchUser:ne,hasPermission:O,isAdmin:j}=we();K(()=>j()||O("create keuangan")),K(()=>j()||O("update keuangan")),K(()=>j()||O("delete keuangan"));const H=D(!1),M=D(null),oe={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},I=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:k},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:k},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:k},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:k},{headerName:"Program",field:"program",valueFormatter:k},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:k},{headerName:"Bonus",field:"bonus",valueFormatter:k},{headerName:"Championship",field:"championship",valueFormatter:k}]}],L={resizable:!0,sortable:!0,filter:!1};L.minWidth=120,L.cellClass="text-sm";function k(a){return a&&a.value!==void 0&&a.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(a.value):""}function se(a){switch((a||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(a)}}const T=D([]),x=D((()=>{const a=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],n=[],o=new Date("2024-01-01");for(let r=1;r<=200;r++){const i=(r-1)%a.length,v=(r-1)%t.length,b=new Date(o);b.setDate(b.getDate()+(r-1)*2);const p=Math.floor(Math.random()*75e6)+25e6;n.push({id:r.toString(),pic:a[i],jumlah:p,kantorCabang:t[v],tanggalKeuangan:b.toISOString().split("T")[0]})}return n})()),C=D(""),Y=K(()=>x.value),ie=K(()=>Y.value.length===0),le=()=>{M.value&&(x.value=x.value.filter(a=>a.id!==M.value),V.success("Data keuangan berhasil dihapus"),H.value=!1,M.value=null,$())},de=()=>{H.value=!1,M.value=null},ue=()=>{const a=[],t=[],n=[],o=[];let r=0;I.forEach(f=>{if(f.field){const _=f.headerName||f.field;t.push(_),n.push(""),o.push({s:{r:0,c:r},e:{r:1,c:r}}),a.push(f.field),r+=1}else if(f.children&&Array.isArray(f.children)){const _=f.headerName||"",S=f.children.length;for(let u=0;u<S;u++)t.push(u===0?_:"");o.push({s:{r:0,c:r},e:{r:0,c:r+S-1}}),f.children.forEach(u=>{n.push(u.headerName||u.field),a.push(u.field),r+=1})}});const i=[];i.push(t),i.push(n),x.value.forEach(f=>{const _=[];a.forEach(S=>{const u=f[S];_.push(typeof u=="number"?u:u??"")}),i.push(_)}),T.value&&T.value.length&&T.value.forEach(f=>{const _=[];a.forEach(S=>{const u=f[S];_.push(typeof u=="number"?u:u??"")}),i.push(_)});const v=J.aoa_to_sheet(i);v["!merges"]=v["!merges"]||[],o.forEach(f=>v["!merges"].push(f));const b=J.book_new();J.book_append_sheet(b,v,"Keuangan");const h=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ne(b,h)},ce=(a,t)=>{if(!t||t.length===0)return a;const n=[...a];return t.forEach(o=>{const{colId:r,sort:i}=o;n.sort((v,b)=>{let p=v[r],h=b[r];return r==="tanggalKeuangan"?(p=new Date(p).getTime(),h=new Date(h).getTime()):r==="jumlah"?(p=p||0,h=h||0):typeof p=="string"&&(p=p.toLowerCase(),h=h.toLowerCase()),p<h?i==="asc"?-1:1:p>h?i==="asc"?1:-1:0})}),n},X=()=>({getRows:a=>{setTimeout(()=>{const t=a.startRow||0,n=a.endRow||0;let o=Y.value;a.sortModel&&a.sortModel.length>0&&(o=ce(o,a.sortModel));const r=o.slice(t,n);let i;o.length===0?i=0:o.length<=n?i=o.length:i=void 0,a.successCallback(r,i)},50)}}),P=D(X()),Q=async()=>{var a,t;try{let n="/admin/api/keuangan/program-shares-summary";try{const e=C.value;let s=null,l=null;if(e){if(Array.isArray(e))s=e[0]?e[0]instanceof Date?e[0].toISOString().split("T")[0]:String(e[0]):null,l=e[1]?e[1]instanceof Date?e[1].toISOString().split("T")[0]:String(e[1]):null;else if(typeof e=="string"){const c=e.includes(" to ")?" to ":e.includes(" - ")?" - ":"";if(c){const y=e.split(c);s=((a=y[0])==null?void 0:a.trim())||null,l=((t=y[1])==null?void 0:t.trim())||null}else s=e||null,l=e||null}}const m={};s&&(m.start_date=s),l&&(m.end_date=l);const d=new URLSearchParams(m).toString();d&&(n+=`?${d}`)}catch{}const r=await(await fetch(n,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){V.error("Gagal memuat ringkasan program");return}const i=r.data.rows||[],v=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],b=[];b.push({headerName:"Tanggal Transaksi",field:"tanggal",pinned:"left",width:250}),b.push({headerName:"Nominal Transaksi",field:"nominal",pinned:"left",width:160,valueFormatter:k,resizable:!0}),i.forEach(e=>{const s=[];s.push({headerName:"Nominal Transaksi",field:`p_${e.program_id||e.id}_nominal`,valueFormatter:k,resizable:!0,width:160});const l=v.map(d=>{let c="";try{const y=e.shares_meta||{},w=y[d]||y[d.toString()]||null;if(w)if(w.type==="percentage"&&w.value!==null&&w.value!==void 0){const F=Number(w.value);Number.isFinite(F)?c=Number.isInteger(F)?` (${F}%)`:` (${F%1===0?F:parseFloat(F.toFixed(2))}%)`:c=` (${w.value}%)`}else w.type==="nominal"&&w.value!==null&&w.value!==void 0&&(c=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(w.value)})`)}catch{}return{headerName:`${se(d)}${c}`,field:`p_${e.program_id||e.id}_${d}`,valueFormatter:k,resizable:!0,minWidth:120}});s.push(...l);const m=`${e.program_name||e.nama_program||e.nama||"Program"}`;b.push({headerName:m,children:s})}),I.splice(0,I.length,...b),ae(()=>{var s;const e=N.value||((s=B.value)==null?void 0:s.api);if(e)try{e.setColumnDefs(I);try{e.setDatasource&&P.value?e.setDatasource(P.value):e.setRowData(x.value)}catch{try{e.setRowData(x.value)}catch{}}e.setPinnedBottomRowData(T.value);try{e.sizeColumnsToFit()}catch{}setTimeout(()=>{try{Z()}catch{}},80)}catch(l){console.error("Failed to apply dynamic columns to grid",l)}});const p=r.data.transaksis||[],h={},f=e=>{if(!e)return"";const s=new Date(e);return isNaN(s.getTime())?e:s.toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"})};p.forEach(e=>{const s=(e.tanggal_transaksi||e.tanggal||e.date||"").toString(),l=s;h[l]||(h[l]={tanggal:f(s),kode:null,nominal:0},i.forEach(d=>{h[l][`p_${d.program_id||d.id}_nominal`]=0,v.forEach(c=>{h[l][`p_${d.program_id||d.id}_${c}`]=0})}));const m=h[l];m.kode=m.kode||e.kode||null,m.nominal=(m.nominal||0)+(e.nominal||0),i.forEach(d=>{v.forEach(c=>{const y=`p_${d.program_id||d.id}_${c}`,w=`p_${d.program_id||d.id}`;c==="program"&&e[w]!==void 0?m[y]+=e[w]||0:m[y]+=e[y]||0});try{const c=d.program_id||d.id;e.program_id&&String(e.program_id)===String(c)&&(m[`p_${c}_nominal`]=(m[`p_${c}_nominal`]||0)+(e.nominal||0))}catch{}})});const _=Object.values(h);x.value=_;const S=_.reduce((e,s)=>e+(s.nominal||0),0),u={tanggal:"TOTAL"},G={tanggal:"DISBURSED TOTALS"},R=r.data&&r.data.disbursed_totals_by_program?r.data.disbursed_totals_by_program:{};i.forEach(e=>{const s=`p_${e.program_id||e.id}_nominal`;u[s]=e.total_transaksi||0,G[s]=0,v.forEach(l=>{const m=`p_${e.program_id||e.id}_${l}`;u[m]=e[l]||0;const d=m,c=`p_${e.program_id||e.id}`;let y=0;R&&R[d]!==void 0?y=R[d]:l==="program"&&R&&R[c]!==void 0&&(y=R[c]),G[m]=y||0})}),u.nominal=S,T.value=[u,G],$(!0)}catch(n){console.error(n),V.error("Terjadi kesalahan saat memuat ringkasan program")}},$=(a=!1)=>{ae(()=>{var n;const t=N.value||((n=B.value)==null?void 0:n.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&P.value?t.setDatasource(P.value):t.setRowData(x.value)}catch{}t.setPinnedBottomRowData(T.value),a&&window.setTimeout(()=>{var r;const o=N.value||((r=B.value)==null?void 0:r.api);if(o)try{o.ensureIndexVisible(0,"top")}catch{}},100)}catch(o){console.error("Error refreshing grid:",o)}})};_e(async()=>{await ne(),await Q(),$()});function me(a){N.value=a.api,q.value=a.columnApi;try{const t=P.value||X();a.api.setDatasource&&a.api.setDatasource(t)}catch(t){console.error("Failed to set datasource for infinite row model",t)}}function Z(){var o;const a=q.value;if(!a)return;const t=a.getAllColumns();if(!t||!t.length)return;const n=t.map(r=>r.getColId());try{a.autoSizeColumns(n,!1)}catch{try{(o=N.value)==null||o.sizeColumnsToFit()}catch{}}}function ge(a){try{a.api.sizeColumnsToFit()}catch{}Z()}ke(()=>{E&&clearTimeout(E)});const he=()=>{$()};let E=null;De([C],()=>{E&&clearTimeout(E),E=setTimeout(async()=>{try{await Q()}catch{}$(!0)},300)});const fe=()=>{C.value=""};return(a,t)=>(A(),xe(Ie,null,{default:Ce(()=>[g("div",$e,[g("div",Ee,[g("h3",Ke,U(re.value),1),g("div",{class:"flex items-center gap-3"},[g("button",{onClick:ue,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[g("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[g("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Se(" Export Excel ",-1)])])])]),g("div",Ae,[g("div",Be,[g("div",null,[t[2]||(t[2]=g("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),g("div",Me,[W(ee(Fe),{modelValue:C.value,"onUpdate:modelValue":t[0]||(t[0]=n=>C.value=n),config:oe,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),g("div",{class:"mt-4"},[g("button",{onClick:fe,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),g("div",ze,[g("div",Ve,[W(ee(Re),{ref_key:"agGridRef",ref:B,onGridReady:me,onFirstDataRendered:ge,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:I,defaultColDef:L,pinnedBottomRowData:T.value,rowModelType:"infinite",cacheBlockSize:50,maxBlocksInCache:10,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:he},null,8,["pinnedBottomRowData"])]),ie.value?(A(),z("div",Oe,[(A(),z("svg",je,[a.filterPIC||a.filterKantorCabang||C.value||a.filterJumlahMin||a.filterJumlahMax?(A(),z("path",He)):(A(),z("path",Le))])),g("p",Ge,U(C.value?"Tidak ada data ditemukan":"Tidak ada data"),1),g("p",We,U(C.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Te("",!0)])]),W(Pe,{isOpen:H.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:le,onCancel:de},null,8,["isOpen"])]),_:1}))}});export{aa as default};
