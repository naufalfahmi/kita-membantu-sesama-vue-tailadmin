import{d as be,H as ye,I as ve,b as y,M as we,A as P,Q as _e,f as ke,X as xe,B as De,g as Ce,o as T,w as Se,a as i,j as W,t as B,m as Te,u as ee,c as R,F as Ne,l as Re,i as Fe,S as Ie,V as ae}from"./admin-Curnrupr.js";import{C as Ae}from"./component-COL6KC_D.js";import{u as U,w as Ke}from"./xlsx-3SA47z_C.js";import{_ as Pe}from"./AdminLayout.vue_vue_type_script_setup_true_lang-BsXeBU08.js";import{_ as Be}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-BqZJpFxB.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Ee={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Me={class:"mb-6 flex items-center justify-between"},$e={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},ze={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ve={class:"grid grid-cols-1 gap-4 md:grid-cols-1 lg:grid-cols-1"},He={class:"relative"},je={class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},Oe={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},Le={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Ge={class:"relative",style:{width:"100%",height:"450px"}},We={class:"ag-theme-alpine dark:ag-theme-alpine-dark",style:{width:"100%",height:"100%"}},Ue={key:0,class:"absolute inset-0 flex flex-col items-center justify-center bg-white dark:bg-gray-900 rounded-lg z-50 pointer-events-none",style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0"}},Je={class:"w-16 h-16 text-gray-400 dark:text-gray-500 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},qe={key:0,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"},Xe={key:1,"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"},Ye={class:"text-gray-600 dark:text-gray-400 text-lg font-medium mb-1"},Qe={class:"text-gray-500 dark:text-gray-500 text-sm"},ia=be({__name:"Keuangan",setup(Ze){const te=ye();ve();const re=y(String(te.meta.title||"Keuangan")),E=y(null),F=y(null),J=y(null),z=we(),{fetchUser:ne,hasPermission:V,isAdmin:H}=_e();P(()=>H()||V("create keuangan")),P(()=>H()||V("update keuangan")),P(()=>H()||V("delete keuangan"));const j=y(!1),M=y(null),se={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},I=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:b},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:b},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:b},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:b},{headerName:"Program",field:"program",valueFormatter:b},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:b},{headerName:"Bonus",field:"bonus",valueFormatter:b},{headerName:"Championship",field:"championship",valueFormatter:b}]}],O={resizable:!0,sortable:!0,filter:!1};O.minWidth=120,O.cellClass="text-sm";function b(e){return e&&e.value!==void 0&&e.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(e.value):""}const oe=e=>b({value:e});function le(e){switch((e||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(e)}}function q(e,t){var r;const s=le(e);if(s&&s!==String(e))return s;try{for(const n of t||[]){const l=(r=n==null?void 0:n.shares_meta)==null?void 0:r[e];if(l){if(typeof l=="string")return l;if(l.label||l.name||l.title)return l.label||l.name||l.title}if(n&&n.share_labels&&n.share_labels[e])return n.share_labels[e]}}catch{}let o=String(e).replace(/^custom_/,"").replace(/_/g," ");return o=o.replace(/\b\w/g,n=>n.toUpperCase()),o}const C=y([]),X=y([]),v=y((()=>{const e=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],t=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],s=[],o=new Date("2024-01-01");for(let r=1;r<=200;r++){const n=(r-1)%e.length,l=(r-1)%t.length,p=new Date(o);p.setDate(p.getDate()+(r-1)*2);const h=Math.floor(Math.random()*75e6)+25e6;s.push({id:r.toString(),pic:e[n],jumlah:h,kantorCabang:t[l],tanggalKeuangan:p.toISOString().split("T")[0]})}return s})()),D=y(""),Y=P(()=>v.value),ie=P(()=>Y.value.length===0),ue=()=>{M.value&&(v.value=v.value.filter(e=>e.id!==M.value),z.success("Data keuangan berhasil dihapus"),j.value=!1,M.value=null,A())},ce=()=>{j.value=!1,M.value=null},de=()=>{const e=[],t=[],s=[],o=[];let r=0;I.forEach(u=>{if(u.field){const f=u.headerName||u.field;t.push(f),s.push(""),o.push({s:{r:0,c:r},e:{r:1,c:r}}),e.push(u.field),r+=1}else if(u.children&&Array.isArray(u.children)){const f=u.headerName||"",x=u.children.length;for(let d=0;d<x;d++)t.push(d===0?f:"");o.push({s:{r:0,c:r},e:{r:0,c:r+x-1}}),u.children.forEach(d=>{s.push(d.headerName||d.field),e.push(d.field),r+=1})}});const n=[];n.push(t),n.push(s),v.value.forEach(u=>{const f=[];e.forEach(x=>{const d=u[x];f.push(typeof d=="number"?d:d??"")}),n.push(f)}),C.value&&C.value.length&&C.value.forEach(u=>{const f=[];e.forEach(x=>{const d=u[x];f.push(typeof d=="number"?d:d??"")}),n.push(f)});const l=U.aoa_to_sheet(n);l["!merges"]=l["!merges"]||[],o.forEach(u=>l["!merges"].push(u));const p=U.book_new();U.book_append_sheet(p,l,"Keuangan");const g=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;Ke(p,g)},me=(e,t)=>{if(!t||t.length===0)return e;const s=[...e];return t.forEach(o=>{const{colId:r,sort:n}=o;s.sort((l,p)=>{let h=l[r],g=p[r];return r==="tanggalKeuangan"?(h=new Date(h).getTime(),g=new Date(g).getTime()):r==="jumlah"?(h=h||0,g=g||0):typeof h=="string"&&(h=h.toLowerCase(),g=g.toLowerCase()),h<g?n==="asc"?-1:1:h>g?n==="asc"?1:-1:0})}),s},$=y({getRows:e=>{setTimeout(()=>{const t=e.startRow||0,s=e.endRow||0;let o=Y.value;e.sortModel&&e.sortModel.length>0&&(o=me(o,e.sortModel));const r=o.slice(t,s);let n;o.length===0?n=0:o.length<=s?n=o.length:n=void 0,e.successCallback(r,n)},50)}}),Q=async()=>{var e,t;try{let s="/admin/api/keuangan/program-shares-summary";try{const a=D.value;let c=null,m=null;if(a){if(Array.isArray(a))c=a[0]?a[0]instanceof Date?a[0].toISOString().split("T")[0]:String(a[0]):null,m=a[1]?a[1]instanceof Date?a[1].toISOString().split("T")[0]:String(a[1]):null;else if(typeof a=="string"){const S=a.includes(" to ")?" to ":a.includes(" - ")?" - ":"";if(S){const L=a.split(S);c=((e=L[0])==null?void 0:e.trim())||null,m=((t=L[1])==null?void 0:t.trim())||null}else c=a||null,m=a||null}}const w={};c&&(w.start_date=c),m&&(w.end_date=m);const _=new URLSearchParams(w).toString();_&&(s+=`?${_}`)}catch{}const r=await(await fetch(s,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!r.success){z.error("Gagal memuat ringkasan program");return}const n=r.data.rows||[],l=r.data.columns&&r.data.columns.length?r.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"],p=[];p.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),p.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:b,resizable:!0});const h=r.data&&r.data.share_type_labels?r.data.share_type_labels:{};n.forEach(a=>{const c=[];c.push({headerName:"Nominal Transaksi",field:`p_${a.program_id||a.id}_nominal`,valueFormatter:b,resizable:!0,width:160});const m=l.map(_=>{let S="";try{const G=a.shares_meta||{},k=G[_]||G[_.toString()]||null;if(k)if(k.type==="percentage"&&k.value!==null&&k.value!==void 0){const N=Number(k.value);Number.isFinite(N)?S=Number.isInteger(N)?` (${N}%)`:` (${N%1===0?N:parseFloat(N.toFixed(2))}%)`:S=` (${k.value}%)`}else k.type==="nominal"&&k.value!==null&&k.value!==void 0&&(S=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(k.value)})`)}catch{}return{headerName:`${h[_]||q(_,n)}${S}`,field:`p_${a.program_id||a.id}_${_}`,valueFormatter:b,resizable:!0,minWidth:120}});c.push(...m);const w=`${a.program_name||a.nama_program||a.nama||"Program"}`;p.push({headerName:w,children:c})}),I.splice(0,I.length,...p),ae(()=>{var c;const a=F.value||((c=E.value)==null?void 0:c.api);if(a)try{a.setColumnDefs(I);try{a.setDatasource&&$.value?a.setDatasource($.value):a.setRowData(v.value)}catch{try{a.setRowData(v.value)}catch{}}a.setPinnedBottomRowData(C.value);try{a.sizeColumnsToFit()}catch{}setTimeout(()=>{try{Z()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const g={summary_label:"TOTAL"},u=n.reduce((a,c)=>a+(c.total_transaksi||0),0);n.forEach(a=>{const c=`p_${a.program_id||a.id}_nominal`;g[c]=a.total_transaksi||0,l.forEach(m=>{const w=`p_${a.program_id||a.id}_${m}`;g[w]=a[m]||0})}),g.nominal=u;const f=[];f.push({label:"Nominal Keseluruhan Transaksi",value:u});let x=0;l.forEach(a=>{const c=n.reduce((w,_)=>w+(Number(_[a]||0)||0),0),m=h[a]||q(a,n);f.push({label:`Nominal All ${m}`,value:c}),x+=c});const d=u-x;d>0&&f.push({label:"Sisa Belum Teralokasi",value:d}),X.value=f,v.value=[g],C.value=[],A(!0)}catch(s){console.error(s),z.error("Terjadi kesalahan saat memuat ringkasan program")}},A=(e=!1)=>{ae(()=>{var s;const t=F.value||((s=E.value)==null?void 0:s.api);if(t)try{try{t.purgeInfiniteCache?t.purgeInfiniteCache():t.setDatasource&&$.value?t.setDatasource($.value):t.setRowData(v.value)}catch{}t.setPinnedBottomRowData(C.value),e&&window.setTimeout(()=>{var r;const o=F.value||((r=E.value)==null?void 0:r.api);if(o)try{o.ensureIndexVisible(0,"top")}catch{}},100)}catch(o){console.error("Error refreshing grid:",o)}})};ke(async()=>{await ne(),await Q(),A()});function he(e){F.value=e.api,J.value=e.columnApi;try{e.api.setRowData&&e.api.setRowData(v.value)}catch{}}function Z(){var o;const e=J.value;if(!e)return;const t=e.getAllColumns();if(!t||!t.length)return;const s=t.map(r=>r.getColId());try{e.autoSizeColumns(s,!1)}catch{try{(o=F.value)==null||o.sizeColumnsToFit()}catch{}}}function ge(e){try{e.api.sizeColumnsToFit()}catch{}Z()}xe(()=>{K&&clearTimeout(K)});const fe=()=>{A()};let K=null;De([D],()=>{K&&clearTimeout(K),K=setTimeout(async()=>{try{await Q()}catch{}A(!0)},300)});const pe=()=>{D.value=""};return(e,t)=>(T(),Ce(Pe,null,{default:Se(()=>[i("div",Ee,[i("div",Me,[i("h3",$e,B(re.value),1),i("div",{class:"flex items-center gap-3"},[i("button",{onClick:de,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...t[1]||(t[1]=[i("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[i("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Te(" Export Excel ",-1)])])])]),i("div",ze,[i("div",Ve,[i("div",null,[t[2]||(t[2]=i("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),i("div",He,[W(ee(Ae),{modelValue:D.value,"onUpdate:modelValue":t[0]||(t[0]=s=>D.value=s),config:se,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])])]),i("div",{class:"mt-4"},[i("button",{onClick:pe,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),i("div",je,[(T(!0),R(Ne,null,Re(X.value,(s,o)=>(T(),R("div",{key:`summary-${o}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[i("p",Oe,B(s.label),1),i("p",Le,B(oe(s.value)),1)]))),128))]),i("div",Ge,[i("div",We,[W(ee(Ie),{ref_key:"agGridRef",ref:E,onGridReady:he,onFirstDataRendered:ge,class:"ag-theme-alpine",style:{width:"100%",height:"100%"},columnDefs:I,defaultColDef:O,pinnedBottomRowData:C.value,rowData:v.value,suppressSorting:!1,theme:"legacy",animateRows:!0,suppressHorizontalScroll:!1,onSortChanged:fe},null,8,["pinnedBottomRowData","rowData"])]),ie.value?(T(),R("div",Ue,[(T(),R("svg",Je,[e.filterPIC||e.filterKantorCabang||D.value||e.filterJumlahMin||e.filterJumlahMax?(T(),R("path",qe)):(T(),R("path",Xe))])),i("p",Ye,B(D.value?"Tidak ada data ditemukan":"Tidak ada data"),1),i("p",Qe,B(D.value?"Coba ubah filter pencarian Anda":"Belum ada data yang tersedia"),1)])):Fe("",!0)])]),W(Be,{isOpen:j.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ue,onCancel:ce},null,8,["isOpen"])]),_:1}))}});export{ia as default};
