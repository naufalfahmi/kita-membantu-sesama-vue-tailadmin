import{d as De,H as Se,I as Ce,b as g,M as Ne,A as $,Q as Te,f as Fe,X as Pe,B as Re,g as Ke,o as h,w as Ae,a as s,j,c as x,i as B,t as p,m as Z,u as Ie,F as ee,l as ae,V as de}from"./admin-CT5My_mW.js";import{C as Me}from"./component-BH1YZyCW.js";import{u as te,w as $e}from"./xlsx-3SA47z_C.js";import{_ as Be}from"./AdminLayout.vue_vue_type_script_setup_true_lang-CDNBll6s.js";import{_ as Ve}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-DS49H51h.js";import{A as ce}from"./AsyncSearchableSelect-BBDMmUZs.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const ze={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},Ee={class:"mb-6 flex items-center justify-between"},Oe={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},je={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},He={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-3"},Le={class:"relative"},Ue={key:0,class:"mb-6 flex items-center justify-center gap-3 rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.02]"},Ge={key:1,class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},We={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},qe={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Xe={class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ye={class:"grid gap-4 md:grid-cols-2 lg:grid-cols-2"},Je={class:"bg-gray-100 dark:bg-gray-800/50 px-4 py-3 border-b border-gray-200 dark:border-gray-700"},Qe={class:"flex items-center justify-between"},Ze={class:"font-semibold text-gray-800 dark:text-white/90"},ea={key:0,class:"text-sm font-normal text-gray-600 dark:text-gray-400"},aa={class:"overflow-x-auto"},ta={class:"w-full"},ra={class:"divide-y divide-gray-200 dark:divide-gray-700"},sa={class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},oa={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},la={class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},na={key:0,class:"text-xs text-gray-500 ml-2"},ia={key:1,class:"text-xs text-gray-500 ml-2"},ua={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},da={key:0,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},ca={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},ka=De({__name:"Keuangan",setup(ma){const me=Se();Ce();const ge=g(String(me.meta.title||"Keuangan")),H=g(null),V=g(null),he=g(null),R=Ne(),{fetchUser:be,hasPermission:L,isAdmin:U}=Te();$(()=>U()||L("create keuangan")),$(()=>U()||L("update keuangan")),$(()=>U()||L("delete keuangan"));const G=g(!1),z=g(null),E=g(!1),fe={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},W=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:b},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:b},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:b},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:b},{headerName:"Program",field:"program",valueFormatter:b},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:b},{headerName:"Bonus",field:"bonus",valueFormatter:b},{headerName:"Championship",field:"championship",valueFormatter:b}]}];function b(t){return t&&t.value!==void 0&&t.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t.value):""}const K=t=>b({value:t}),re=t=>{if(t==null)return"";const a=Number(t);return Number.isFinite(a)?Number.isInteger(a)?`${a}%`:`${parseFloat(a.toFixed(2))}%`:`${String(t)}%`};function se(t){switch((t||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(t)}}function ye(t){return String(t||"").replace(/^custom_/,"")}function q(t,a){var i,f;const e=ye(t);try{if(_.value&&(_.value[t]||_.value[e]))return _.value[t]||_.value[e]}catch{}const o=se(e);if(o&&o!==String(e))return o;try{for(const u of a||[]){if(!u)continue;const l=((i=u==null?void 0:u.shares_meta)==null?void 0:i[t])||((f=u==null?void 0:u.shares_meta)==null?void 0:f[e]);if(l){if(typeof l=="string")return l;if(l.label||l.name||l.title)return l.label||l.name||l.title}if(u&&u.share_labels&&(u.share_labels[t]||u.share_labels[e]))return u.share_labels[t]||u.share_labels[e]}}catch{}let n=String(e).replace(/_/g," ");return n=n.replace(/\b\w/g,u=>u.toUpperCase()),n}const X=g([]),S=g([]),C=g([]),_=g({}),oe=g([]),D=g((()=>{const t=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],a=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],e=[],o=new Date("2024-01-01");for(let n=1;n<=200;n++){const i=(n-1)%t.length,f=(n-1)%a.length,u=new Date(o);u.setDate(u.getDate()+(n-1)*2);const l=Math.floor(Math.random()*75e6)+25e6;e.push({id:n.toString(),pic:t[i],jumlah:l,kantorCabang:a[f],tanggalKeuangan:u.toISOString().split("T")[0]})}return e})()),A=g(""),N=g(""),T=g(""),le=$(()=>D.value);$(()=>le.value.length===0);const ve=()=>{z.value&&(D.value=D.value.filter(t=>t.id!==z.value),R.success("Data keuangan berhasil dihapus"),G.value=!1,z.value=null,I())},xe=()=>{G.value=!1,z.value=null},ne=t=>{if(!t)return 0;const a=Number(t.total_transaksi||0),e=(C.value||[]).reduce((o,n)=>{const i=Number((t==null?void 0:t[n])||0);return o+(Number.isFinite(i)?i:0)},0);return Math.max(0,a-e)},pe=async()=>{try{await Y(),I(!0),R.success("Data berhasil diperbarui")}catch{R.error("Gagal memperbarui data")}},ie=()=>{const t=["Program","Nominal Transaksi",...C.value.map(l=>_.value[l]||se(l))],a=[];a.push(t),S.value.forEach(l=>{const d=[];d.push((l==null?void 0:l.program_name)||""),d.push(Number((l==null?void 0:l.total_transaksi)||0)),C.value.forEach(w=>{d.push(Number((l==null?void 0:l[w])||0))}),a.push(d)});const e=[];e.push("TOTAL");const o=S.value.reduce((l,d)=>l+Number((d==null?void 0:d.total_transaksi)||0),0);e.push(o),C.value.forEach(l=>{const d=S.value.reduce((w,F)=>w+Number((F==null?void 0:F[l])||0),0);e.push(d)}),a.push(e);const n=te.aoa_to_sheet(a),i=te.book_new();te.book_append_sheet(i,n,"Keuangan");const u=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;$e(i,u)},_e=(t,a)=>{if(!a||a.length===0)return t;const e=[...t];return a.forEach(o=>{const{colId:n,sort:i}=o;e.sort((f,u)=>{let l=f[n],d=u[n];return n==="tanggalKeuangan"?(l=new Date(l).getTime(),d=new Date(d).getTime()):n==="jumlah"?(l=l||0,d=d||0):typeof l=="string"&&(l=l.toLowerCase(),d=d.toLowerCase()),l<d?i==="asc"?-1:1:l>d?i==="asc"?1:-1:0})}),e},O=g({getRows:t=>{setTimeout(()=>{const a=t.startRow||0,e=t.endRow||0;let o=le.value;t.sortModel&&t.sortModel.length>0&&(o=_e(o,t.sortModel));const n=o.slice(a,e);let i;o.length===0?i=0:o.length<=e?i=o.length:i=void 0,t.successCallback(n,i)},50)}}),Y=async()=>{var t,a;E.value=!0;try{let e="/admin/api/keuangan/program-shares-summary";try{const r=A.value;let c=null,m=null;if(r){if(Array.isArray(r))c=r[0]?r[0]instanceof Date?r[0].toISOString().split("T")[0]:String(r[0]):null,m=r[1]?r[1]instanceof Date?r[1].toISOString().split("T")[0]:String(r[1]):null;else if(typeof r=="string"){const P=r.includes(" to ")?" to ":r.includes(" - ")?" - ":"";if(P){const J=r.split(P);c=((t=J[0])==null?void 0:t.trim())||null,m=((a=J[1])==null?void 0:a.trim())||null}else c=r||null,m=r||null}}const y={};c&&(y.start_date=c),m&&(y.end_date=m),N.value&&(y.fundraiser_id=N.value),T.value&&(y.mitra_id=T.value);const v=new URLSearchParams(y).toString();v&&(e+=`?${v}`)}catch{}const n=await(await fetch(e,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!n.success){R.error("Gagal memuat ringkasan program");return}const i=n.data.rows||[],f=n.data.columns&&n.data.columns.length?n.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"];S.value=(i||[]).filter(Boolean),C.value=f;const u=[];u.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),u.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:b,resizable:!0}),_.value=n.data&&n.data.share_type_labels?n.data.share_type_labels:{},i.forEach(r=>{if(!r)return;const c=[];c.push({headerName:"Nominal Transaksi",field:`p_${r.program_id||r.id}_nominal`,valueFormatter:b,resizable:!0,width:160});const m=f.map(v=>{let P="";try{const Q=r.shares_meta||{},k=Q[v]||Q[v.toString()]||null;k&&(k.type==="percentage"&&k.value!==null&&k.value!==void 0?P=` (${re(k.value)})`:k.type==="nominal"&&k.value!==null&&k.value!==void 0&&(P=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(k.value)})`))}catch{}return{headerName:`${_.value[v]||q(v,i)}${P}`,field:`p_${r.program_id||r.id}_${v}`,valueFormatter:b,resizable:!0,minWidth:120}});c.push(...m);const y=`${r.program_name||r.nama_program||r.nama||"Program"}`;u.push({headerName:y,children:c})}),W.splice(0,W.length,...u),de(()=>{var c;const r=V.value||((c=H.value)==null?void 0:c.api);if(r)try{r.setColumnDefs(W);try{r.setDatasource&&O.value?r.setDatasource(O.value):r.setRowData(D.value)}catch{try{r.setRowData(D.value)}catch{}}r.setPinnedBottomRowData(X.value);try{r.sizeColumnsToFit()}catch{}setTimeout(()=>{try{ke()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const l={summary_label:"TOTAL"},d=i.reduce((r,c)=>r+Number((c==null?void 0:c.total_transaksi)||0),0);i.forEach(r=>{if(!r)return;const c=`p_${r.program_id||r.id}_nominal`;l[c]=Number(r.total_transaksi||0),f.forEach(m=>{const y=`p_${r.program_id||r.id}_${m}`;l[y]=Number((r==null?void 0:r[m])||0)})}),l.nominal=d;const w=[];w.push({label:"Nominal Keseluruhan Transaksi",value:d});let F=0;f.forEach(r=>{const c=i.reduce((y,v)=>y+Number((v==null?void 0:v[r])||0),0),m=_.value[r]||q(r,i);w.push({label:`Nominal All ${m}`,value:c}),F+=c});const ue=d-F;ue>0&&w.push({label:"Sisa Belum Teralokasi",value:ue}),oe.value=w,D.value=[l],X.value=[],I(!0)}catch(e){console.error(e),R.error("Terjadi kesalahan saat memuat ringkasan program")}finally{E.value=!1}},I=(t=!1)=>{de(()=>{var e;const a=V.value||((e=H.value)==null?void 0:e.api);if(a)try{try{a.purgeInfiniteCache?a.purgeInfiniteCache():a.setDatasource&&O.value?a.setDatasource(O.value):a.setRowData(D.value)}catch{}a.setPinnedBottomRowData(X.value),t&&window.setTimeout(()=>{var n;const o=V.value||((n=H.value)==null?void 0:n.api);if(o)try{o.ensureIndexVisible(0,"top")}catch{}},100)}catch(o){console.error("Error refreshing grid:",o)}})};Fe(async()=>{await be(),await Y(),I()});function ke(){var o;const t=he.value;if(!t)return;const a=t.getAllColumns();if(!a||!a.length)return;const e=a.map(n=>n.getColId());try{t.autoSizeColumns(e,!1)}catch{try{(o=V.value)==null||o.sizeColumnsToFit()}catch{}}}Pe(()=>{M&&clearTimeout(M)});let M=null;Re([A,N,T],()=>{M&&clearTimeout(M),M=setTimeout(async()=>{try{await Y()}catch{}I(!0)},300)});const we=()=>{A.value="",N.value="",T.value=""};return(t,a)=>(h(),Ke(Be,null,{default:Ae(()=>[s("div",ze,[s("div",Ee,[s("h3",Oe,p(ge.value),1),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:ie,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...a[3]||(a[3]=[s("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),Z(" Export Excel ",-1)])])])]),s("div",je,[s("div",He,[s("div",null,[a[4]||(a[4]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),s("div",Le,[j(Ie(Me),{modelValue:A.value,"onUpdate:modelValue":a[0]||(a[0]=e=>A.value=e),config:fe,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])]),s("div",null,[a[5]||(a[5]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Fundraiser",-1)),j(ce,{modelValue:N.value,"onUpdate:modelValue":a[1]||(a[1]=e=>N.value=e),"fetch-url":"/admin/api/karyawan","label-key":"nama","value-key":"id",placeholder:"Pilih Fundraiser","allow-clear":!0,"include-all":!0,"all-label":"Semua Fundraiser",params:{role:"fundraiser"}},null,8,["modelValue"])]),s("div",null,[a[6]||(a[6]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Mitra",-1)),j(ce,{modelValue:T.value,"onUpdate:modelValue":a[2]||(a[2]=e=>T.value=e),"fetch-url":"/admin/api/mitra","label-key":"nama","value-key":"id",placeholder:"Pilih Mitra","allow-clear":!0,"include-all":!0,"all-label":"Semua Mitra"},null,8,["modelValue"])])]),s("div",{class:"mt-4"},[s("button",{onClick:we,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),E.value?(h(),x("div",Ue,[...a[7]||(a[7]=[s("svg",{class:"animate-spin h-5 w-5 text-brand-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-400"},"Memuat data...",-1)])])):B("",!0),E.value?B("",!0):(h(),x("div",Ge,[(h(!0),x(ee,null,ae(oe.value,(e,o)=>(h(),x("div",{key:`summary-${o}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[s("p",We,p(e.label),1),s("p",qe,p(K(e.value)),1)]))),128))])),s("div",Xe,[s("div",{class:"mb-4 flex items-center justify-between"},[a[8]||(a[8]=s("h4",{class:"font-semibold text-gray-800 dark:text-white/90"},"Per-Program Breakdown",-1)),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:pe,class:"h-9 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Refresh"),s("button",{onClick:ie,class:"h-9 rounded-lg bg-green-500 px-3 py-1.5 text-sm text-white hover:bg-green-600"},"Export Excel")])]),s("div",Ye,[(h(!0),x(ee,null,ae(S.value,e=>(h(),x("div",{key:e.program_id,class:"rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("div",Je,[s("div",Qe,[s("h4",Ze,[Z(p(e.program_name||"Program")+" ",1),e.tipe_name?(h(),x("span",ea,"("+p(e.tipe_name)+")",1)):B("",!0)])])]),s("div",aa,[s("table",ta,[a[11]||(a[11]=s("thead",{class:"bg-gray-50 dark:bg-gray-800/30"},[s("tr",null,[s("th",{class:"sticky left-0 z-10 min-w-[200px] border-r border-gray-200 bg-gray-50 px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:border-gray-700 dark:bg-gray-800/30 dark:text-gray-300"},"Pembagian"),s("th",{class:"border-r border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:border-gray-700 dark:text-gray-300"},[s("div",{class:"flex flex-col items-center gap-1"},[s("span",null,"Total")])])])],-1)),s("tbody",ra,[s("tr",sa,[a[9]||(a[9]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Nominal Transaksi",-1)),s("td",oa,p(K((e==null?void 0:e.total_transaksi)||0)),1)]),(h(!0),x(ee,null,ae(C.value,(o,n)=>{var i;return h(),x("tr",{key:`share-row-${e.program_id}-${o}-${n}`,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},[s("td",la,[Z(p(((i=_.value.value)==null?void 0:i[o])||q(o,S.value.value))+" ",1),e!=null&&e.shares_meta&&e.shares_meta[o]&&e.shares_meta[o].type==="percentage"&&e.shares_meta[o].value!==null?(h(),x("span",na,"("+p(re(e.shares_meta[o].value))+")",1)):e!=null&&e.shares_meta&&e.shares_meta[o]&&e.shares_meta[o].type==="nominal"&&e.shares_meta[o].value!==null?(h(),x("span",ia,"("+p(K(e.shares_meta[o].value))+")",1)):B("",!0)]),s("td",ua,p(K((e==null?void 0:e[o])||0)),1)])}),128)),ne(e)>0?(h(),x("tr",da,[a[10]||(a[10]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Sisa Belum Teralokasi",-1)),s("td",ca,p(K(ne(e))),1)])):B("",!0)])])])]))),128))])])]),j(Ve,{isOpen:G.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:ve,onCancel:xe},null,8,["isOpen"])]),_:1}))}});export{ka as default};
