import{d as Ne,H as Te,I as Fe,b as g,M as Pe,A as S,Q as Re,f as Ae,X as Ie,B as $e,g as Ke,o as b,w as Me,a as s,j as L,c as p,i as V,t as x,m as ee,u as Be,F as ae,l as te,V as me}from"./admin-BSPzbDyO.js";import{C as Ve}from"./component-DRhqghT3.js";import{u as re,w as ze}from"./xlsx-3SA47z_C.js";import{_ as Ee}from"./AdminLayout.vue_vue_type_script_setup_true_lang-D3XPLlVU.js";import{_ as je}from"./ConfirmModal.vue_vue_type_script_setup_true_lang-DfXHrTYE.js";import{A as ge}from"./AsyncSearchableSelect-Cbvgjb0H.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Oe={class:"min-h-screen rounded-2xl border border-gray-200 bg-white px-5 py-7 dark:border-gray-800 dark:bg-white/[0.03] xl:px-10 xl:py-12"},He={class:"mb-6 flex items-center justify-between"},Le={class:"font-semibold text-gray-800 text-theme-xl dark:text-white/90 sm:text-2xl"},Ue={class:"mb-6 rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ge={class:"grid grid-cols-1 gap-4 md:grid-cols-3 lg:grid-cols-3"},We={class:"relative"},qe={key:0,class:"mb-6 flex items-center justify-center gap-3 rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-800 dark:bg-white/[0.02]"},Xe={key:1,class:"mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"},Ye={class:"text-xs font-medium text-gray-500 dark:text-gray-400"},Je={class:"mt-2 text-lg font-semibold text-gray-800 dark:text-white"},Qe={class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.03]"},Ze={class:"grid gap-4 md:grid-cols-2 lg:grid-cols-2"},ea={class:"bg-gray-100 dark:bg-gray-800/50 px-4 py-3 border-b border-gray-200 dark:border-gray-700"},aa={class:"flex items-center justify-between"},ta={class:"font-semibold text-gray-800 dark:text-white/90"},ra={key:0,class:"text-sm font-normal text-gray-600 dark:text-gray-400"},sa={class:"overflow-x-auto"},na={class:"w-full"},la={class:"divide-y divide-gray-200 dark:divide-gray-700"},oa={class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},ia={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},ua={class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},da={key:0,class:"text-xs text-gray-500 ml-2"},ca={key:1,class:"text-xs text-gray-500 ml-2"},ma={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},ga={key:0,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},ha={class:"border-r border-gray-200 px-4 py-3 text-center dark:border-gray-700"},Sa=Ne({__name:"Keuangan",setup(ba){const he=Te();Fe();const be=g(String(he.meta.title||"Keuangan")),U=g(null),z=g(null),fe=g(null),I=Pe(),{fetchUser:ye,hasPermission:G,isAdmin:E,user:C}=Re();S(()=>E()||G("create keuangan")),S(()=>E()||G("update keuangan")),S(()=>E()||G("delete keuangan"));const W=g(!1),j=g(null),O=g(!1),se=S(()=>{var i,h,u;const t=Array.isArray((i=C.value)==null?void 0:i.visible_transaksi_ids)?C.value.visible_transaksi_ids:[],a=Array.isArray((h=C.value)==null?void 0:h.visible_donatur_ids)?C.value.visible_donatur_ids:[],e=(u=C.value)!=null&&u.id?[C.value.id]:[],o=[...t.length?t:a,...e];return Array.from(new Set(o.map(n=>String(n))))}),ve=S(()=>{if(E())return"/admin/api/karyawan?per_page=1000";const t="/admin/api/karyawan?per_page=1000&only_assigned=1",a=se.value.length?`&include_ids[]=${se.value.join("&include_ids[]=")}`:"";return`${t}${a}`}),pe={dateFormat:"Y-m-d",altInput:!0,altFormat:"d/m/Y",wrap:!1,mode:"range"},q=[{headerName:"Total Transaksi",field:"total_transaksi",flex:1,valueFormatter:f},{headerName:"Nama Program",children:[{headerName:"DP",field:"dp",valueFormatter:f},{headerName:"Operasional (OPS 1)",field:"ops_1",valueFormatter:f},{headerName:"Gaji Karyawan (OPS 2)",field:"ops_2",valueFormatter:f},{headerName:"Program",field:"program",valueFormatter:f},{headerName:"Fee Mitra",field:"fee_mitra",valueFormatter:f},{headerName:"Bonus",field:"bonus",valueFormatter:f},{headerName:"Championship",field:"championship",valueFormatter:f}]}];function f(t){return t&&t.value!==void 0&&t.value!==null?new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(t.value):""}const $=t=>f({value:t}),ne=t=>{if(t==null)return"";const a=Number(t);return Number.isFinite(a)?Number.isInteger(a)?`${a}%`:`${parseFloat(a.toFixed(2))}%`:`${String(t)}%`};function le(t){switch((t||"").toString()){case"dp":return"DP";case"ops_1":return"OPS 1";case"ops_2":return"OPS 2";case"program":return"Program";case"fee_mitra":return"Fee Mitra";case"bonus":return"Bonus";case"championship":return"Championship";default:return String(t)}}function xe(t){return String(t||"").replace(/^custom_/,"")}function X(t,a){var i,h;const e=xe(t);try{if(_.value&&(_.value[t]||_.value[e]))return _.value[t]||_.value[e]}catch{}const l=le(e);if(l&&l!==String(e))return l;try{for(const u of a||[]){if(!u)continue;const n=((i=u==null?void 0:u.shares_meta)==null?void 0:i[t])||((h=u==null?void 0:u.shares_meta)==null?void 0:h[e]);if(n){if(typeof n=="string")return n;if(n.label||n.name||n.title)return n.label||n.name||n.title}if(u&&u.share_labels&&(u.share_labels[t]||u.share_labels[e]))return u.share_labels[t]||u.share_labels[e]}}catch{}let o=String(e).replace(/_/g," ");return o=o.replace(/\b\w/g,u=>u.toUpperCase()),o}const Y=g([]),N=g([]),T=g([]),_=g({}),oe=g([]),D=g((()=>{const t=["Ahmad Hidayat","Siti Nurhaliza","Budi Santoso","Dewi Lestari","Eko Prasetyo","Fitri Handayani","Guntur Wibowo","Hesti Rahayu","Indra Wijaya","Joko Susilo","Kartika Putri","Lukman Hakim","Maya Sari","Nanda Pratama","Olivia Wijaya"],a=["Kantor Pusat Jakarta","Kantor Cabang Bandung","Kantor Cabang Surabaya","Kantor Cabang Yogyakarta","Kantor Cabang Medan","Kantor Cabang Makassar","Kantor Cabang Semarang","Kantor Cabang Palembang","Kantor Cabang Denpasar","Kantor Cabang Banjarmasin"],e=[],l=new Date("2024-01-01");for(let o=1;o<=200;o++){const i=(o-1)%t.length,h=(o-1)%a.length,u=new Date(l);u.setDate(u.getDate()+(o-1)*2);const n=Math.floor(Math.random()*75e6)+25e6;e.push({id:o.toString(),pic:t[i],jumlah:n,kantorCabang:a[h],tanggalKeuangan:u.toISOString().split("T")[0]})}return e})()),K=g(""),F=g(""),P=g(""),ie=S(()=>D.value);S(()=>ie.value.length===0);const _e=()=>{j.value&&(D.value=D.value.filter(t=>t.id!==j.value),I.success("Data keuangan berhasil dihapus"),W.value=!1,j.value=null,M())},ke=()=>{W.value=!1,j.value=null},ue=t=>{if(!t)return 0;const a=Number(t.total_transaksi||0),e=(T.value||[]).reduce((l,o)=>{const i=Number((t==null?void 0:t[o])||0);return l+(Number.isFinite(i)?i:0)},0);return Math.max(0,a-e)},we=async()=>{try{await J(),M(!0),I.success("Data berhasil diperbarui")}catch{I.error("Gagal memperbarui data")}},de=()=>{const t=["Program","Nominal Transaksi",...T.value.map(n=>_.value[n]||le(n))],a=[];a.push(t),N.value.forEach(n=>{const d=[];d.push((n==null?void 0:n.program_name)||""),d.push(Number((n==null?void 0:n.total_transaksi)||0)),T.value.forEach(w=>{d.push(Number((n==null?void 0:n[w])||0))}),a.push(d)});const e=[];e.push("TOTAL");const l=N.value.reduce((n,d)=>n+Number((d==null?void 0:d.total_transaksi)||0),0);e.push(l),T.value.forEach(n=>{const d=N.value.reduce((w,R)=>w+Number((R==null?void 0:R[n])||0),0);e.push(d)}),a.push(e);const o=re.aoa_to_sheet(a),i=re.book_new();re.book_append_sheet(i,o,"Keuangan");const u=`Keuangan_${new Date().toISOString().split("T")[0]}.xlsx`;ze(i,u)},De=(t,a)=>{if(!a||a.length===0)return t;const e=[...t];return a.forEach(l=>{const{colId:o,sort:i}=l;e.sort((h,u)=>{let n=h[o],d=u[o];return o==="tanggalKeuangan"?(n=new Date(n).getTime(),d=new Date(d).getTime()):o==="jumlah"?(n=n||0,d=d||0):typeof n=="string"&&(n=n.toLowerCase(),d=d.toLowerCase()),n<d?i==="asc"?-1:1:n>d?i==="asc"?1:-1:0})}),e},H=g({getRows:t=>{setTimeout(()=>{const a=t.startRow||0,e=t.endRow||0;let l=ie.value;t.sortModel&&t.sortModel.length>0&&(l=De(l,t.sortModel));const o=l.slice(a,e);let i;l.length===0?i=0:l.length<=e?i=l.length:i=void 0,t.successCallback(o,i)},50)}}),J=async()=>{var t,a;O.value=!0;try{let e="/admin/api/keuangan/program-shares-summary";try{const r=K.value;let c=null,m=null;if(r){if(Array.isArray(r))c=r[0]?r[0]instanceof Date?r[0].toISOString().split("T")[0]:String(r[0]):null,m=r[1]?r[1]instanceof Date?r[1].toISOString().split("T")[0]:String(r[1]):null;else if(typeof r=="string"){const A=r.includes(" to ")?" to ":r.includes(" - ")?" - ":"";if(A){const Q=r.split(A);c=((t=Q[0])==null?void 0:t.trim())||null,m=((a=Q[1])==null?void 0:a.trim())||null}else c=r||null,m=r||null}}const y={};c&&(y.start_date=c),m&&(y.end_date=m),F.value&&(y.fundraiser_id=F.value),P.value&&(y.mitra_id=P.value);const v=new URLSearchParams(y).toString();v&&(e+=`?${v}`)}catch{}const o=await(await fetch(e,{credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"}})).json();if(!o.success){I.error("Gagal memuat ringkasan program");return}const i=o.data.rows||[],h=o.data.columns&&o.data.columns.length?o.data.columns:["dp","ops_1","ops_2","program","fee_mitra","bonus","championship"];N.value=(i||[]).filter(Boolean),T.value=h;const u=[];u.push({headerName:"Ringkasan",field:"summary_label",pinned:"left",width:250}),u.push({headerName:"Nominal Transaksi Keseluruhan",field:"nominal",pinned:"left",width:160,valueFormatter:f,resizable:!0}),_.value=o.data&&o.data.share_type_labels?o.data.share_type_labels:{},i.forEach(r=>{if(!r)return;const c=[];c.push({headerName:"Nominal Transaksi",field:`p_${r.program_id||r.id}_nominal`,valueFormatter:f,resizable:!0,width:160});const m=h.map(v=>{let A="";try{const Z=r.shares_meta||{},k=Z[v]||Z[v.toString()]||null;k&&(k.type==="percentage"&&k.value!==null&&k.value!==void 0?A=` (${ne(k.value)})`:k.type==="nominal"&&k.value!==null&&k.value!==void 0&&(A=` (${new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(k.value)})`))}catch{}return{headerName:`${_.value[v]||X(v,i)}${A}`,field:`p_${r.program_id||r.id}_${v}`,valueFormatter:f,resizable:!0,minWidth:120}});c.push(...m);const y=`${r.program_name||r.nama_program||r.nama||"Program"}`;u.push({headerName:y,children:c})}),q.splice(0,q.length,...u),me(()=>{var c;const r=z.value||((c=U.value)==null?void 0:c.api);if(r)try{r.setColumnDefs(q);try{r.setDatasource&&H.value?r.setDatasource(H.value):r.setRowData(D.value)}catch{try{r.setRowData(D.value)}catch{}}r.setPinnedBottomRowData(Y.value);try{r.sizeColumnsToFit()}catch{}setTimeout(()=>{try{Se()}catch{}},80)}catch(m){console.error("Failed to apply dynamic columns to grid",m)}});const n={summary_label:"TOTAL"},d=i.reduce((r,c)=>r+Number((c==null?void 0:c.total_transaksi)||0),0);i.forEach(r=>{if(!r)return;const c=`p_${r.program_id||r.id}_nominal`;n[c]=Number(r.total_transaksi||0),h.forEach(m=>{const y=`p_${r.program_id||r.id}_${m}`;n[y]=Number((r==null?void 0:r[m])||0)})}),n.nominal=d;const w=[];w.push({label:"Nominal Keseluruhan Transaksi",value:d});let R=0;h.forEach(r=>{const c=i.reduce((y,v)=>y+Number((v==null?void 0:v[r])||0),0),m=_.value[r]||X(r,i);w.push({label:`Nominal All ${m}`,value:c}),R+=c});const ce=d-R;ce>0&&w.push({label:"Sisa Belum Teralokasi",value:ce}),oe.value=w,D.value=[n],Y.value=[],M(!0)}catch(e){console.error(e),I.error("Terjadi kesalahan saat memuat ringkasan program")}finally{O.value=!1}},M=(t=!1)=>{me(()=>{var e;const a=z.value||((e=U.value)==null?void 0:e.api);if(a)try{try{a.purgeInfiniteCache?a.purgeInfiniteCache():a.setDatasource&&H.value?a.setDatasource(H.value):a.setRowData(D.value)}catch{}a.setPinnedBottomRowData(Y.value),t&&window.setTimeout(()=>{var o;const l=z.value||((o=U.value)==null?void 0:o.api);if(l)try{l.ensureIndexVisible(0,"top")}catch{}},100)}catch(l){console.error("Error refreshing grid:",l)}})};Ae(async()=>{await ye(),await J(),M()});function Se(){var l;const t=fe.value;if(!t)return;const a=t.getAllColumns();if(!a||!a.length)return;const e=a.map(o=>o.getColId());try{t.autoSizeColumns(e,!1)}catch{try{(l=z.value)==null||l.sizeColumnsToFit()}catch{}}}Ie(()=>{B&&clearTimeout(B)});let B=null;$e([K,F,P],()=>{B&&clearTimeout(B),B=setTimeout(async()=>{try{await J()}catch{}M(!0)},300)});const Ce=()=>{K.value="",F.value="",P.value=""};return(t,a)=>(b(),Ke(Ee,null,{default:Me(()=>[s("div",Oe,[s("div",He,[s("h3",Le,x(be.value),1),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:de,class:"flex items-center gap-2 rounded-lg bg-green-500 px-4 py-2.5 text-sm font-medium text-white hover:bg-green-600"},[...a[3]||(a[3]=[s("svg",{class:"fill-current",width:"20",height:"20",viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[s("path",{d:"M5 3h10v2H5V3zm0 12h10v2H5v-2zM3 7h14v6H3V7z",fill:"currentColor"})],-1),ee(" Export Excel ",-1)])])])]),s("div",Ue,[s("div",Ge,[s("div",null,[a[4]||(a[4]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Rentang Tanggal Transaksi",-1)),s("div",We,[L(Be(Ve),{modelValue:K.value,"onUpdate:modelValue":a[0]||(a[0]=e=>K.value=e),config:pe,class:"dark:bg-dark-900 h-11 w-full appearance-none rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 pl-4 pr-11 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30 dark:focus:border-brand-800",placeholder:"Pilih rentang tanggal transaksi"},null,8,["modelValue"])])]),s("div",null,[a[5]||(a[5]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Fundraiser",-1)),L(ge,{modelValue:F.value,"onUpdate:modelValue":a[1]||(a[1]=e=>F.value=e),"fetch-url":ve.value,"label-key":"name","value-key":"id",placeholder:"Pilih Fundraiser","allow-clear":!0,"include-all":!0,"all-label":"Semua Fundraiser"},null,8,["modelValue","fetch-url"])]),s("div",null,[a[6]||(a[6]=s("label",{class:"mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400"},"Mitra",-1)),L(ge,{modelValue:P.value,"onUpdate:modelValue":a[2]||(a[2]=e=>P.value=e),"fetch-url":"/admin/api/mitra","label-key":"nama","value-key":"id",placeholder:"Pilih Mitra","allow-clear":!0,"include-all":!0,"all-label":"Semua Mitra"},null,8,["modelValue"])])]),s("div",{class:"mt-4"},[s("button",{onClick:Ce,class:"h-11 rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-medium text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Reset Filter")])]),O.value?(b(),p("div",qe,[...a[7]||(a[7]=[s("svg",{class:"animate-spin h-5 w-5 text-brand-500",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},[s("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),s("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})],-1),s("span",{class:"text-sm font-medium text-gray-700 dark:text-gray-400"},"Memuat data...",-1)])])):V("",!0),O.value?V("",!0):(b(),p("div",Xe,[(b(!0),p(ae,null,te(oe.value,(e,l)=>(b(),p("div",{key:`summary-${l}`,class:"rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-800 dark:bg-white/[0.02]"},[s("p",Ye,x(e.label),1),s("p",Je,x($(e.value)),1)]))),128))])),s("div",Qe,[s("div",{class:"mb-4 flex items-center justify-between"},[a[8]||(a[8]=s("h4",{class:"font-semibold text-gray-800 dark:text-white/90"},"Per-Program Breakdown",-1)),s("div",{class:"flex items-center gap-3"},[s("button",{onClick:we,class:"h-9 rounded-lg border border-gray-300 bg-white px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400"},"Refresh"),s("button",{onClick:de,class:"h-9 rounded-lg bg-green-500 px-3 py-1.5 text-sm text-white hover:bg-green-600"},"Export Excel")])]),s("div",Ze,[(b(!0),p(ae,null,te(N.value,e=>(b(),p("div",{key:e.program_id,class:"rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden"},[s("div",ea,[s("div",aa,[s("h4",ta,[ee(x(e.program_name||"Program")+" ",1),e.tipe_name?(b(),p("span",ra,"("+x(e.tipe_name)+")",1)):V("",!0)])])]),s("div",sa,[s("table",na,[a[11]||(a[11]=s("thead",{class:"bg-gray-50 dark:bg-gray-800/30"},[s("tr",null,[s("th",{class:"sticky left-0 z-10 min-w-[200px] border-r border-gray-200 bg-gray-50 px-4 py-3 text-left text-sm font-semibold text-gray-700 dark:border-gray-700 dark:bg-gray-800/30 dark:text-gray-300"},"Pembagian"),s("th",{class:"border-r border-gray-200 px-4 py-3 text-center text-xs font-semibold text-gray-700 dark:border-gray-700 dark:text-gray-300"},[s("div",{class:"flex flex-col items-center gap-1"},[s("span",null,"Total")])])])],-1)),s("tbody",la,[s("tr",oa,[a[9]||(a[9]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Nominal Transaksi",-1)),s("td",ia,x($((e==null?void 0:e.total_transaksi)||0)),1)]),(b(!0),p(ae,null,te(T.value,(l,o)=>{var i;return b(),p("tr",{key:`share-row-${e.program_id}-${l}-${o}`,class:"hover:bg-gray-50 dark:hover:bg-gray-800/20"},[s("td",ua,[ee(x(((i=_.value.value)==null?void 0:i[l])||X(l,N.value.value))+" ",1),e!=null&&e.shares_meta&&e.shares_meta[l]&&e.shares_meta[l].type==="percentage"&&e.shares_meta[l].value!==null?(b(),p("span",da,"("+x(ne(e.shares_meta[l].value))+")",1)):e!=null&&e.shares_meta&&e.shares_meta[l]&&e.shares_meta[l].type==="nominal"&&e.shares_meta[l].value!==null?(b(),p("span",ca,"("+x($(e.shares_meta[l].value))+")",1)):V("",!0)]),s("td",ma,x($((e==null?void 0:e[l])||0)),1)])}),128)),ue(e)>0?(b(),p("tr",ga,[a[10]||(a[10]=s("td",{class:"sticky left-0 z-10 border-r border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-800 dark:border-gray-700 dark:bg-gray-900 dark:text-white/90"},"Sisa Belum Teralokasi",-1)),s("td",ha,x($(ue(e))),1)])):V("",!0)])])])]))),128))])])]),L(je,{isOpen:W.value,title:"Hapus Keuangan",message:"Apakah Anda yakin ingin menghapus data keuangan ini? Tindakan ini tidak dapat dibatalkan.",confirmText:"Hapus",confirmButtonClass:"bg-red-500 hover:bg-red-600",onConfirm:_e,onCancel:ke},null,8,["isOpen"])]),_:1}))}});export{Sa as default};
